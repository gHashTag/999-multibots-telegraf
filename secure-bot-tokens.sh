#!/bin/bash

echo "=== ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð³Ð¾ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð² Telegram Ð±Ð¾Ñ‚Ð° ==="

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð², ÐµÑÐ»Ð¸ ÐµÐµ Ð½ÐµÑ‚
TOKENS_DIR="/root/.telegram_tokens"
mkdir -p "$TOKENS_DIR"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²
ENV_FILE="$TOKENS_DIR/.env"

# Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½Ñ‹, ÐµÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» ÐµÑ‰Ðµ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
if [ ! -f "$ENV_FILE" ]; then
  echo "ðŸ”‘ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°Ð¼Ð¸..."
  
  # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¸Ð»Ð¸ Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ
  read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚Ð¾ÐºÐµÐ½ Telegram Ð±Ð¾Ñ‚Ð°: " TELEGRAM_BOT_TOKEN
  read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ID Ñ‡Ð°Ñ‚Ð° Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°: " TELEGRAM_ADMIN_CHAT_ID
  read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ID Ñ‡Ð°Ñ‚Ð° Ð´Ð»Ñ Ð¿ÑƒÐ»ÑŒÑÐ° (@neuro_blogger_pulse): " TELEGRAM_PULSE_CHAT_ID
  
  # Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½Ñ‹ Ð² .env Ñ„Ð°Ð¹Ð»
  cat > "$ENV_FILE" << EOF
# Ð¢Ð¾ÐºÐµÐ½Ñ‹ Ð´Ð»Ñ Telegram Ð±Ð¾Ñ‚Ð°
# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾: $(date "+%Y-%m-%d %H:%M:%S")
# ÐÐ• Ð”ÐžÐ‘ÐÐ’Ð›Ð¯Ð™Ð¢Ð• Ð­Ð¢ÐžÐ¢ Ð¤ÐÐ™Ð› Ð’ GIT!

export TELEGRAM_BOT_TOKEN="$TELEGRAM_BOT_TOKEN"
export TELEGRAM_ADMIN_CHAT_ID="$TELEGRAM_ADMIN_CHAT_ID"
export TELEGRAM_PULSE_CHAT_ID="$TELEGRAM_PULSE_CHAT_ID"
EOF

else
  echo "ðŸ”„ Ð¤Ð°Ð¹Ð» Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð² ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð² $ENV_FILE"
fi

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ñ„Ð°Ð¹Ð»Ð° Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°Ð¼Ð¸
chmod 600 "$ENV_FILE"
echo "ðŸ”’ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ñ„Ð°Ð¹Ð»Ð° Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°Ð¼Ð¸"

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð½Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð»Ð¸ .env Ñ„Ð°Ð¹Ð»
update_script() {
  local script_path="$1"
  local script_name=$(basename "$script_path")
  
  echo "ðŸ“ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° $script_name..."
  
  # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÐ¸, Ð³Ð´Ðµ Ñ‚Ð¾ÐºÐµÐ½Ñ‹ Ð¶ÐµÑÑ‚ÐºÐ¾ Ð·Ð°ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹
  sed -i '/TELEGRAM_BOT_TOKEN=/d' "$script_path"
  sed -i '/TELEGRAM_ADMIN_CHAT_ID=/d' "$script_path"
  sed -i '/TELEGRAM_PULSE_CHAT_ID=/d' "$script_path"
  
  # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÑƒ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¸Ð· .env Ñ„Ð°Ð¹Ð»Ð° Ð² Ð½Ð°Ñ‡Ð°Ð»Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð¿Ð¾ÑÐ»Ðµ shebang
  sed -i '2i # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½Ñ‹ Ð¸Ð· Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð³Ð¾ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ð°\nsource /root/.telegram_tokens/.env\n' "$script_path"
}

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹
update_script "/root/test-pulse-messages.sh"
update_script "/root/admin-pulse-notify.sh"
update_script "/root/fix-test-logs.sh"

echo
echo "âœ… Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾! Ð’ÑÐµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽÑ‚ Ñ‚Ð¾ÐºÐµÐ½Ñ‹ Ð¸Ð· Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð³Ð¾ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ð°"
echo "âš ï¸ Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» $ENV_FILE Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð² .gitignore" 