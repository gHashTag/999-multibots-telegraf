#!/bin/sh
set -e

echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¸ Ñ„Ð°Ð¹Ð»Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹..."
pwd
ls -la /app
ls -la /app/dist || echo "Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ dist Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚!"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
mkdir -p /app/logs
mkdir -p /app/dist/utils
mkdir -p /app/dist/helpers/error
mkdir -p /app/dist/interfaces
mkdir -p /app/dist/core/bot
mkdir -p /app/dist/core/supabase

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¼Ð¾Ð´ÑƒÐ»Ñ dotenv Ð¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐµÐ³Ð¾ ÐµÑÐ»Ð¸ Ð½ÐµÑ‚
echo "ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ Ð¼Ð¾Ð´ÑƒÐ»Ñ dotenv..."
if [ ! -d "/app/node_modules/dotenv" ]; then
  echo "âš ï¸ ÐœÐ¾Ð´ÑƒÐ»ÑŒ dotenv Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼..."
  cd /app && npm install dotenv --save
else
  echo "âœ… ÐœÐ¾Ð´ÑƒÐ»ÑŒ dotenv Ð½Ð°Ð¹Ð´ÐµÐ½."
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹
echo "ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ Ð¼Ð¾Ð´ÑƒÐ»Ñ winston..."
if [ ! -d "/app/node_modules/winston" ]; then
  echo "âš ï¸ ÐœÐ¾Ð´ÑƒÐ»ÑŒ winston Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼..."
  cd /app && npm install winston --save
else
  echo "âœ… ÐœÐ¾Ð´ÑƒÐ»ÑŒ winston Ð½Ð°Ð¹Ð´ÐµÐ½."
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
if [ ! -f "/app/.env" ]; then
  echo "âš ï¸ Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ .env Ñ„Ð°Ð¹Ð»..."
  cat > /app/.env << EOF
# Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ .env Ñ„Ð°Ð¹Ð», ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
NODE_ENV=production
DEBUG=true
DOCKER_ENVIRONMENT=true

# Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
LOG_FORMAT=combined
ADMIN_IDS=144022504,1254048880,352374518,1852726961

# Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ ÑÑ‚Ð¸ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ð°Ð¼Ð¸ Ð² docker-compose.yml
BOT_TOKEN_1=dummy_token_1
BOT_TOKEN_2=dummy_token_2
BOT_TOKEN_3=dummy_token_3
BOT_TOKEN_4=dummy_token_4
BOT_TOKEN_5=dummy_token_5
BOT_TOKEN_6=dummy_token_6
BOT_TOKEN_7=dummy_token_7
BOT_TOKEN_8=dummy_token_8

# Ð”Ñ€ÑƒÐ³Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
ORIGIN=https://999-multibots-telegraf-u14194.vm.elestio.app
SECRET_KEY=default_secret_key_replace_in_production
EOF
  echo "âœ… Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ .env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½. ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ðµ Ñ‚Ð¾ÐºÐµÐ½Ñ‹ Ñ‡ÐµÑ€ÐµÐ· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ."
else
  echo "âœ… Ð¤Ð°Ð¹Ð» .env Ð½Ð°Ð¹Ð´ÐµÐ½."
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° bot.js
if [ ! -f "/app/dist/bot.js" ]; then
  echo "âŒ Ð¤Ð°Ð¹Ð» /app/dist/bot.js Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ..."
  cd /app && npm run build
  
  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ½Ð¾Ð²Ð°
  if [ ! -f "/app/dist/bot.js" ]; then
    echo "âŒ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°: ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» bot.js. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ dist:"
    ls -la /app/dist/
    echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ src Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸:"
    ls -la /app/src/
  fi
else
  echo "âœ… Ð¤Ð°Ð¹Ð» /app/dist/bot.js Ð½Ð°Ð¹Ð´ÐµÐ½."
fi

# Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ (Ð±ÐµÐ· Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð¼ÐµÐ½Ð°) Ð´Ð»Ñ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ¸
echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ñ… Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ:"
env | grep -v "TOKEN\|KEY\|SECRET" | cut -d= -f1 | sort

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ node Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
cd /app
ls -la /app/dist
exec "$@" 