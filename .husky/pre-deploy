#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîç Running pre-deploy checks..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üìã Checking environment variables..."
if [ -z "$BOT_TOKEN_1" ] || [ -z "$BOT_TOKEN_2" ] || [ -z "$BOT_TOKEN_3" ] || 
   [ -z "$BOT_TOKEN_4" ] || [ -z "$BOT_TOKEN_5" ] || [ -z "$BOT_TOKEN_6" ] || 
   [ -z "$BOT_TOKEN_7" ] || [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_KEY" ]; then
    echo "‚ùå Error: Missing required environment variables"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏ TypeScript
echo "üî® Checking TypeScript build..."
pnpm build:nocheck
if [ $? -ne 0 ]; then
    echo "‚ùå Error: TypeScript build failed"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–µ—Ä–∞
echo "üßπ Running linter..."
pnpm lint
if [ $? -ne 0 ]; then
    echo "‚ùå Error: Lint check failed"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤
echo "üß™ Running tests..."
pnpm test
if [ $? -ne 0 ]; then
    echo "‚ùå Error: Tests failed"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Dockerfile
echo "üê≥ Validating Dockerfile..."
if ! docker build -t neuro-blogger-bot:test .; then
    echo "‚ùå Error: Docker build failed"
    exit 1
fi

echo "‚úÖ All pre-deploy checks passed!"
exit 0 