#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Ð—Ð°Ñ‰Ð¸Ñ‰ÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ‚ÐºÐ°
protected_branch="main"

echo "[Husky pre-push] ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²ÐµÑ‚ÐºÐ¸ Ð¿ÐµÑ€ÐµÐ´ push..."

# Ð§Ð¸Ñ‚Ð°ÐµÐ¼ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ð¹ Ð²Ð²Ð¾Ð´ Ð¾Ñ‚ Git (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð°Ñ Ð²ÐµÑ‚ÐºÐ°, Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ sha, ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ‚ÐºÐ°, ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ð¹ sha)
while read local_ref local_sha remote_ref remote_sha; do
  # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¸Ð¼Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸
  remote_branch=$(echo "$remote_ref" | sed 's!refs/heads/!!')
  echo "[Husky pre-push] ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° push Ð² ÑƒÐ´Ð°Ð»ÐµÐ½Ð½ÑƒÑŽ Ð²ÐµÑ‚ÐºÑƒ: $remote_branch"

  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÐµÑ‚ Ð»Ð¸ Ñ Ð·Ð°Ñ‰Ð¸Ñ‰ÐµÐ½Ð½Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¾Ð¹
  if [ "$remote_branch" = "$protected_branch" ]; then
    echo "
â›”ï¸â›”ï¸â›”ï¸ ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐŸÑ€ÑÐ¼Ð¾Ð¹ push Ð² Ð²ÐµÑ‚ÐºÑƒ '$protected_branch' Ð—ÐÐŸÐ Ð•Ð©Ð•Ð! â›”ï¸â›”ï¸â›”ï¸
" >&2
    echo "ðŸ’¡ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑÐ¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Pull Request Ð´Ð»Ñ Ð²Ð½ÐµÑÐµÐ½Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð² '$protected_branch'." >&2
    exit 1 # Ð—Ð°Ð¿Ñ€ÐµÑ‰Ð°ÐµÐ¼ push
  fi
done

echo "[Husky pre-push] ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð°. Push Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½."
exit 0 # Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ push 