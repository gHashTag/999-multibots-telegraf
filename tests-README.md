# Тестирование платежной системы в Docker

## Подготовка среды

Для запуска тестов в Docker нужно выполнить следующие шаги:

1. Проверьте, что Docker и Docker Compose установлены и работают:

```bash
npm run check:docker
```

2. Убедитесь, что Docker демон запущен.

## Структура тестового окружения

Тестовое окружение состоит из следующих компонентов:

- **PostgreSQL** - база данных для тестирования
- **Тестовое приложение** - контейнер с приложением для запуска тестов

Настройки тестового окружения определены в файлах:
- `docker-compose.test.yml` - конфигурация Docker Compose для тестов
- `Dockerfile.test` - образ для тестового приложения
- `docker/postgres/init.sql` - SQL-скрипт для инициализации тестовой базы данных

## Запуск тестов

### Полный набор тестов платежной системы

```bash
npm run test:docker
```

### Тесты для Робокассы

```bash
npm run test:robokassa
```

### Запуск отдельных компонентов тестового окружения

1. **Сборка контейнеров**:
```bash
npm run docker:test:build
```

2. **Запуск тестового окружения**:
```bash
npm run docker:test:up
```

3. **Просмотр логов тестового контейнера**:
```bash
npm run docker:test:logs
```

4. **Остановка и удаление тестового окружения**:
```bash
npm run docker:test:down
```

## Логи тестирования

Все логи тестирования сохраняются в директории `logs/`:
- Общие логи тестов в директории `logs/`
- Логи тестов Робокассы в директории `logs/robokassa/`

## Расширение тестов

### Добавление новых тестов

1. Создайте новый тестовый файл в директории `src/test-utils/payment/`
2. Добавьте тесты, следуя формату существующих тестов
3. Обновите файл `src/test-utils/index.ts`, чтобы включить новые тесты

### Настройка переменных окружения для тестов

В файле `docker-compose.test.yml` вы можете настроить переменные окружения для контейнера с тестами:

```yaml
environment:
  - NODE_ENV=test
  - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/testdb
  - LOG_DIR=/tmp/logs
  # Добавьте здесь необходимые переменные
```

## Диагностика проблем

Если тесты завершаются с ошибкой:

1. Проверьте логи тестов в директории `logs/`
2. Убедитесь, что база данных правильно инициализирована
3. Проверьте, что все необходимые переменные окружения настроены
4. Проверьте состояние Docker контейнеров:

```bash
docker ps -a
```

5. Проверьте детальные логи контейнера с тестами:

```bash
docker logs neuro-blogger-telegram-bot-test
```

## Важные примечания

- Тесты используют собственный фреймворк тестирования, а не Jest
- Все тесты должны следовать интерфейсу `TestResult`
- Для логирования используются эмодзи согласно стандартам проекта 