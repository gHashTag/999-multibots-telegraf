#!/bin/bash

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å —ç–º–æ–¥–∑–∏
log() {
  local emoji=$1
  local message=$2
  echo -e "${emoji} ${message}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤–µ–±—Ö—É–∫–æ–≤
check_webhooks() {
  log "üîç" "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–µ–±—Ö—É–∫–æ–≤..."
  
  # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –±–æ—Ç–æ–≤ –∏–∑ .env
  BOT_TOKENS=($(grep -E "BOT_TOKEN_[0-9]+" .env | cut -d '=' -f2))
  
  if [ ${#BOT_TOKENS[@]} -eq 0 ]; then
    log "‚ö†Ô∏è" "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –±–æ—Ç–æ–≤ –∏–∑ .env"
    return 1
  fi
  
  for token in "${BOT_TOKENS[@]}"; do
    if [ -n "$token" ]; then
      log "ü§ñ" "–ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ–±—Ö—É–∫ –¥–ª—è –±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–æ–º ${token:0:5}****"
      curl -s "https://api.telegram.org/bot$token/getWebhookInfo" | grep -v token | jq .
    fi
  done
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é
show_menu() {
  echo -e "\n${BLUE}=== Nginx Helper - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π Nginx ===${NC}"
  echo -e "${YELLOW}1${NC}. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å IP-–∞–¥—Ä–µ—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
  echo -e "${YELLOW}2${NC}. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤–µ–±—Ö—É–∫–æ–≤"
  echo -e "${YELLOW}3${NC}. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx"
  echo -e "${YELLOW}4${NC}. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
  echo -e "${YELLOW}5${NC}. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Å –±–æ—Ç–∞–º–∏"
  echo -e "${YELLOW}6${NC}. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Nginx"
  echo -e "${YELLOW}7${NC}. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–æ—Ç–æ–≤"
  echo -e "${YELLOW}0${NC}. –í—ã—Ö–æ–¥"
  echo -e "\n–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é: "
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
handle_option() {
  local option=$1
  case $option in
    1)
      log "üîé" "–ü—Ä–æ–≤–µ—Ä—è–µ–º IP-–∞–¥—Ä–µ—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
      docker inspect -f '{{.Name}} - {{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' 999-multibots bot-proxy
      ;;
    2)
      check_webhooks
      ;;
    3)
      log "üîÑ" "–û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx..."
      ./update-nginx-config.sh
      ;;
    4)
      log "üîÑ" "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
      ./update-docker.sh
      ;;
    5)
      log "üîé" "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Å –±–æ—Ç–∞–º–∏..."
      docker exec 999-multibots netstat -tulpn | grep LISTEN
      ;;
    6)
      log "üìú" "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ Nginx (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫)..."
      docker logs bot-proxy --tail 20
      ;;
    7)
      log "üìú" "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –±–æ—Ç–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫)..."
      docker logs 999-multibots --tail 20
      ;;
    0)
      log "üëã" "–í—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã"
      exit 0
      ;;
    *)
      log "‚ùå" "–ù–µ–≤–µ—Ä–Ω–∞—è –æ–ø—Ü–∏—è"
      ;;
  esac
}

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –ø—Ä–æ–≥—Ä–∞–º–º—ã
while true; do
  show_menu
  read -p "> " option
  handle_option $option
  echo -e "\n–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
  read
done 