# Руководство по запуску тестов для платежного процессора

## Предварительные требования

1. Node.js 18+
2. Docker и Docker Compose
3. Доступная среда выполнения для тестов

## Способы запуска тестов

### 1. Запуск через скрипт Docker

Самый простой способ запустить все тесты - использовать специальный скрипт:

```bash
# Сделать скрипт исполняемым (если еще не сделано)
chmod +x scripts/docker-test.sh

# Запустить тесты
./scripts/docker-test.sh
```

Скрипт автоматически:
- Остановит процессы, занимающие нужные порты
- Запустит тестовое окружение в Docker
- Выполнит тесты
- Выведет результаты
- Остановит контейнеры

### 2. Запуск вручную (локально)

Для запуска тестов без Docker:

```bash
# Убедитесь, что порты свободны
node scripts/kill-port.js 2999 3001

# Запустить тест обработчика платежей
npm run test:payment-processor
```

### 3. Запуск через Docker Compose

Если вы хотите запустить тестовое окружение вручную:

```bash
# Остановить предыдущие контейнеры
docker-compose -f docker-compose.test.yml down

# Запустить тестовое окружение
docker-compose -f docker-compose.test.yml up --build -d

# Просмотр логов
docker logs -f neuro-blogger-telegram-bot-test
```

## Структура тестов

- `/src/test-utils/tests/paymentProcessor.test.ts` - основной тест платежного процессора
- `/src/test-utils/run-payment-processor-test.ts` - скрипт для запуска теста
- `/src/test-utils/inngest-test-engine.ts` - тестовый движок для эмуляции Inngest

## Важные моменты

1. Тесты используют собственную реализацию, а не Jest или другие фреймворки
2. Тест проверяет основную логику обработки платежей: пополнение и списание
3. Тест создает временного пользователя в базе данных для проверки
4. После выполнения тест автоматически очищает созданные данные

## Устранение неполадок

### Проблема: Порты заняты
Решение: Запустите скрипт для освобождения портов:
```bash
node scripts/kill-port.js 2999 3001
```

### Проблема: Docker контейнер не запускается
Решение: Проверьте логи:
```bash
docker-compose -f docker-compose.test.yml logs
```

### Проблема: Тест не проходит
Решение: Проверьте журналы и внесите необходимые исправления:
```bash
docker logs neuro-blogger-telegram-bot-test
```

## Настраиваемые параметры тестов

Параметры тестового движка можно настроить в файле `src/test-utils/test-config.ts`:

- `eventProcessingTimeout`: 30000 (ms) - время ожидания обработки события
- `eventBufferSize`: 100 - размер буфера событий
- `retries`: 3 - количество повторных попыток