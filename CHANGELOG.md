## 2025-04-14 - Улучшения в системе тестирования

* Улучшен тест NeuroPhoto One: добавлен обход проверки баланса для тестирования
* Добавлен флаг bypass_payment_check в DirectPaymentParams для тестов
* Интерфейсы MySession и generateNeuroPhotoDirect модифицированы для поддержки режима тестирования
* Директория для логов теперь создается автоматически


# CHANGELOG

## [2025-07-15]

### Добавлено
- Реализованы скрипты для запуска тестов GQ-портретов:
  - Добавлен скрипт `test:neurophoto:gq` для запуска одиночных тестов GQ-портретов
  - Добавлен скрипт `test:neurophoto:gq-batch` для пакетного запуска тестов GQ-портретов
  - Интеграция в общую систему тестирования через npm-скрипты
- Улучшены промпты для генерации нейрофото:
  - Добавлено ключевое слово "NEUROCODER" для всех промптов
  - Созданы детализированные и креативные промпты для разных категорий изображений
  - Улучшены описания для получения более качественных результатов
  - Добавлены современные стили и эстетика в промпты
- Исправлены пути импорта в сервисах генерации нейрофото:
  - Заменены относительные пути на абсолютные с использованием '@/'
  - Улучшена совместимость с линтером и системой сборки проекта

### Исправлено
- Исправлены ошибки типизации в тестах NeuroPhotoDirectTester:
  - Добавлены недостающие свойства в объекты-моки
  - Упрощена структура мок-объектов для тестирования
  - Устранены предупреждения линтера

### Преимущества обновления
- Более простой запуск тестов GQ-портретов через npm-скрипты
- Улучшенное качество генерируемых нейрофото благодаря обновленным промптам
- Повышена надежность и читаемость кода благодаря исправлениям типизации
- Упрощена поддержка кода благодаря стандартизированным путям импорта

## [2025-07-14]

### Улучшено
- Усовершенствована система тестирования нейрофото с реальным API:
  - Исправлена интеграция тестов с реальным API в общую систему тестирования
  - Добавлено корректное отображение результатов тестов с общим статусом
  - Обновлена документация в `README.md` с подробными инструкциями по запуску тестов с реальным API
  - Улучшена обработка переменных окружения для гибкой настройки тестов

### Исправлено
- Устранены проблемы с типизацией при запуске тестов:
  - Добавлены корректные типы для Telegram-контекста
  - Исправлены ошибки импорта и линтинга
  - Улучшена интеграция между компонентами тестовой системы

### Преимущества обновления
- Более надежная система тестирования с централизованным управлением результатами
- Улучшенная детализация отчетов о тестировании
- Возможность запуска тестов различными способами (переменные окружения, аргументы командной строки, npm скрипты)
- Повышена надежность тестов с реальным API

## [2025-07-13]

### Добавлено
- Реализован новый тип тестов для генерации нейрофото с использованием реального API:
  - Создан файл `testNeuroPhotoRealAPI.ts` с функциями для тестирования с реальным API
  - Добавлена функция отправки результатов тестирования администратору через Telegram
  - Реализована отправка сгенерированных изображений для визуальной проверки
  - Добавлена подробная техническая информация о выполнении теста
- Обновлен файл `runNeuroPhotoTests.ts` для поддержки тестов с реальным API:
  - Добавлена поддержка флага `REAL_API_TEST` для запуска тестов
  - Реализована интеграция с общей системой тестирования
- Добавлен npm скрипт для запуска тестов с реальным API:
  - `test:neurophoto:real-api` - запуск теста генерации с реальным API
- Обновлена документация по тестированию в `src/test-utils/tests/neuro/README.md`:
  - Подробное описание тестов с реальным API
  - Инструкции по настройке переменных окружения
  - Описание процесса отправки результатов администратору

### Изменено
- Расширена структура тестов нейрофото:
  - Добавлены генераторы креативных промтов для тестирования
  - Улучшена обработка ошибок и логирование результатов
  - Оптимизирована структура тестовых файлов

### Преимущества нового подхода
- Полное end-to-end тестирование - проверка всей цепочки генерации от запроса до получения изображения
- Визуальный контроль качества - администратор получает сгенерированные изображения для оценки
- Мониторинг работоспособности API - возможность быстро обнаружить проблемы с внешними сервисами
- Улучшенная диагностика - подробная техническая информация помогает быстро выявить причины сбоев

## [2025-07-12]

### Добавлено
- Реализована функция `generateNeuroPhotoDirect` для прямой генерации нейрофото без использования Inngest
- Создан класс `NeuroPhotoDirectTester` и тест `testNeuroPhotoDirect` для проверки функциональности
- Интеграция тестов в общую систему тестирования
- Добавлены npm скрипты для запуска тестов прямой генерации: `test:neurophoto:direct` для прямого теста и `test:neurophoto:all` для всех тестов нейрофото
- Обновлена документация тестирования в `src/test-utils/tests/neuro/README.md`

### Изменено
- Обновлен файл `runNeuroPhotoTests.ts` для поддержки тестов прямой генерации
- Добавлены импорты и экспорты для новых тестов в файл `index.ts`

### Преимущества нового подхода
- Устойчивость к сбоям Inngest: продолжение работы без доступности Inngest
- Упрощенное тестирование: возможность тестировать функции без запуска сервера Inngest
- Улучшенная модульность: тестирование отдельных компонентов системы

## [2025-07-13]

### Добавлено
- Новая функциональность для тестирования с реальным API и отправкой результатов администратору
- Добавлена функция `runRealApiTest` в `testNeuroPhotoDirect.ts` для проведения тестов с реальным API
- Создан новый npm скрипт `test:neurophoto:real` для удобного запуска тестов с реальным API
- Добавлена утилитная функция `testWithRealUserAndAdmin` для тестирования и уведомления администратора
- Расширен интерфейс командной строки для запуска тестов с различными параметрами: промпт, количество изображений, язык

### Изменено
- Обновлена документация в `README.md` с описанием новой функциональности и примерами использования
- Улучшено форматирование выводимых сообщений о процессе тестирования
- Добавлена обработка ошибок и уведомления администратора при возникновении проблем

### Преимущества обновления
- Возможность проводить тестирование с реальным API без модификации кода проекта
- Автоматическое уведомление администратора о результатах тестов через Telegram
- Гибкая конфигурация тестов через параметры командной строки
- Улучшенная диагностика и логирование процесса тестирования

## [2023-06-08]

### Added
- Создан класс `TelegrafBotTester` для тестирования ботов Telegram:
  - Реализация в `src/test-utils/testers/TelegrafBotTester.ts`
  - Поддержка симуляции обмена сообщениями с ботом
  - Возможность проверки отправленных ботом сообщений и кнопок
  - Симуляция нажатий на инлайн-кнопки
  - Проверка перехода между сценариями
- Добавлены тесты для аватар-ботов:
  - Базовые тесты взаимодействия в `src/test-utils/tests/bots/avatarBotTest.ts`
  - Тесты отправки изображений аватар-ботом
- Обновлен интерфейс `AvatarBot` с добавлением поддержки URL аватарки
- Добавлен скрипт `run-avatar-bot-tests.sh` для запуска тестов аватар-ботов
- Добавлены команды `test:avatar-bot` и `docker:test:avatar-bot` в package.json

### Changed
- Обновлены константы в файле `test-config.ts` для тестирования аватар-ботов
- Расширена документация по тестированию ботов в `src/test-utils/testers/README.md`

### Fixed
- Исправлены ошибки типизации в `createMockAvatarBot`
- Удалены неиспользуемые импорты

## [2023-06-07]

### Changed
- Улучшена структура тестов:
  - Перемещены все скрипты запуска тестов платежей в директорию `src/test-utils/payment/`
  - Обновлены bash-скрипты для использования новых путей
  - Обновлены команды в package.json для запуска тестов из новых локаций
- Обновлена документация в `docs/TESTING.md` с учетом новой структуры

### Added
- Добавлен новый скрипт `run-simple-receipt-test.sh` для запуска теста простой генерации чека
- Добавлена новая команда `simple-receipt-test` в package.json

## [2023-06-06]

### Added
- Добавлены тесты для функции createSuccessfulPayment:
  - Тест успешного создания платежа
  - Тест обработки дублирующихся платежей с одинаковым inv_id
  - Тест обработки платежей для несуществующих пользователей
  - Тест проверки существования платежа по inv_id
- Тесты для платежных чеков с возможностью запуска через bash-скрипты
- Скрипт `run-receipt-tests.sh` для запуска тестов платежных чеков
- Скрипт `run-payment-tests.sh` для запуска всех тестов платежной системы
- Новый тест `simpleReceiptTest.ts` для простой проверки генерации чеков

### Fixed
- Улучшена функция createSuccessfulPayment:
  - Добавлена проверка на существующий inv_id для предотвращения дублирования платежей
  - Добавлено возвращение существующего платежа вместо создания дубликата
- Переписаны тесты для использования собственной системы моков вместо Jest
- Исправлены имена функций и импорты в тестах платежных чеков

### Changed
- Обновлена документация по платежной системе
- Улучшен пользовательский интерфейс выбора модели
- Добавлены эмодзи-индикаторы для платных моделей
- Расширены тестовые сценарии для платежной системы
- Обновлена документация по тестированию в `docs/TESTING.md`
- Добавлены новые скрипты в package.json для запуска разных типов тестов

## [2023-06-05]

### Added
- Интеграция с платежной системой для SelectModelWizard
- Поддержка платных моделей с визуальной маркировкой
- Система подтверждения выбора платной модели
- Тесты для платежной интеграции с SelectModelWizard

### Fixed
- Улучшена обработка ошибок при недостаточном балансе
- Исправлена типизация платежных параметров

### Changed
- Обновлена документация по платежной системе
- Улучшен пользовательский интерфейс выбора модели
- Добавлены эмодзи-индикаторы для платных моделей
- Расширены тестовые сценарии для платежной системы

## [2023-04-10]

### Added
- Initial commit
- Basic telegram bot functionality
- Base payment structure

## [Unreleased]

### Added
- Создан утилитарный модуль `createMockFn` для тестирования:
  - Реализован в `src/test-utils/mocks/mockFn.ts`
  - Полная поддержка API аналогично Jest.fn() (mockReturnValue, mockResolvedValue, mockRejectedValue, mockImplementation)
  - Отслеживание вызовов функции и их аргументов
  - Типизация для улучшения опыта разработки
  - Поддержка сброса состояния мока (mockReset, mockClear)
- Добавлен тест для проверки функциональности `createMockFn` в `src/test-utils/tests/mockFnTest.ts`
- Добавлена команда `test:mock` в package.json для прямого запуска тестов мок-функций
- Обновлен `src/test-utils/index.ts` для поддержки параметра `--test=mockFnTest`
- Интеграция с существующей системой тестирования через `src/test-utils/tests/system/index.ts`

### Fixed
- Исправлен расчет баланса пользователя: теперь функция `get_user_balance` использует тот же алгоритм, что и `get_user_balance_stats`, включая учет системных транзакций. Это устраняет несоответствие между отображаемыми значениями баланса в разных частях приложения.
- Исправлена ошибка линтера в `src/test-utils/tests/payment/paymentProcessorMockTest.ts` - удален неиспользуемый импорт `inngestTestEngine`.

### Added
- Добавлена документация по конфигурации Nginx:
  - Создан файл `docs/NGINX-CONFIG.md` с подробным описанием структуры конфигурации Nginx в проекте
  - Добавлен раздел о конфигурации Nginx в `README.md`
  - Добавлено описание всех используемых файлов конфигурации и их назначения для разных сред (разработка, тестирование, продакшн)

## [2023-06-09]

### Added
- Обновлен функционал отправки медиа в канал @neuro_blogger_pulse:
  - Добавлена новая функция `sendMediaToPulse` в `src/helpers/pulse.ts` с поддержкой различных типов медиа (фото, видео, аудио, документы)
  - Созданы тесты для функции `sendMediaToPulse` в `src/test-utils/tests/pulse/pulseMediaTest.ts`
  - Добавлены тесты интеграции с Inngest-функциями в `src/test-utils/tests/pulse/pulseIntegrationTest.ts`
  - Добавлены скрипты для запуска тестов: `scripts/run-pulse-tests.sh`
  - Добавлены соответствующие команды в package.json: `test:pulse` и `pulse-tests`

### Changed
- Обновлены Inngest-функции для использования новой функции `sendMediaToPulse`:
  - Обновлен `src/inngest-functions/neuroImageGeneration.ts`
  - Обновлен `src/inngest-functions/textToImage.inngest.ts`
  - `src/inngest-functions/textToVideo.inngest.ts` уже использовал новую функцию

### Fixed
- Оптимизирована обработка ошибок при отправке медиа
- Улучшена типизация параметров для функции отправки медиа
- Добавлены дополнительные проверки при формировании caption для отправляемых медиа 

## [2025-07-10]

### Добавлено
- Расширенный набор тестов для GQ-портретов:
  - Тест для бизнес-портретов в стиле GQ
  - Тест для модных портретов в стиле GQ/Vogue
  - Пакетный запуск всех типов GQ-портретов
- Поддержка тестового режима для всех тестов GQ-портретов
- Подробная документация по структуре промптов для GQ-портретов
- Обновленная дорожная карта с новыми тестами
- Обновленные npm-скрипты для запуска тестов

### Изменено
- Улучшена структура тестовых файлов
- Добавлены задержки между тестами для более стабильной работы
- Исправлены ошибки при работе в тестовом режиме без вызова реального API 

## [2025-04-14]

### Исправлено
- Улучшена обработка ответов API в функции `generateNeuroPhotoDirect`:
  - Добавлена корректная обработка случая, когда API возвращает успешный статус, но пустой массив URL
  - Изменено поведение функции: теперь при отсутствии URL изображений возвращается ошибка `success: false` вместо попытки поиска локальных файлов
- Обновлен тест `tests/neuro/neuro-photo-one/index.ts`:
  - Добавлена специальная обработка случая, когда API не возвращает URL изображений
  - Реализован механизм поиска и отправки локально сохраненных файлов в тестовую группу
  - Улучшена диагностика и логирование тестовых сценариев
- Добавлена документация:
  - Создан файл `src/services/generateNeuroPhotoDirectREADME.md` с подробным описанием функции
  - Обновлен README для тестового модуля с информацией об особенностях работы API и обработке локальных файлов

### Добавлено
- Новый отладочный скрипт `src/services/debugApiResponse.ts` для тестирования обработки различных форматов ответов API
- Улучшенное логирование в тестах с сохранением ответов API в JSON-файлы для последующего анализа

### Технические изменения
- Исправлены ошибки типизации в функции `generateNeuroPhotoDirect`
- Улучшена обработка ошибок и логирование

## [2025-04-13]

// ... existing code ... * Исправлен импорт isDev в bot.ts для соответствия новой структуре проекта

