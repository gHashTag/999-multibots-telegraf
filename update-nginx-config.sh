#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è IP-–∞–¥—Ä–µ—Å–æ–≤ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

# –ü–æ–ª—É—á–∞–µ–º IP-–∞–¥—Ä–µ—Å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –±–æ—Ç–∞–º–∏
APP_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' 999-multibots)

if [ -z "$APP_IP" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å IP-–∞–¥—Ä–µ—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 999-multibots"
  exit 1
fi

echo "‚úÖ IP-–∞–¥—Ä–µ—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 999-multibots: $APP_IP"

# –ü—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx
NGINX_CONFIG_PATH="/opt/app/999-multibots-telegraf/nginx-config/default.conf"

if [ ! -f "$NGINX_CONFIG_PATH" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ $NGINX_CONFIG_PATH –Ω–µ –Ω–∞–π–¥–µ–Ω"
  exit 1
fi

# –û–±–Ω–æ–≤–ª—è–µ–º IP-–∞–¥—Ä–µ—Å –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º IP-–∞–¥—Ä–µ—Å –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
sed -i "s|http://[0-9]\+\.[0-9]\+\.[0-9]\+\.[0-9]\+:|http://$APP_IP:|g" $NGINX_CONFIG_PATH

echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Nginx
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Nginx..."
docker restart bot-proxy

echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ Nginx –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω."
echo "üìù –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –≤–µ–±—Ö—É–∫–æ–≤:"
echo "   curl -s https://api.telegram.org/bot\$BOT_TOKEN/getWebhookInfo" 