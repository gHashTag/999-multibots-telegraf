# Тестирование вебхуков Robokassa

Этот документ описывает процесс тестирования вебхуков Robokassa для проверки корректности работы интеграции платежной системы с нашим приложением.

## Обзор

Robokassa отправляет уведомления о платежах на указанный нами URL (ResultURL). Наш обработчик должен корректно проверять подпись, обрабатывать платежи и отвечать в формате, ожидаемом Robokassa.

Для тестирования мы используем скрипт, который эмулирует запросы от Robokassa и проверяет ответы сервера.

## Скрипт для тестирования

Скрипт находится в файле `__tests__/robokassa-webhook-test.js` и позволяет отправлять различные тестовые запросы на endpoint обработки платежей.

### Функциональность скрипта

Скрипт выполняет следующие тесты:

1. **Валидный запрос** - отправляет корректно сформированный запрос с правильной подписью
2. **Запрос без подписи** - проверяет обработку запроса без подписи (SignatureValue)
3. **Запрос с неверной подписью** - проверяет отклонение запроса с некорректной подписью
4. **Запрос без обязательных параметров** - проверяет обработку запроса без InvId

### Настройка скрипта

Перед запуском скрипта может потребоваться настройка параметров:

```javascript
const config = {
  // URL вашего вебхука
  webhookUrl:
    'https://999-multibots-telegraf-u14194.vm.elestio.app/payment-success',
  // Тестовые данные платежа
  testData: {
    OutSum: '1110.00', // Сумма платежа
    InvId: Math.floor(Math.random() * 1000000).toString(), // Случайный ID инвойса
    SignatureValue: '', // Будет заполнено автоматически
    shp_botname: 'neuro_blogger_bot', // Дополнительный параметр с именем бота
  },
  // Тестовый пароль №2 для проверки подписи
  password2: process.env.ROBOKASSA_PASSWORD_2 || 'test_password_2',
  // Задержка между запросами (мс)
  delay: 3000,
}
```

## Запуск тестирования

Для запуска тестов необходимо выполнить следующие шаги:

1. Убедитесь, что переменная окружения `ROBOKASSA_PASSWORD_2` установлена, или укажите ее в скрипте.
2. Запустите скрипт:

```bash
node __tests__/robokassa-webhook-test.js
```

## Интерпретация результатов

После запуска скрипт будет последовательно отправлять запросы и выводить результаты:

- ✅ **ТЕСТ ПРОЙДЕН** - означает, что сервер ответил корректно (статус 200 и ответ в формате `OK{InvId}`)
- ❌ **ТЕСТ НЕ ПРОЙДЕН** - означает, что сервер ответил не так, как ожидалось
- ❌ **ОШИБКА** - означает, что произошла ошибка при выполнении запроса

### Ожидаемые результаты

1. **Валидный запрос**: должен получить ответ 200 OK с текстом `OK{InvId}`
2. **Запрос без подписи**: должен получить ответ 400 Bad Request
3. **Запрос с неверной подписью**: должен получить ответ 400 Bad Request
4. **Запрос без обязательных параметров**: должен получить ответ 400 Bad Request

## Расшифровка типичных проблем

| Проблема                                  | Возможная причина                        | Решение                                                |
| ----------------------------------------- | ---------------------------------------- | ------------------------------------------------------ |
| Сервер не отвечает                        | Неправильный URL или сервер не запущен   | Проверьте URL и убедитесь, что сервер запущен          |
| Все тесты не проходят                     | Неправильный пароль для проверки подписи | Убедитесь, что ROBOKASSA_PASSWORD_2 настроен правильно |
| Ответ сервера не соответствует ожидаемому | Ошибка в обработчике Robokassa           | Проверьте логи сервера для выявления проблемы          |

## Проверка на реальном сервере

После локального тестирования рекомендуется провести тестирование на реальном сервере:

1. Убедитесь, что `webhookUrl` указывает на рабочий сервер
2. Запустите скрипт через SSH на сервере:

```bash
# Подключаемся к серверу
ssh -i ~/.ssh/id_rsa root@999-multibots-u14194.vm.elestio.app

# Переходим в директорию проекта
cd /opt/app/999-multibots-telegraf

# Запускаем тест
ROBOKASSA_PASSWORD_2=ваш_пароль node __tests__/robokassa-webhook-test.js
```

## Проверка обработки платежей

После успешного тестирования вебхука, рекомендуется проверить полный цикл обработки платежа:

1. Создайте тестовый платеж через интерфейс бота
2. Проверьте, что платеж сохранен в базе данных со статусом PENDING
3. Эмулируйте успешный запрос от Robokassa с реальными данными этого платежа
4. Проверьте, что статус платежа обновился на COMPLETED
5. Проверьте, что баланс пользователя обновился
6. Проверьте, что уведомление было отправлено пользователю

## Возможные расширения скрипта

Скрипт можно расширить для более детального тестирования:

- Добавить тестирование различных типов платежей (пополнение баланса, покупка подписки)
- Добавить интеграцию с базой данных для проверки изменений в данных
- Добавить автоматическую генерацию тестового платежа перед проверкой уведомления
