# Процесс принятия оплаты через Telegram-бот

## Обзор

Этот документ описывает процесс создания и отправки счета для оплаты подписки через Telegram-бот. Логика реализована в файле `src/scenes/getRuBillWizard/index.ts`. Ниже приведены ключевые шаги и детали работы кода.

## Шаги процесса оплаты

1. **Инициализация сцены `getRuBillWizard`**

   - Сцена `getRuBillWizard` создается как `WizardScene` из библиотеки `telegraf/scenes`.
   - Она состоит из одного шага `generateInvoiceStep`, который обрабатывает создание счета.

2. **Получение данных о подписке**

   - Функция `generateInvoiceStep` получает данные о выбранной подписке из сессии пользователя (`ctx.session.selectedPayment`).
   - Определяется сумма платежа и количество звезд в зависимости от типа подписки:
     - Для `neurophoto` (НейроФото): сумма = 1110 рублей, звезды = 476.
     - Для `neurobase` (НейроБаза): сумма = 2999 рублей, звезды = 1303.

3. **Генерация уникального ID счета**

   - Генерируется случайный идентификатор счета (`invId`) с помощью `Math.floor(Math.random() * 1000000)`.

4. **Создание ссылки на оплату**

   - Вызывается функция `getInvoiceId` из модуля `helper`, которая формирует URL для оплаты через Robokassa.
   - Параметры для создания ссылки включают:
     - `merchantLogin` - логин мерчанта.
     - `amount` - сумма платежа.
     - `invId` - идентификатор счета.
     - `description` - описание платежа.
     - `password1` - пароль для подписи запроса.

5. **Сохранение данных о платеже в Supabase**

   - Вызывается функция `setPayments` для сохранения информации о платеже со статусом `PENDING`.
   - Сохраняются данные, такие как:
     - `telegram_id` - ID пользователя в Telegram.
     - `OutSum` - сумма платежа.
     - `InvId` - идентификатор счета.
     - `currency` - валюта (RUB).
     - `stars` - количество звезд.
     - `status` - статус платежа (PENDING).
     - `payment_method` - метод оплаты (Telegram).
     - `subscription` - тип подписки.
     - `bot_name` - имя бота.
     - `language` - язык пользователя.

6. **Отправка сообщения пользователю**

   - Формируется сообщение с информацией о созданном счете.
   - Создается inline-клавиатура с кнопкой, содержащей ссылку на оплату (`url: invoiceURL`).
   - Текст кнопки включает название подписки и сумму (например, "Оплатить НейроФото за 1110 р.").
   - Сообщение отправляется пользователю с форматированием HTML и инструкцией по оплате, а также контактом для поддержки в случае проблем (`@neuro_sage`).

7. **Завершение сцены**

   - После отправки сообщения сцена завершается вызовом `ctx.scene.leave()`.

8. **Обработка ошибок**
   - В случае ошибки при создании счета или сохранении данных пользователю отправляется сообщение об ошибке на соответствующем языке (русском или английском).

## Критические моменты

- **Корректность суммы**: Важно, чтобы суммы для подписок были заданы правильно (1110 рублей для НейроФото и 2999 рублей для НейроБаза).
- **Безопасность данных**: Данные для оплаты (например, `password1`) должны быть защищены и не отображаться в логах в открытом виде.
- **Сохранение платежа**: Сохранение данных в Supabase со статусом `PENDING` необходимо для отслеживания статуса платежа.
- **Пользовательский опыт**: Сообщение с кнопкой оплаты должно быть понятным и содержать прямую ссылку на оплату, чтобы минимизировать действия пользователя. 