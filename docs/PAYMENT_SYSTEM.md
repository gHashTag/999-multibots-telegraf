# –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø –ü–û –°–ò–°–¢–ï–ú–ï –û–ü–õ–ê–¢–´ - –ù–ï –ò–ó–ú–ï–ù–Ø–¢–¨! üö´

## –û—Å–Ω–æ–≤–Ω—ã–µ SQL —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–ª–∞–Ω—Å–æ–º

### 1. get_user_balance - –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –†–ê–°–ß–ï–¢–ê –ë–ê–õ–ê–ù–°–ê! ‚ö†Ô∏è

```sql
CREATE OR REPLACE FUNCTION public.get_user_balance(user_telegram_id text)
 RETURNS numeric
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_balance numeric := 0;
    v_user_id bigint;
BEGIN
    -- –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º telegram_id –≤ —á–∏—Å–ª–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç
    BEGIN
        v_user_id := user_telegram_id::bigint;
    EXCEPTION WHEN OTHERS THEN
        RETURN 0;
    END;

    -- –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—É –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    -- –û–±–Ω–æ–≤–ª–µ–Ω–æ: —Ä–∞—Å—á–µ—Ç —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –≤–∫–ª—é—á–∞—è —Å–∏—Å—Ç–µ–º–Ω—ã–µ
    SELECT COALESCE(SUM(
        CASE WHEN p.status = 'COMPLETED' THEN 
            CASE 
                WHEN p.type = 'money_income' OR p.type = 'system' THEN COALESCE(p.stars, 0)
                WHEN p.type = 'money_expense' THEN -COALESCE(p.stars, 0)
                ELSE 0
            END
        ELSE 0 END
    ), 0) INTO v_balance
    FROM payments_v2 p
    WHERE p.telegram_id = v_user_id;

    RETURN v_balance;
END;
$function$
```

## –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π

1. **–ù–ò–ö–û–ì–î–ê** –Ω–µ –∏–∑–º–µ–Ω—è–π—Ç–µ SQL-—Ñ—É–Ω–∫—Ü–∏—é `get_user_balance` –±–µ–∑ —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
2. **–ù–ò–ö–û–ì–î–ê** –Ω–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–µ–π —Å `payment_method='system'`
3. **–í–°–ï–ì–î–ê** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –æ –ø–ª–∞—Ç–µ–∂–µ –≤ `payments_v2` –Ω–∞ –æ–¥–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
4. **–í–°–ï–ì–î–ê** –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ `operation_id` –∏–ª–∏ `inv_id`

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã

1. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞**:
   - –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª: `/src/inngest-functions/paymentProcessor.ts` 
   - –ú–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –æ –ø–ª–∞—Ç–µ–∂–µ: `updateUserBalance`
   

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞**:
   - –ë–∞–ª–∞–Ω—Å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ `payments_v2`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQL-—Ñ—É–Ω–∫—Ü–∏—è `get_user_balance` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
   - –ù–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –ø–æ–ª–µ –±–∞–ª–∞–Ω—Å–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ `users`

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞**:
   - –ß–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é `/src/core/supabase/getUserBalance.ts`
   - –í–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SQL-—Ñ—É–Ω–∫—Ü–∏—é `get_user_balance`

## –¢–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

1. **money_income** - –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
2. **money_expense** - —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
3. **system** - —Å–∏—Å—Ç–µ–º–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)

## –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

- **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**: –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏ –ø–æ `operation_id` –∏–ª–∏ `inv_id`
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SQL-—Ñ—É–Ω–∫—Ü–∏—é `get_user_balance`
- **–î–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤—ã–∑–æ–≤–æ–≤ `updateUserBalance` –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞

## –í–ê–ñ–ù–û! 

–ü—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —Å–∏—Å—Ç–µ–º–µ –æ–ø–ª–∞—Ç—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —ç—Ç—É –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ –ø—Ä–æ–≤–æ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: 21.06.2024
