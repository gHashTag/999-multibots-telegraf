# –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–µ–∫—Ç–∞ NeuroBlogger. –í –¥–∞–Ω–Ω–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ –æ–ø–∏—Å–∞–Ω—ã –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã —Ä–∞–±–æ—Ç—ã —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏, –±–∞–ª–∞–Ω—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–ø–ª–∞—Ç–µ–∂–Ω–æ–π-—Å–∏—Å—Ç–µ–º—ã)
2. [–¢–∏–ø–∏–∑–∞—Ü–∏—è –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã](#—Ç–∏–ø–∏–∑–∞—Ü–∏—è-–∏-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã)
3. [–ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π](#–ø—Ä–æ—Ü–µ—Å—Å-–æ–±—Ä–∞–±–æ—Ç–∫–∏-–ø–ª–∞—Ç–µ–∂–µ–π)
4. [–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö](#—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è-–æ-–ø–ª–∞—Ç–µ–∂–∞—Ö)
5. [–•—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Ä–∞—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞](#—Ö—Ä–∞–Ω–µ–Ω–∏–µ-–∏-—Ä–∞—Å—á–µ—Ç-–±–∞–ª–∞–Ω—Å–∞)
6. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ-–ø–ª–∞—Ç–µ–∂–Ω–æ–π-—Å–∏—Å—Ç–µ–º—ã)
7. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
8. [–í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ](#–≤–æ–∑–º–æ–∂–Ω—ã–µ-–æ—à–∏–±–∫–∏-–∏-–∏—Ö-—Ä–µ—à–µ–Ω–∏–µ)

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –ø–ª–∞—Ç–µ–∂–µ–π, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ Inngest-—Ñ—É–Ω–∫—Ü–∏–∏.

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

1. **–ü–ª–∞—Ç–µ–∂–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä** (`src/inngest-functions/paymentProcessor.ts`) - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π.
2. **–†–∞—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞** (`src/core/supabase/getUserBalance.ts`) - —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞ –±–∞–ª–∞–Ω—Å–∞.
3. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π** (`src/core/supabase/createSuccessfulPayment.ts`) - —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –æ –ø–ª–∞—Ç–µ–∂–∞—Ö.
4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** (`src/helpers/sendTransactionNotification.ts`) - —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–ª–∞—Ç–µ–∂–∞—Ö.

### –î–∏–∞–≥—Ä–∞–º–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–ª–∞—Ç–µ–∂–∞:

```
[–°–µ—Ä–≤–∏—Å/–ë–æ—Ç] --> [Inngest Event] --> [–ü–ª–∞—Ç–µ–∂–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä] --> [–ó–∞–ø–∏—Å—å –≤ –ë–î + –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ]
```

## –¢–∏–ø–∏–∑–∞—Ü–∏—è –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

```typescript
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞ (PaymentProcessParams)
interface PaymentProcessParams {
  telegram_id: string;        // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
  amount: number;             // –°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–í–°–ï–ì–î–ê –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ)
  stars?: number;             // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥ (–í–°–ï–ì–î–ê –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ)
  type: TransactionType;      // –¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (MONEY_INCOME, MONEY_EXPENSE, etc.)
  description: string;        // –û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  bot_name: string;           // –ù–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞, –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–≤—à–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
  inv_id?: string;            // ID –∏–Ω–≤–æ–π—Å–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
  metadata?: Record<string, any>; // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  service_type: ModeEnum;     // –¢–∏–ø —Å–µ—Ä–≤–∏—Å–∞
}

// –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞ (PaymentProcessResult)
interface PaymentProcessResult {
  success: boolean;           // –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏
  payment: {                  // –î–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
    payment_id: number;
    telegram_id: string;
    amount: number;
    stars: number;
    type: string;
    status: string;
    [key: string]: any;
  };
  balanceChange: {            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞
    before: number;           // –ë–∞–ª–∞–Ω—Å –¥–æ –æ–ø–µ—Ä–∞—Ü–∏–∏
    after: number;            // –ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    difference: number;       // –†–∞–∑–Ω–∏—Ü–∞ –≤ –±–∞–ª–∞–Ω—Å–µ
  };
  error?: string;             // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
}

// –¢–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
enum TransactionType {
  MONEY_INCOME = 'money_income',           // –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
  MONEY_EXPENSE = 'money_expense',         // –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤
  SUBSCRIPTION_PAYMENT = 'subscription_payment', // –û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏
  SUBSCRIPTION_PURCHASE = 'subscription_purchase', // –ü–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
  SUBSCRIPTION_RENEWAL = 'subscription_renewal',  // –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
  REFUND = 'refund',                       // –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
  BONUS = 'bonus',                         // –ë–æ–Ω—É—Å–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
  REFERRAL = 'referral',                   // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
  TRANSFER = 'transfer',                   // –ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤
  SYSTEM = 'system',                       // –°–∏—Å—Ç–µ–º–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
}
```

## –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π

### –®–∞–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞:

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤** - –ø–ª–∞—Ç–µ–∂–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Å—É–º–º—ã –∏ –¥—Ä—É–≥–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞** - –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤.
4. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –ø–ª–∞—Ç–µ–∂–µ** - –∑–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
5. **–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –±–∞–ª–∞–Ω—Å–∞** - —Å–±—Ä–æ—Å –∫—ç—à–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞.
6. **–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

### –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:

- –°—É–º–º—ã `amount` –∏ `stars` **–í–°–ï–ì–î–ê** –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏
- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è **–¢–û–õ–¨–ö–û** —Ç–∏–ø–æ–º (`MONEY_INCOME`/`MONEY_EXPENSE`), –∞ –Ω–µ –∑–Ω–∞–∫–æ–º —Å—É–º–º—ã
- –ö–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ (`üí∞`, `‚≠êÔ∏è`, `üì®`, etc.)
- –ü–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å –±–∞–ª–∞–Ω—Å–∞
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤–æ–π —Å—Ä–µ–¥—ã, –Ω–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é `sendTransactionNotification`, –∫–æ—Ç–æ—Ä–∞—è:

1. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –Ω—É–∂–Ω–æ–º—É –±–æ—Ç—É —á–µ—Ä–µ–∑ `createBotByName`
2. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ:
   - ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   - –°—É–º–º–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
   - –°—Ç–∞—Ä–æ–º –±–∞–ª–∞–Ω—Å–µ
   - –ù–æ–≤–æ–º –±–∞–ª–∞–Ω—Å–µ
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
4. –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏

–ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
```
ID: f7c5e8d9-1234-5678-9abc-def012345678
–°—É–º–º–∞: 50 ‚≠êÔ∏è
–°—Ç–∞—Ä—ã–π –±–∞–ª–∞–Ω—Å: 100 ‚≠êÔ∏è
–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: 150 ‚≠êÔ∏è
```

## –•—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Ä–∞—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞

–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ `payments_v2` —Å –ø–æ–º–æ—â—å—é SQL-—Ñ—É–Ω–∫—Ü–∏–∏ `get_user_balance`:

```sql
CREATE OR REPLACE FUNCTION public.get_user_balance(user_telegram_id text)
RETURNS numeric
LANGUAGE plpgsql
AS $function$
DECLARE
v_balance numeric := 0;
v_user_id bigint;
BEGIN
  -- Convert telegram_id to numeric format
  BEGIN
    v_user_id := user_telegram_id::bigint;
  EXCEPTION WHEN OTHERS THEN
    RETURN 0;
  END;

  -- Get sum of all transactions for the user
  SELECT COALESCE(SUM(
    CASE WHEN p.status = 'COMPLETED' THEN
      CASE
        WHEN p.type = 'money_income' THEN COALESCE(p.stars, 0)
        WHEN p.type = 'money_expense' THEN -COALESCE(ABS(p.stars), 0)
        ELSE 0
      END
    ELSE 0 END
  ), 0) INTO v_balance
  FROM payments_v2 p
  WHERE p.telegram_id = v_user_id
  AND p.payment_method != 'system';

  RETURN v_balance;
END;
$function$
```

–î–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —Å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:

### –¢–µ—Å—Ç—ã –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞

1. **`testPaymentNotification`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–ª–∞—Ç–µ–∂–∞—Ö
2. **`testBalanceTopUp`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
3. **`testBalanceDebit`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤
4. **`testInsufficientBalance`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º –±–∞–ª–∞–Ω—Å–µ
5. **`testRealPaymentNotification`** - –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –º–æ–∫-–æ–±—ä–µ–∫—Ç–∞–º–∏

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
npm run test:payment

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
npm run test:payment-processor

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–ª–∞—Ç–µ–∂–∞—Ö
npm run test:payment-notification
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

–¢–µ—Å—Ç—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `src/test-utils/tests/payment/` –∏ —Å–ª–µ–¥—É—é—Ç –æ–±—â–µ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É:

1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–æ–∫–æ–≤ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
3. –ò–º–∏—Ç–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–ª–∞–Ω—Å–æ–º
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
5. –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞

```typescript
import { inngest } from '@/inngest-functions/clients'
import { TransactionType } from '@/interfaces/payments.interface'
import { ModeEnum } from '@/price/helpers/modelsCost'

// –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
await inngest.send({
  name: 'payment/process',
  data: {
    telegram_id: userId,
    amount: 100, // –í–°–ï–ì–î–ê –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ
    type: TransactionType.MONEY_INCOME,
    description: '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞',
    bot_name: botName,
    service_type: ModeEnum.TopUpBalance
  }
})

// –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤
await inngest.send({
  name: 'payment/process',
  data: {
    telegram_id: userId,
    amount: 50, // –í–°–ï–ì–î–ê –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ
    type: TransactionType.MONEY_EXPENSE,
    description: '–û–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥–∏',
    bot_name: botName,
    service_type: ModeEnum.NeuroPhoto
  }
})
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```typescript
import { getUserBalance } from '@/core/supabase/getUserBalance'

// –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const balance = await getUserBalance(userId)
console.log(`–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${balance} –∑–≤–µ–∑–¥`)

// –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –±–∞–ª–∞–Ω—Å–∞ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
import { invalidateBalanceCache } from '@/core/supabase/getUserBalance'
invalidateBalanceCache(userId)
```

## –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–∞–ª–∞–Ω—Å –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ –±—ã–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –±–∞–ª–∞–Ω—Å–∞.

**–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à –±–∞–ª–∞–Ω—Å–∞ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞:
```typescript
invalidateBalanceCache(telegram_id)
```

### –ü—Ä–æ–±–ª–µ–º–∞: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏–Ω–≤–æ–π—Å–∞.

**–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `inv_id` –¥–ª—è –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
```typescript
const inv_id = uuidv4() // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ –ø—Ä–∏—Ö–æ–¥—è—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö

**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞ –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ.

**–†–µ—à–µ–Ω–∏–µ:** 
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ `createBotByName`
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `isDev` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏–µ
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–ª–∞—Ç–µ–∂–∞—Ö –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã 