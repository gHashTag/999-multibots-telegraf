# üí≥ –ü–ª–∞—Ç–µ–∂–Ω–∞—è –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞ NeuroBlogger

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è **–µ–¥–∏–Ω—ã–º —Ü–µ–Ω—Ç—Ä–æ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è** –≤—Å–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ (Robokassa, Telegram Stars), –∏—Ö —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º, –æ—Ç–ª–∞–¥–∫–æ–π –∏ –ø–ª–∞–Ω–∞–º–∏ —Ä–∞–∑–≤–∏—Ç–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–µ NeuroBlogger.

**–¶–µ–ª—å:** –û–±–µ—Å–ø–µ—á–∏—Ç—å —è—Å–Ω–æ—Å—Ç—å, –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –ø–æ—Ä—è–¥–æ–∫ –≤ —Ä–∞–±–æ—Ç–µ —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏.

## üöÄ –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å (2024-07-22)

–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –ø–ª–∞—Ç–µ–∂–Ω–∞—è –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞–¥–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏ –∏ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏.

- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã Robokassa:** –ü—Ä–æ—Ö–æ–¥—è—Ç, –Ω–æ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º –æ–±—Ö–æ–¥–Ω—ã–º –ø—É—Ç–µ–º (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –±–ª–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –∑–∞–ø—Ä–æ—Å–æ–º –∫ –ë–î).
- ‚ùå **–Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å—Ü–µ–Ω (`paymentScene`, `rublePaymentScene`, `starPaymentScene`):** –°–æ–¥–µ—Ä–∂–∞—Ç –æ—à–∏–±–∫–∏ –∏ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç.
- ‚ùå **–Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –≤–µ–±—Ö—É–∫–∞ Robokassa (`robokassaWebhook.test.ts`):** –°–æ–¥–µ—Ä–∂–∞—Ç –æ—à–∏–±–∫—É –ª–∏–Ω—Ç–µ—Ä–∞, –º–µ—à–∞—é—â—É—é –ø—Ä–æ–≤–µ—Ä–∫–µ.
- ‚ö†Ô∏è **–ü–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ Robokassa:** –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏, –≤–æ–∑–º–æ–∂–Ω–æ, –¥–æ—Ä–∞–±–æ—Ç–∫–∏.
- ‚ö†Ô∏è **–û–±—Ä–∞–±–æ—Ç–∫–∞ Telegram Stars:** –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤.
- üîó **–°—Ö–µ–º–∞ –ë–î:** –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Å–≤—è–∑—å (foreign key) –º–µ–∂–¥—É `payments_v2` –∏ `users`, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## üß≠ –¶–µ–ª–µ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –æ–ø–ª–∞—Ç—ã (Flows) - –ö–ê–ö –î–û–õ–ñ–ù–û –ë–´–¢–¨

–ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—É—Ç–∞–Ω–∏—Ü—ã, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —á–µ—Ç–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π:

1.  **üí∞ –ü—Ä–æ—Å–º–æ—Ç—Ä –±–∞–ª–∞–Ω—Å–∞:**

    - **–í—Ö–æ–¥:** –ö–Ω–æ–ø–∫–∞ "üí∞ –ú–æ–π –±–∞–ª–∞–Ω—Å" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é.
    - **–î–µ–π—Å—Ç–≤–∏–µ:** –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    - **–°—Ü–µ–Ω–∞:** –í–µ—Ä–æ—è—Ç–Ω–æ, `balanceScene`.

2.  **‚ûï –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞:**

    - **–í—Ö–æ–¥:** –ö–Ω–æ–ø–∫–∞ "‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é.
    - **–î–µ–π—Å—Ç–≤–∏–µ:**
      - –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å—Ü–µ–Ω—É –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ _–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è_ (`paymentScene`, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è).
      - –í—ã–±–æ—Ä "üí≥ –†—É–±–ª—è–º–∏" -> –ü–µ—Ä–µ—Ö–æ–¥ –≤ `rublePaymentScene` –¥–ª—è –≤—ã–±–æ—Ä–∞ _—Å—É–º–º—ã –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è_ -> –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ Robokassa -> –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–≤–µ–∑–¥.
      - –í—ã–±–æ—Ä "‚≠êÔ∏è –ó–≤–µ–∑–¥–∞–º–∏" -> (–ï—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ) –õ–æ–≥–∏–∫–∞ –ø–æ–∫—É–ø–∫–∏ –∑–≤–µ–∑–¥ –∑–∞ –∑–≤–µ–∑–¥—ã?
    - **–¶–µ–ª—å:** –£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥ –Ω–∞ —Å—á–µ—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

3.  **üí´ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ / –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏:**
    - **–í—Ö–æ–¥:** –ö–Ω–æ–ø–∫–∞ "üí´ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É" (–∏–ª–∏ "‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π") –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é.
    - **–î–µ–π—Å—Ç–≤–∏–µ:**
      - –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å—Ü–µ–Ω—É –≤—ã–±–æ—Ä–∞ _—Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏_ (NeuroBase, NeuroMeeting –∏ —Ç.–¥.) - –≤–æ–∑–º–æ–∂–Ω–æ, `subscriptionScene`.
      - –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø–æ–¥–ø–∏—Å–∫–∏ -> –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Å—Ü–µ–Ω—É –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ _–æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏_ (`paymentScene`, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è).
      - –í—ã–±–æ—Ä "‚≠êÔ∏è –ó–≤–µ–∑–¥–∞–º–∏" -> –°–ø–∏—Å–∞–Ω–∏–µ –Ω—É–∂–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–≤–µ–∑–¥ —Å–æ —Å—á–µ—Ç–∞ –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É (`handleBuySubscription`?).
      - –í—ã–±–æ—Ä "üí≥ –†—É–±–ª—è–º–∏" -> –ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ–ø–ª–∞—Ç–µ _—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫–∏_ —Ä—É–±–ª—è–º–∏ —á–µ—Ä–µ–∑ Robokassa (`rublePaymentScene` —Å –Ω—É–∂–Ω–æ–π —Å—É–º–º–æ–π).
    - **–¶–µ–ª—å:** –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –ø—Ä–æ–¥–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É.

**–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞ (2024-07-22):** –ö–Ω–æ–ø–∫–∞ "üí´ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É" –æ—à–∏–±–æ—á–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π "‚ûï –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞" –≤–º–µ—Å—Ç–æ –ø–æ–∫–∞–∑–∞ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫.
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (2024-07-22):** –£–¥–∞–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `userDetails.isSubscriptionActive` –∏–∑ `subscriptionScene.enter()`, —á—Ç–æ–±—ã —Å—Ü–µ–Ω–∞ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ –≤–∞—Ä–∏–∞–Ω—Ç—ã.

## üìú –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏

–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–∞—Ö –±–µ—Ä–µ—Ç—Å—è –∏–∑ `getTranslation({ key: 'subscriptionScene', ... })`. –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–Ω—ã (–ø—Ä–∏–º–µ—Ä–Ω–æ):

- **NeuroBase:** (–û–ø–∏—Å–∞–Ω–∏–µ, —Ü–µ–Ω–∞ –≤ ‚ÇΩ/$/‚≠êÔ∏è)
- **NeuroPhoto:** (–û–ø–∏—Å–∞–Ω–∏–µ, —Ü–µ–Ω–∞ –≤ ‚ÇΩ/$/‚≠êÔ∏è)
- **NeuroMeeting:** (–û–ø–∏—Å–∞–Ω–∏–µ, —Ü–µ–Ω–∞ –≤ ‚ÇΩ/$/‚≠êÔ∏è)
- **NeuroBlogger:** (–û–ø–∏—Å–∞–Ω–∏–µ, —Ü–µ–Ω–∞ –≤ ‚ÇΩ/$/‚≠êÔ∏è)
- **NeuroMentor:** (–û–ø–∏—Å–∞–Ω–∏–µ, —Ü–µ–Ω–∞ –≤ ‚ÇΩ/$/‚≠êÔ∏è)
- _(–í–æ–∑–º–æ–∂–Ω–æ –¥—Ä—É–≥–∏–µ)_
- **NeuroTester:** (–¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)

_–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –¢–æ—á–Ω—ã–µ —Ü–µ–Ω—ã –∏ –æ–ø–∏—Å–∞–Ω–∏—è –Ω—É–∂–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Supabase (—Ç–∞–±–ª–∏—Ü–∞ `translations`)._

## ‚öôÔ∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã

1.  **Robokassa:**
    - **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–∏–µ–º –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Ä—É–±–ª—è—Ö (–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞, –ø–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫).
    - **–í–µ–±—Ö—É–∫:** `src/webhooks/robokassa/robokassa.handler.ts` (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Result URL).
    - **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** `MERCHANT_LOGIN`, `PASSWORD1` (–¥–ª—è —Ñ–æ—Ä–º—ã), `PASSWORD2` (–¥–ª—è –≤–µ–±—Ö—É–∫–æ–≤) –≤ `.env`.
    - **–¢–µ—Å—Ç—ã:** `__tests__/integration/robokassa.integration.test.ts` (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π), `__tests__/payments/robokassaWebhook.test.ts` (—é–Ω–∏—Ç).
2.  **Telegram Stars:**
    - **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–∏–µ–º –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –≤–∞–ª—é—Ç—É Telegram (–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞, –ø–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫).
    - **–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:**
      - `handleSelectStars`, `handleBuySubscription` (–≤—ã–±–æ—Ä –ø–∞–∫–µ—Ç–∞/–ø–æ–¥–ø–∏—Å–∫–∏).
      - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ `pre_checkout_query` –∏ `successful_payment` (—Ç—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏/—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏).
    - **–¢–µ—Å—Ç—ã:** `__tests__/payments/starPaymentScene.test.ts` (—á–∞—Å—Ç–∏—á–Ω–æ), —Ç–µ—Å—Ç—ã –¥–ª—è `pre_checkout_query`/`successful_payment` –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π

–í–µ—Å—å –∫–æ–¥, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–ª–∞—Ç–µ–∂–µ–π, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥–µ `__tests__/payments/`.

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–æ–ª—å–∫–æ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:**

```bash
pnpm test:payment
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ `__tests__/payments/`:**

- `paymentScene.test.ts`: –¢–µ—Å—Ç—ã –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω—ã –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã.
- `rublePaymentScene.test.ts`: –¢–µ—Å—Ç—ã –¥–ª—è —Å—Ü–µ–Ω—ã –æ–ø–ª–∞—Ç—ã —Ä—É–±–ª—è–º–∏ (—á–µ—Ä–µ–∑ Robokassa).
- `starPaymentScene.test.ts`: –¢–µ—Å—Ç—ã –¥–ª—è —Å—Ü–µ–Ω—ã –æ–ø–ª–∞—Ç—ã –∑–≤–µ–∑–¥–∞–º–∏ Telegram.
- `robokassaWebhook.test.ts`: –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤ Robokassa.
- _(–í–æ–∑–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è `pre_checkout_query`, `successful_payment` –∏ –¥—Ä.)_

**–û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –ø–ª–∞—Ç–µ–∂–µ–π:** —Å–º. `__tests__/README.md`.

## üéØ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –∏ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏

**üöÄ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ç–µ—Å—Ç–æ–≤ Robokassa**

1.  **‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –ª–∏–Ω—Ç–µ—Ä–∞ –≤ `robokassaWebhook.test.ts`:**

    - **–ó–∞–¥–∞—á–∞:** –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –æ—à–∏–±–∫—É `Property 'mockResolvedValue' does not exist...`.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ `sendMessage`, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `(mockBot.telegram.sendMessage as jest.Mock).mockResolvedValue(...)`.
    - **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ.

2.  **‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
    - **–ó–∞–¥–∞—á–∞:** –ö–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (`sendMessage`) –≤ `handleRobokassaResult` —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É –≤ —Ç–µ—Å—Ç–∞—Ö –∏ —É–±–µ–¥–∏—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ—à–∏–±–∫–∏ `PGRST200`.
    - **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ. –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç, –æ—à–∏–±–∫–∞ `PGRST200` –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è.

**üöÄ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å—Ü–µ–Ω**

3.  **‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É `next(ctx) called with invalid context` –≤ `paymentScene.test.ts`:**

    - **–ü—Ä–∏—á–∏–Ω–∞:** –í–µ—Ä–æ—è—Ç–Ω–æ, –Ω–µ–ø–æ–ª–Ω—ã–π –º–æ–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ `ctx` –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ middleware.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –û—Ç–∫–∞—Ç –∫ `paymentScene.middleware()` –∏ `paymentScene.enterMiddleware()`, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–∫–æ–≤.
    - **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ. –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç.

4.  **‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É `next(ctx) called with invalid context` –≤ `rublePaymentScene.test.ts`:**

    - **–ü—Ä–∏—á–∏–Ω–∞:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ `paymentScene.test.ts`.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ `paymentScene.test.ts`.
    - **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ. –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç.

5.  **‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É `TypeError: Cannot read properties of undefined (reading 'supabaseUrl')` –≤ `rublePaymentScene.test.ts`:**

    - **–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–ª–∏ –ø–µ—Ä–µ–¥–∞—á–∞ –º–æ–∫–æ–≤ Supabase.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –º–æ–∫–∏ –∏ –∏–º–ø–æ—Ä—Ç—ã.
    - **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ. –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç.

6.  **‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É `TypeError: Cannot read properties of undefined (reading 'id')` –≤ `starPaymentScene.test.ts`:**
    - **–ü—Ä–∏—á–∏–Ω–∞:** –ú–æ–∫ `ctx.from` –±—ã–ª –Ω–µ–ø–æ–ª–Ω—ã–º.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –î–æ–±–∞–≤–ª–µ–Ω `id` –≤ –º–æ–∫ `ctx.from` –≤ `makeMockContext`.
    - **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ. –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç.

**üöÄ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –£–ª—É—á—à–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏**

7.  **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å/–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–∫—É–ø–∫—É –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ Robokassa:**

    - **–ó–∞–¥–∞—á–∞:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –¥–ª—è `payment.type === 'SUBSCRIPTION_PURCHASE'`. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å/–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ `updateUserSubscription`. –ù–∞–ø–∏—Å–∞—Ç—å/—Ä–∞—Å—à–∏—Ä–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç.
    - **–°—Ç–∞—Ç—É—Å:** ‚è≥ –û–∂–∏–¥–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

8.  **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–ª–∞—Ç–µ–∂–µ–π Telegram Stars:**

    - **–ó–∞–¥–∞—á–∞:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É `PreCheckoutQuery` –∏ `SuccessfulPayment`.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –ù–∞–π—Ç–∏ —Ö–µ–Ω–¥–ª–µ—Ä—ã. –ù–∞–ø–∏—Å–∞—Ç—å/–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –¥–ª—è –Ω–∏—Ö.
    - **–°—Ç–∞—Ç—É—Å:** ‚è≥ –û–∂–∏–¥–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

9.  **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∏ —Ä–µ–≤—å—é:**

    - **–ó–∞–¥–∞—á–∞:** –£–ª—É—á—à–∏—Ç—å —á–∏—Ç–∞–µ–º–æ—Å—Ç—å, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ –ø–ª–∞—Ç–µ–∂–Ω–æ–º –∫–æ–¥–µ.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–µ–≤—å—é –∫–æ–¥–∞ —Å—Ü–µ–Ω, —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤, –≤–µ–±—Ö—É–∫–æ–≤.
    - **–°—Ç–∞—Ç—É—Å:** ‚è≥ –û–∂–∏–¥–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

10. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Foreign Key –≤ –ë–î (–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è):**
    - **–ó–∞–¥–∞—á–∞:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑—å –º–µ–∂–¥—É `payments_v2` –∏ `users`.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –î–æ–±–∞–≤–∏—Ç—å foreign key constraint –≤ Supabase (`payments_v2.telegram_id` -> `users.telegram_id` –∏–ª–∏ —á–µ—Ä–µ–∑ `user_id`).
    - **–°—Ç–∞—Ç—É—Å:** ‚è≥ –ó–∞–¥–∞—á–∞ –Ω–∞ –±—É–¥—É—â–µ–µ.

# Payments Tests README

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –≤ `__tests__/payments` –ø—Ä–æ—Ö–æ–¥—è—Ç! üéâ

**üéØ –¶–µ–ª–∏:**

## üìù –ó–∞–¥–∞—á–∏ –∏ –ü—Ä–æ–±–ª–µ–º—ã

### ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ `robokassaWebhook.test.ts` (–ì–æ—Ç–æ–≤–æ!)

1.  **‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –ª–∏–Ω—Ç–µ—Ä–∞ –≤ `robokassaWebhook.test.ts`:**
    - **–ó–∞–¥–∞—á–∞:** –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –æ—à–∏–±–∫—É `Property 'mockResolvedValue' does not exist...`.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ `sendMessage`, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `(mockBot.telegram.sendMessage as jest.Mock).mockResolvedValue(...)`.
    - **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ.
2.  **‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
    - **–ó–∞–¥–∞—á–∞:** –ö–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (`sendMessage`) –≤ `handleRobokassaResult` —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É –≤ —Ç–µ—Å—Ç–∞—Ö –∏ —É–±–µ–¥–∏—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ—à–∏–±–∫–∏ `PGRST200`.
    - **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ. –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç, –æ—à–∏–±–∫–∞ `PGRST200` –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è.

### ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω –æ–ø–ª–∞—Ç—ã (–ì–æ—Ç–æ–≤–æ!)

1.  **‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É `next(ctx) called with invalid context` –≤ `paymentScene.test.ts`:**
    - **–ü—Ä–∏—á–∏–Ω–∞:** –í–µ—Ä–æ—è—Ç–Ω–æ, –Ω–µ–ø–æ–ª–Ω—ã–π –º–æ–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ `ctx` –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ middleware.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –û—Ç–∫–∞—Ç –∫ `paymentScene.middleware()` –∏ `paymentScene.enterMiddleware()`, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–∫–æ–≤.
    - **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ. –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç.
2.  **‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É `next(ctx) called with invalid context` –≤ `rublePaymentScene.test.ts`:**
    - **–ü—Ä–∏—á–∏–Ω–∞:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ `paymentScene.test.ts`.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ `paymentScene.test.ts`.
    - **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ. –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç.
3.  **‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É `TypeError: Cannot read properties of undefined (reading 'supabaseUrl')` –≤ `rublePaymentScene.test.ts`:**
    - **–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–ª–∏ –ø–µ—Ä–µ–¥–∞—á–∞ –º–æ–∫–æ–≤ Supabase.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –º–æ–∫–∏ –∏ –∏–º–ø–æ—Ä—Ç—ã.
    - **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ. –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç.
4.  **‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É `TypeError: Cannot read properties of undefined (reading 'id')` –≤ `starPaymentScene.test.ts`:**
    - **–ü—Ä–∏—á–∏–Ω–∞:** –ú–æ–∫ `ctx.from` –±—ã–ª –Ω–µ–ø–æ–ª–Ω—ã–º.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –î–æ–±–∞–≤–ª–µ–Ω `id` –≤ –º–æ–∫ `ctx.from` –≤ `makeMockContext`.
    - **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ. –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç.

### ‚è≥ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –£–ª—É—á—à–µ–Ω–∏—è –∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ (–û—Ç–ª–æ–∂–µ–Ω–æ)

1.  **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**

    - **–ó–∞–¥–∞—á–∞:** –ö–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (`sendMessage`) –≤ `handleRobokassaResult` —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É –≤ —Ç–µ—Å—Ç–∞—Ö –∏ —É–±–µ–¥–∏—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ—à–∏–±–∫–∏ `PGRST200`.
    - **–°—Ç–∞—Ç—É—Å:** ‚è≥ –û–∂–∏–¥–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

2.  **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–ª–∞—Ç–µ–∂–µ–π Telegram Stars:**

    - **–ó–∞–¥–∞—á–∞:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É `PreCheckoutQuery` –∏ `SuccessfulPayment`.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –ù–∞–π—Ç–∏ —Ö–µ–Ω–¥–ª–µ—Ä—ã. –ù–∞–ø–∏—Å–∞—Ç—å/–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –¥–ª—è –Ω–∏—Ö.
    - **–°—Ç–∞—Ç—É—Å:** ‚è≥ –û–∂–∏–¥–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

3.  **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∏ —Ä–µ–≤—å—é:**

    - **–ó–∞–¥–∞—á–∞:** –£–ª—É—á—à–∏—Ç—å —á–∏—Ç–∞–µ–º–æ—Å—Ç—å, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ –ø–ª–∞—Ç–µ–∂–Ω–æ–º –∫–æ–¥–µ.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–µ–≤—å—é –∫–æ–¥–∞ —Å—Ü–µ–Ω, —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤, –≤–µ–±—Ö—É–∫–æ–≤.
    - **–°—Ç–∞—Ç—É—Å:** ‚è≥ –û–∂–∏–¥–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

4.  **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Foreign Key –≤ –ë–î (–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è):**
    - **–ó–∞–¥–∞—á–∞:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑—å –º–µ–∂–¥—É `payments_v2` –∏ `users`.
    - **–î–µ–π—Å—Ç–≤–∏—è:** –î–æ–±–∞–≤–∏—Ç—å foreign key constraint –≤ Supabase (`payments_v2.telegram_id` -> `users.telegram_id` –∏–ª–∏ —á–µ—Ä–µ–∑ `user_id`).
    - **–°—Ç–∞—Ç—É—Å:** ‚è≥ –ó–∞–¥–∞—á–∞ –Ω–∞ –±—É–¥—É—â–µ–µ.
