# Инструкция по деплою на сервер

В этом руководстве описан процесс деплоя мульти-бот платформы на сервер с использованием Docker.

## Предварительные требования

- Сервер с доступом по SSH
- Установленный Docker и Docker Compose на сервере
- Настроенный домен с SSL-сертификатом для webhook (для продакшн окружения)

## Подготовка файлов конфигурации

### 1. Создание файла .env

Создайте файл `.env` в корне проекта со следующими переменными:

```
# Основные настройки
NODE_ENV=production
PORT=3001

# Токены ботов (добавьте свои токены)
BOT_TOKEN_1=111111:AAAAAAA
BOT_TOKEN_2=222222:BBBBBBB
BOT_TOKEN_3=333333:CCCCCCC

# Настройки для webhook режима
WEBHOOK_DOMAIN=https://your-domain.com
WEBHOOK_PATH=/webhook
```

### 2. Настройка скриптов деплоя

В корне проекта есть два скрипта для деплоя:

- `scripts/deploy.sh` - для деплоя в продакшн окружение
- `scripts/deploy-test.sh` - для деплоя в тестовое окружение

Убедитесь, что в этих скриптах указан правильный путь к вашему приватному ключу SSH и адрес сервера.

## Деплой в продакшн окружение

Продакшн окружение использует режим webhook для более эффективной работы.

### 1. Обновите файл .env для продакшн

```
NODE_ENV=production
```

### 2. Запустите скрипт деплоя

```bash
pnpm deploy
```

Скрипт выполнит следующие действия:

1. Соберет проект локально
2. Скопирует необходимые файлы на сервер
3. Остановит предыдущую версию приложения на сервере
4. Запустит новую версию с актуальными настройками

## Деплой в тестовое окружение

Тестовое окружение использует режим long polling для более простой настройки.

### 1. Обновите файл .env для тестового окружения

```
NODE_ENV=test
```

### 2. Запустите скрипт деплоя для тестирования

```bash
pnpm deploy:test
```

## Проверка статуса деплоя

После деплоя вы можете проверить статус контейнеров:

```bash
ssh -i ~/.ssh/id_rsa root@your-server.com 'cd /opt/app/999-multibots-telegraf && docker compose ps'
```

И просмотреть логи приложения:

```bash
ssh -i ~/.ssh/id_rsa root@your-server.com 'cd /opt/app/999-multibots-telegraf && docker compose logs --tail=100 app'
```

## Настройка Nginx (для продакшн окружения)

При использовании webhook требуется настройка Nginx для проксирования запросов к боту.

Контейнер с Nginx уже включен в docker-compose.yml и настроен автоматически.

## Перезапуск приложения

Если вам нужно перезапустить приложение без деплоя новой версии:

```bash
ssh -i ~/.ssh/id_rsa root@your-server.com 'cd /opt/app/999-multibots-telegraf && docker compose restart app'
```

## Обновление конфигурации

Для обновления конфигурации (например, добавления новых токенов ботов):

1. Обновите локальный файл .env
2. Запустите скрипт деплоя
3. Приложение будет перезапущено с новыми настройками

## Устранение неполадок

### Проверка логов

```bash
ssh -i ~/.ssh/id_rsa root@your-server.com 'cd /opt/app/999-multibots-telegraf && docker compose logs --tail=100 app'
```

### Проверка статуса контейнеров

```bash
ssh -i ~/.ssh/id_rsa root@your-server.com 'cd /opt/app/999-multibots-telegraf && docker compose ps'
```

### Принудительная пересборка контейнеров

```bash
ssh -i ~/.ssh/id_rsa root@your-server.com 'cd /opt/app/999-multibots-telegraf && docker compose down && docker compose up -d --build'
```

## Безопасность

- Все токены ботов хранятся в файле .env и не должны попадать в репозиторий
- Используйте SSH-ключ для доступа к серверу, избегайте использования пароля
- Регулярно обновляйте операционную систему и Docker на сервере

## Деплой на Vercel (альтернативный способ)

Vercel предоставляет платформу для serverless-развертывания, что может быть удобной альтернативой выделенному серверу, особенно для Preview-окружений и фронтенда.

### Предварительные требования

- Установленный Node.js и npm/pnpm локально
- Аккаунт Vercel
- Установленный Vercel CLI: `npm install -g vercel` или `pnpm add -g vercel`

### Подготовка

1.  **Вход в Vercel CLI:**
    ```bash
    vercel login
    ```
    (Может потребоваться подтверждение в браузере)

2.  **Связывание проекта:** Перейдите в корневую директорию проекта и выполните:
    ```bash
    vercel link
    ```
    Следуйте инструкциям CLI, чтобы связать локальный проект с вашим проектом на Vercel.

3.  **Конфигурация `vercel.json`:** Убедитесь, что в корне проекта есть файл `vercel.json` с корректными настройками сборки и роутинга (пример см. в корне проекта).

4.  **Переменные окружения:** Настройте необходимые переменные окружения в дашборде Vercel для вашего проекта (Tokens, Supabase keys, `NODE_ENV=production`, `ACTIVE_BOTS` и т.д.). Разделите их по окружениям (Production, Preview, Development), если необходимо. **Не храните секреты в коде!**

### Деплой Preview-окружения

Preview-окружения создаются для каждой ветки (кроме production-ветки, обычно `main`).

1.  **Переключитесь на нужную ветку:**
    ```bash
    git checkout ваша-ветка # например, testing
    ```
2.  **Запустите деплой:**
    ```bash
    vercel
    ```
    Или более явно:
    ```bash
    vercel deploy
    ```
    Vercel CLI соберет проект (используя команду из `package.json` или `vercel.json`) и задеплоит его. Вы получите уникальный URL для этого Preview-окружения.

### Деплой Production-окружения

Production-окружение обычно связано с основной веткой (`main`).

1.  **Убедитесь, что вы в основной ветке:**
    ```bash
    git checkout main
    git pull origin main # Убедитесь, что локальная ветка актуальна
    ```
2.  **Запустите деплой в Production:**
    ```bash
    vercel --prod
    ```
    Vercel соберет и задеплоит проект на ваш основной домен, связанный с проектом.

### Проверка и Отладка

- **Логи:** Используйте дашборд Vercel для просмотра логов сборки и выполнения (Runtime Logs).
- **Локальная сборка:** Для отладки проблем сборки можно запустить локально:
  ```bash
  vercel build
  ```
- **Локальный запуск (для разработки):**
  ```bash
  vercel dev
  ```
  (Запускает локальный сервер разработки, имитирующий среду Vercel)

### Установка Webhooks (для Telegram)

После получения URL от Vercel (Preview или Production), необходимо установить вебхуки для ваших Telegram-ботов:
`https://<ваш-vercel-url>/api/webhook/<ID_бота>`

Используйте для этого API Telegram или специальные инструменты/скрипты.
