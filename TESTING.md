# Система тестирования для Neuro Blogger

Этот документ описывает подход к тестированию, используемый в проекте Neuro Blogger, и объясняет, почему важно всегда использовать моки вместо реальной базы данных.

## Почему мы используем моки вместо реальной базы данных

1. **Безопасность данных**
   - Тесты могут случайно изменить или удалить реальные данные пользователей
   - При параллельных запусках тестов может произойти конфликт данных

2. **Стабильность тестов**
   - Тесты не должны зависеть от внешних систем
   - Результаты тестов должны быть воспроизводимыми в любой среде

3. **Скорость выполнения**
   - Моки работают намного быстрее реальных запросов к базе данных
   - Нет необходимости ждать ответа от внешних сервисов

4. **Независимость от окружения**
   - Тесты должны работать одинаково на локальной машине, в CI и на других средах
   - Не требуются реальные учетные данные для тестирования

## Архитектура системы тестирования

### 1. Определение тестового окружения

Мы используем несколько переменных окружения для определения тестового режима:

```javascript
const isTestEnvironment = () => {
  return process.env.NODE_ENV === 'test' || 
         process.env.TEST === 'true' || 
         new Error().stack?.includes('test') || 
         new Error().stack?.includes('simplest-test') || 
         !!process.env.JEST_WORKER_ID || 
         process.env.RUNNING_IN_TEST_ENV === 'true';
}
```

### 2. Мокирование Supabase клиента

В файле `src/supabase.ts` мы автоматически используем мок-клиент, когда определяем, что код работает в тестовом окружении:

```javascript
if (isTestEnvironment()) {
  // Используем мок-клиент
} else {
  // Используем реальный клиент
}
```

### 3. Мокирование в тестах

В наших тестах мы используем следующие подходы:

- `mockSupabase.ts` - класс, который предоставляет в памяти хранилище для пользователей и операций
- `Object.defineProperty` - для замены методов доступа к базе данных на моки
- Установка переменных окружения в начале файла теста

## Запуск тестов

### В обычном режиме

```bash
# Запустить все тесты для нейрофото
./run-all-neurophoto-tests.sh

# Запустить только тесты для нейрофото V2
cd src/test-utils && node simplest-test-neurophoto-v2.js
```

### В Docker-контейнере (рекомендуется)

Для полной изоляции рекомендуется запускать тесты в Docker-контейнере:

```bash
# Запустить все тесты в Docker
./run-docker-tests.sh

# Запустить конкретный набор тестов
./run-docker-tests.sh neurophoto-v2

# Запустить через docker-compose (с тестовой БД)
./run-docker-tests.sh --compose
```

## Правила написания тестов

1. **Всегда устанавливайте переменные окружения в начале теста**
   ```javascript
   process.env.NODE_ENV = 'test';
   process.env.TEST = 'true';
   ```

2. **Всегда используйте моки вместо реальных сервисов**
   ```javascript
   // Плохо
   const user = await supabase.from('users').select().eq('telegram_id', '123').single();
   
   // Хорошо
   const user = await mockSupabase.getUserByTelegramId('123');
   ```

3. **Сбрасывайте состояние моков после каждого теста**
   ```javascript
   afterEach(() => {
     mockSupabase.reset();
   });
   ```

4. **Проверяйте, что ваш тест действительно использует моки**
   ```javascript
   if (!global.mockSupabaseActivated) {
     throw new Error('Test is not using mock Supabase!');
   }
   ```

## Поддержка тестов

### Известные проблемы

1. **Тесты обращаются к реальной БД вместо моков**
   - Решение: Убедитесь, что `isTestEnvironment()` возвращает `true` для вашего теста
   - Проверьте стек вызовов, чтобы убедиться, что он содержит 'test'

2. **Ошибки при запуске Docker-тестов**
   - Решение: Убедитесь, что у скрипта есть права на выполнение (`chmod +x run-docker-tests.sh`)
   - Проверьте, что Docker запущен и доступен

### Действия при обнаружении проблем

1. Если вы обнаружили, что тест обращается к реальной БД:
   - Немедленно остановите тест
   - Добавьте принудительное определение тестового окружения в начало теста
   - Обновите файл `src/supabase.ts`, если необходимо расширить проверку тестового окружения

2. При разработке новых тестов:
   - Запускайте их с флагом `--debug`, чтобы увидеть все запросы к БД
   - Запускайте в Docker для гарантии изоляции
   - Регулярно проверяйте, что тесты используют моки

## Заключение

Следование этим правилам позволит создавать надежные, воспроизводимые и безопасные тесты, которые не повредят реальные данные и будут работать в любой среде. Помните, что тестирование - это не только проверка работоспособности, но и обеспечение надежности и безопасности всего приложения. 