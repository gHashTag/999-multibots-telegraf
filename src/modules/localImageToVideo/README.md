# Модуль: Генерация Видео из Текста (Text-to-Video через Replicate)

Этот модуль (изначально Image-to-Video) теперь описывает, как **создать видео по текстовому описанию**, используя модель `haiper-ai/haiper-video-2` сервиса Replicate.

## Руководство для Терминала (Прямой вызов Text-to-Video)

Это руководство показывает, как одной командой `curl` в терминале (Bash) запустить генерацию видео и сразу дождаться результата.

**Что понадобится:**

1.  **Терминал:** Окно для ввода команд.
2.  **Программы:**
    *   `curl`: Для отправки запроса в интернет.
    *   `jq`: Для красивого отображения результата (JSON).
3.  **Ключ Replicate API:** Секретный ключ для доступа к Replicate.

**Шаг 1: Подготовка - Задаем наши данные**

Открой терминал и выполни эти команды, **подставив свои значения** вместо `<...>`:

```bash
# 1. Сохраняем ключ Replicate (ВАЖНО: не показывай его никому!)
export REPLICATE_API_TOKEN="<твой_ключ_replicate_api>"

# 2. Пишем описание (промпт) для видео
export PROMPT="<описание_того_что_должно_быть_на_видео>"

# 3. Задаем параметры для видео (можно изменить)
export DURATION=6  # Длительность в секундах
export RESOLUTION=1080 # Разрешение (например, 1080 или 720)
export ASPECT_RATIO="16:9" # Соотношение сторон
export USE_PROMPT_ENHANCER=true # Использовать улучшатель промпта (true/false)

# 4. Задаем ID модели Haiper
export REPLICATE_MODEL_ID="haiper-ai/haiper-video-2"

echo "Переменные установлены! Можно запускать генерацию."
```

**Шаг 2: Запуск генерации и ожидание результата**

Теперь выполни **одну** команду `curl`. Она отправит запрос в Replicate и, благодаря заголовку `Prefer: wait`, будет ждать, пока видео не сгенерируется, а затем вернет полный ответ.

```bash
echo "--- Запускаю генерацию видео и жду результат --- "

# Собираем JSON для поля "input" с помощью jq
JSON_INPUT_DATA=$(jq -n \
  --arg prompt "$PROMPT" \
  --argjson duration "$DURATION" \
  --argjson resolution "$RESOLUTION" \
  --arg aspect_ratio "$ASPECT_RATIO" \
  --argjson use_enhancer "$USE_PROMPT_ENHANCER" \
  '{ "prompt": $prompt, "duration": $duration, "resolution": $resolution, "aspect_ratio": $aspect_ratio, "use_prompt_enhancer": $use_enhancer }'
)

# Выполняем основной запрос curl (убрали -s для большей детализации)
curl -X POST \
  -H "Authorization: Token $REPLICATE_API_TOKEN" \
  -H "Content-Type: application/json" \
  -H "Prefer: wait=120" \ # Ждать до 120 секунд (можно увеличить)
  -d "{ \"input\": $JSON_INPUT_DATA }" \
  "https://api.replicate.com/v1/models/$REPLICATE_MODEL_ID/predictions" | jq .

# Ответ будет выведен в формате JSON.
# Если успешно, ищи поле "output" - там будет ссылка на видео.
# Если ошибка, ищи поле "error".
echo
echo "--- Готово! Проверь вывод выше. --- "
```

**Что происходит в команде `curl`:**

*   `-X POST`: Отправляем данные (создаем новый запрос на генерацию).
*   `-H "Authorization: Token ..."`: Передаем наш секретный ключ.
*   `-H "Content-Type: application/json"`: Говорим, что отправляем данные в формате JSON.
*   `-H "Prefer: wait=120"`: **Самое важное!** Просим Replicate не отвечать сразу ID задачи, а подождать (до 120 секунд), пока задача не завершится (успешно или с ошибкой), и вернуть полный результат.
*   `-d '{ "input": ... }'`: Передаем наши данные (промпт, длительность и т.д.) в формате JSON. Мы используем `jq` для безопасной сборки части `input`.
*   `"https://..."`: Адрес API Replicate для запуска предсказаний конкретной модели.
*   `| jq .`: Полученный ответ (JSON) передаем утилите `jq` для красивого форматирования, чтобы его было удобно читать.

**Результат:**

После выполнения команды ты увидишь в терминале ответ от Replicate в формате JSON. Если все прошло успешно, найди в этом ответе поле `output`. В нем должна быть ссылка (URL) на твое сгенерированное видео.

## Тестирование (TypeScript)

*Примечание: Текущие тесты в `__tests__` могут быть написаны для Image-to-Video и потребуют адаптации для Text-to-Video.*

```shell
bun test src/modules/localImageToVideo/__tests__/generateImageToVideo.test.ts
```

## Поиск и устранение неисправностей

Если видео не создается или возникает ошибка:

*   Убедись, что переменная окружения `REPLICATE_API_TOKEN` установлена правильно и ключ действителен.
*   Проверь правильность `REPLICATE_MODEL_ID`.
*   Проверь статус сервиса Replicate.
*   Посмотри на сообщение об ошибке в поле `error` в JSON-ответе от `curl`.
*   Попробуй увеличить время ожидания в заголовке `Prefer: wait=...`, если генерация занимает больше 120 секунд.
*   Убедись, что параметры в `JSON_INPUT_DATA` (duration, resolution и т.д.) допустимы для модели Haiper.

**NOTE**: This README describes the Replicate API-based implementation.
