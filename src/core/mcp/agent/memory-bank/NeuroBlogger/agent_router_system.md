# Система маршрутизации задач (Agent Router)

## Описание
Система маршрутизации задач (Agent Router) отвечает за распределение задач между различными агентами на основе их возможностей, приоритетов и доступности. Это ключевой компонент для обеспечения эффективной обработки задач в системе NeuroBlogger.

## Основные компоненты

### Router (src/core/mcp/agent/router.ts)
Основной класс маршрутизатора, который:
- Регистрирует агентов с их возможностями
- Маршрутизирует задачи к подходящим агентам
- Управляет приоритизацией задач
- Определяет следующую задачу для обработки

### Интерфейсы и типы

```typescript
interface RouterConfig {
  // Конфигурация маршрутизатора
}

interface Task {
  id: string;
  prompt: string;
  status: TaskStatus;
  priority: number;
  capabilities: string[];
  // другие поля
}

enum TaskStatus {
  PENDING = 'PENDING',
  IN_PROGRESS = 'IN_PROGRESS',
  COMPLETED = 'COMPLETED',
  FAILED = 'FAILED'
}

interface Agent {
  id: string;
  capabilities: string[];
  priority: number;
  maxConcurrentTasks: number;
  currentTaskCount: number;
}
```

## Ключевые методы

### registerAgent
```typescript
registerAgent(agent: Agent): void
```
Регистрирует нового агента в маршрутизаторе с его возможностями, приоритетом и ограничениями.

### routeTask
```typescript
routeTask(task: Task): string | null
```
Маршрутизирует задачу к подходящему агенту на основе:
1. Соответствия возможностей агента требованиям задачи
2. Приоритета агента
3. Текущей загруженности агента (не превышает ли maxConcurrentTasks)

Возвращает ID агента, которому была назначена задача, или null, если подходящий агент не найден.

### getNextTaskToProcess
```typescript
async getNextTaskToProcess(): Promise<Task | null>
```
Определяет следующую задачу для обработки на основе:
1. Приоритета задачи (более высокий приоритет обрабатывается в первую очередь)
2. Статуса задачи (только PENDING задачи рассматриваются)
3. Времени создания задачи (при равном приоритете)

Возвращает задачу, которую следует обработать следующей, или null, если таких задач нет.

## Приоритизация

### Приоритет задач
Задачи имеют числовой приоритет от 1 до 10, где 10 - наивысший приоритет. При выборе следующей задачи для обработки, маршрутизатор всегда выбирает задачу с наивысшим приоритетом.

### Приоритет агентов
Агенты также имеют приоритеты. При маршрутизации задачи, если несколько агентов могут обработать задачу, выбирается агент с наивысшим приоритетом.

## Ограничения и балансировка нагрузки

### maxConcurrentTasks
Каждый агент имеет ограничение на максимальное количество одновременно обрабатываемых задач. Маршрутизатор не назначает задачи агентам, которые уже достигли этого ограничения.

### Трекинг текущих задач
Маршрутизатор отслеживает количество задач, назначенных каждому агенту (currentTaskCount), и обновляет это значение при назначении новых задач и завершении существующих.

## Тестирование

Система маршрутизации задач имеет собственный набор тестов в `src/test-utils/tests/system/agentRouterTest.ts`:

### Основные тесты:
1. **testAgentRegistration**: Проверяет корректность регистрации агентов
2. **testBasicTaskRouting**: Проверяет базовую маршрутизацию задач
3. **testPriorityTaskRouting**: Проверяет приоритизацию задач и агентов
4. **testNextTaskSelection**: Проверяет логику выбора следующей задачи для обработки

## Пример использования

```typescript
// Создание маршрутизатора
const router = new Router({
  // конфигурация
});

// Регистрация агентов
router.registerAgent({
  id: 'agent1',
  capabilities: ['code_generation', 'documentation'],
  priority: 5,
  maxConcurrentTasks: 3,
  currentTaskCount: 0
});

router.registerAgent({
  id: 'agent2',
  capabilities: ['image_generation', 'text_generation'],
  priority: 3,
  maxConcurrentTasks: 5,
  currentTaskCount: 0
});

// Маршрутизация задачи
const agentId = router.routeTask({
  id: 'task1',
  prompt: 'Generate documentation for this code',
  status: TaskStatus.PENDING,
  priority: 7,
  capabilities: ['documentation']
});

// Получение следующей задачи для обработки
const nextTask = await router.getNextTaskToProcess();
```

## Интеграция с базой данных

Система маршрутизации задач интегрируется с таблицей `tasks` в базе данных через:
1. Получение задач из БД для обработки
2. Обновление статусов задач в БД
3. Запись информации о назначенном агенте в поле `assigned_agent_id`

## Возможные улучшения

1. Реализация механизма откатов (если агент не смог обработать задачу)
2. Улучшение алгоритма балансировки нагрузки
3. Учет исторической производительности агентов при маршрутизации
4. Добавление механизма приоритизации на основе времени ожидания задачи
5. Реализация механизма обработки зависимостей между задачами