# Тесты для системы автономных задач

Этот документ содержит SQL-тесты для проверки функций и представлений, работающих с таблицей `autonomous_tasks`.

## Общая структура тестов

1. **Подготовка окружения** - очистка тестовых данных
2. **Тесты создания задач** - проверка создания задач с разными приоритетами
3. **Тесты обновления статуса** - проверка корректности обновления статуса и результата
4. **Тесты получения задач** - проверка выбора задач с учетом приоритета
5. **Тесты зависимостей** - проверка работы с зависимостями между задачами
6. **Тесты декомпозиции** - проверка разбиения задачи на подзадачи
7. **Тесты делегирования** - проверка назначения задач агентам
8. **Тесты представлений** - проверка корректности представлений
9. **Тесты статистики** - проверка функций получения статистики
10. **Очистка данных** - удаление всех тестовых данных

## Пример использования тестов

Для запуска всех тестов выполните следующий SQL-скрипт:

```sql
-- Установка тестовых данных
DO $$
DECLARE
    v_test_telegram_id BIGINT := 999888777;
    v_test_bot_name VARCHAR := 'test_bot';
BEGIN
    -- Удаляем все тестовые задачи
    DELETE FROM autonomous_tasks 
    WHERE telegram_id = v_test_telegram_id 
    AND bot_name = v_test_bot_name;
    
    RAISE NOTICE 'Все тестовые данные успешно удалены';
END;
$$;

-- Тест создания задачи
DO $$
DECLARE
    v_test_telegram_id BIGINT := 999888777;
    v_test_bot_name VARCHAR := 'test_bot';
    v_task_id UUID;
    v_task JSONB;
    v_priority INTEGER;
BEGIN
    -- Создание простой задачи
    v_task_id := create_autonomous_task(
        v_test_telegram_id,
        v_test_bot_name,
        'TEST_TYPE',
        'Тестовая задача 1',
        5,
        '{"test_key": "test_value"}'::jsonb,
        'test-external-id-1'
    );
    
    IF v_task_id IS NULL THEN
        RAISE NOTICE 'Не удалось создать задачу: task_id is NULL';
    ELSE
        RAISE NOTICE 'Задача успешно создана с id: %', v_task_id;
    END IF;
    
    -- ... другие тесты создания задач
END;
$$;

-- ... и так далее для каждого набора тестов
```

## Основные тесты и ожидаемые результаты

### 1. Тесты создания задач
- Создание задачи с разными уровнями приоритета
- Проверка наличия задачи в базе данных после создания
- Проверка корректности метаданных и других атрибутов

### 2. Тесты обновления статуса
- Проверка корректности изменения статуса задачи
- Проверка сохранения результатов выполнения задачи

### 3. Тесты получения задач
- Проверка выбора задачи с наивысшим приоритетом
- Проверка правильного порядка выбора задач при одинаковом приоритете

### 4. Тесты зависимостей
- Проверка правильного выбора задач с учетом зависимостей
- Проверка, что зависимая задача не выбирается до завершения зависимости

### 5. Тесты декомпозиции
- Проверка создания подзадач
- Проверка автоматического обновления статуса родительской задачи

### 6. Тесты делегирования
- Проверка корректного назначения задачи агенту
- Проверка правильного изменения статуса при назначении

### 7. Тесты представлений
- Проверка правильной фильтрации задач в представлении
- Проверка учета завершенных и незавершенных задач

### 8. Тесты статистики
- Проверка корректного подсчета задач разных статусов
- Проверка получения статистики по агентам

## Итоги тестирования

Тесты подтверждают, что реализованные функции и представления для работы с таблицей `autonomous_tasks` корректно выполняют следующие действия:

1. Создание задач с различными атрибутами
2. Обновление статуса и результатов задач
3. Приоритизацию задач с учетом зависимостей
4. Декомпозицию задач на подзадачи
5. Делегирование задач агентам
6. Сбор статистики по выполнению задач

Все реализованные функции прошли тесты и могут быть использованы для интеграции с системой маршрутизации задач (Agent Router).