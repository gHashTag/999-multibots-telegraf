# –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ NeuroBlogger (–î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)

## –û–±–∑–æ—Ä

–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –≤–∫–ª—é—á–∞—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—á–µ—Ç–∞, —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤, –ø–æ–∫—É–ø–∫—É –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –ø–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏—è–º. –í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π.

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **–ü–ª–∞—Ç–µ–∂–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä** - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–ª—É–∂–±–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ Inngest
2. **–§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –±–∞–ª–∞–Ω—Å–æ–º** - API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. **–°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** - –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** - –ø–æ–¥—Ä–æ–±–Ω–æ–µ –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–ª–∞–Ω—Å–æ–º

## –¢–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ |
|-----|----------|------------|
| `money_income` | –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ | –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ |
| `money_expense` | –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ | –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ |
| `subscription_purchase` | –ü–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ | –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ |
| `subscription_renewal` | –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ | –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ |
| `refund` | –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ | –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ |
| `bonus` | –ë–æ–Ω—É—Å–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ | –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ |
| `referral` | –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ | –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ |
| `system` | –°–∏—Å—Ç–µ–º–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ |

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞

```typescript
interface PaymentProcessParams {
  telegram_id: string;        // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
  amount: number;             // –°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–í–°–ï–ì–î–ê –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ)
  stars?: number;             // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥ (–í–°–ï–ì–î–ê –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ)
  type: TransactionType;      // –¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (MONEY_INCOME, MONEY_EXPENSE, etc.)
  description: string;        // –û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  bot_name: string;           // –ù–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞, –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–≤—à–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
  inv_id?: string;            // ID –∏–Ω–≤–æ–π—Å–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
  metadata?: Record<string, any>; // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  service_type: ModeEnum;     // –¢–∏–ø —Å–µ—Ä–≤–∏—Å–∞
}

// –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞ (PaymentProcessResult)
interface PaymentProcessResult {
  success: boolean;           // –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏
  payment: {                  // –î–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
    payment_id: number;
    telegram_id: string;
    amount: number;
    stars: number;
    type: string;
    status: string;
    [key: string]: any;
  };
  balanceChange: {            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞
    before: number;           // –ë–∞–ª–∞–Ω—Å –¥–æ –æ–ø–µ—Ä–∞—Ü–∏–∏
    after: number;            // –ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    difference: number;       // –†–∞–∑–Ω–∏—Ü–∞ –≤ –±–∞–ª–∞–Ω—Å–µ
  };
  error?: string;             // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
}

// –¢–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
enum TransactionType {
  MONEY_INCOME = 'money_income',           // –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
  MONEY_EXPENSE = 'money_expense',         // –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤
  SUBSCRIPTION_PAYMENT = 'subscription_payment', // –û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏
  SUBSCRIPTION_PURCHASE = 'subscription_purchase', // –ü–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
  SUBSCRIPTION_RENEWAL = 'subscription_renewal',  // –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
  REFUND = 'refund',                       // –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
  BONUS = 'bonus',                         // –ë–æ–Ω—É—Å–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
  REFERRAL = 'referral',                   // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
  TRANSFER = 'transfer',                   // –ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤
  SYSTEM = 'system',                       // –°–∏—Å—Ç–µ–º–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
}
```

## –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π

### –®–∞–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞:

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤** - –ø–ª–∞—Ç–µ–∂–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Å—É–º–º—ã –∏ –¥—Ä—É–≥–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞** - –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤.
4. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –ø–ª–∞—Ç–µ–∂–µ** - –∑–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
5. **–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –±–∞–ª–∞–Ω—Å–∞** - —Å–±—Ä–æ—Å –∫—ç—à–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞.
6. **–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

### –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:

- –°—É–º–º—ã `amount` –∏ `stars` **–í–°–ï–ì–î–ê** –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏
- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è **–¢–û–õ–¨–ö–û** —Ç–∏–ø–æ–º (`MONEY_INCOME`/`MONEY_EXPENSE`), –∞ –Ω–µ –∑–Ω–∞–∫–æ–º —Å—É–º–º—ã
- –ö–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ (`üí∞`, `‚≠êÔ∏è`, `üì®`, etc.)
- –ü–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å –±–∞–ª–∞–Ω—Å–∞
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤–æ–π —Å—Ä–µ–¥—ã, –Ω–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é `sendTransactionNotification`, –∫–æ—Ç–æ—Ä–∞—è:

1. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –Ω—É–∂–Ω–æ–º—É –±–æ—Ç—É —á–µ—Ä–µ–∑ `createBotByName`
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
3. –í–∫–ª—é—á–∞–µ—Ç –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –∏ –Ω–æ–≤–æ–º –±–∞–ª–∞–Ω—Å–µ, –∞ —Ç–∞–∫–∂–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SelectModelWizard

### –û–±–∑–æ—Ä

SelectModelWizard –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –ø–ª–∞—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–º –º–æ–¥–µ–ª—è–º. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç:

1. –ú–∞—Ä–∫–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∫–∞–∫ –ø–ª–∞—Ç–Ω—ã–µ (‚≠ê)
2. –ü—Ä–æ–≤–µ—Ä—è—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ –≤—ã–±–æ—Ä–æ–º –ø–ª–∞—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏
3. –°–ø–∏—Å—ã–≤–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–ª–∞—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏
4. –£–≤–µ–¥–æ–º–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞—Ç–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π

–ü–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É—é—Ç—Å—è –≤ –º–∞—Å—Å–∏–≤–µ `PAID_MODELS` –≤ —Ñ–∞–π–ª–µ `src/scenes/selectModelWizard/index.ts`:

```typescript
const PAID_MODELS: PaidModelConfig[] = [
  { name: 'GPT-4', price: 10, isPremium: true },
  { name: 'Claude-3', price: 15, isPremium: true },
  { name: 'Gemini Pro', price: 8, isPremium: true },
  // –î—Ä—É–≥–∏–µ –ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—é–¥–∞
]
```

## SQL —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–∞

### get_user_balance - –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –†–ê–°–ß–ï–¢–ê –ë–ê–õ–ê–ù–°–ê! ‚ö†Ô∏è

```sql
CREATE OR REPLACE FUNCTION public.get_user_balance(user_telegram_id text)
 RETURNS numeric
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_balance numeric := 0;
    v_user_id bigint;
BEGIN
    -- –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º telegram_id –≤ —á–∏—Å–ª–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç
    BEGIN
        v_user_id := user_telegram_id::bigint;
    EXCEPTION WHEN OTHERS THEN
        RETURN 0;
    END;

    -- –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—É –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    -- –í–ê–ñ–ù–û: —Ä–∞—Å—á–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø–∏—Å–µ–π payment_method != 'system'
    -- –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞
    SELECT COALESCE(SUM(
        CASE WHEN p.status = 'COMPLETED' THEN 
            CASE 
                WHEN p.type = 'money_income' THEN COALESCE(p.stars, 0)
                WHEN p.type = 'money_expense' THEN -COALESCE(ABS(p.stars), 0)
                ELSE 0
            END
        ELSE 0 END
    ), 0) INTO v_balance
    FROM payments_v2 p
    WHERE p.telegram_id = v_user_id
    AND p.payment_method != 'system';

    RETURN v_balance;
END;
$function$
```

## –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π

1. **–ù–ò–ö–û–ì–î–ê** –Ω–µ –∏–∑–º–µ–Ω—è–π—Ç–µ SQL-—Ñ—É–Ω–∫—Ü–∏—é `get_user_balance` –±–µ–∑ —Ç—â–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
2. **–ù–ò–ö–û–ì–î–ê** –Ω–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–µ–π —Å `payment_method='system'`
3. **–í–°–ï–ì–î–ê** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∑–∞–ø–∏—Å—å –æ –ø–ª–∞—Ç–µ–∂–µ –≤ `payments_v2` –Ω–∞ –æ–¥–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
4. **–í–°–ï–ì–î–ê** –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ `operation_id` –∏–ª–∏ `inv_id`
5. **–í–°–ï–ì–î–ê** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `payment/process` —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
6. **–ù–ò–ö–û–ì–î–ê** –Ω–µ –∏–∑–º–µ–Ω—è–π—Ç–µ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–ø—Ä—è–º—É—é –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤
```typescript
await inngest.send({
  name: 'payment/process',
  data: {
    telegram_id: user.telegram_id,
    amount: cost, // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ
    type: 'money_expense',
    description: '–û–ø–ª–∞—Ç–∞ –∑–∞ —É—Å–ª—É–≥—É',
    bot_name: 'mybot',
    service_type: ModeEnum.TextToVideo
  }
})
```

### –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
```typescript
await inngest.send({
  name: 'payment/process',
  data: {
    telegram_id: user.telegram_id,
    amount: amount, // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ
    type: 'money_income',
    description: '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞',
    bot_name: 'mybot',
    service_type: ModeEnum.TopUpBalance
  }
})
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã

1. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞**:
   - –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª: `/src/inngest-functions/paymentProcessor.ts` 
   - –ú–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –æ –ø–ª–∞—Ç–µ–∂–µ: `createSuccessfulPayment`
   - –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `updateUserBalance`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞**:
   - –ë–∞–ª–∞–Ω—Å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ `payments_v2`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQL-—Ñ—É–Ω–∫—Ü–∏—è `get_user_balance` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
   - –ù–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –ø–æ–ª–µ –±–∞–ª–∞–Ω—Å–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ `users`

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞**:
   - –ß–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é `/src/core/supabase/getUserBalance.ts`
   - –í–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SQL-—Ñ—É–Ω–∫—Ü–∏—é `get_user_balance`

## –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

- **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**: –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏ –ø–æ `operation_id` –∏–ª–∏ `inv_id`
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SQL-—Ñ—É–Ω–∫—Ü–∏—é `get_user_balance`
- **–î–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤—ã–∑–æ–≤–æ–≤ `updateUserBalance` –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞