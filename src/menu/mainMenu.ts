import { ReplyKeyboardMarkup } from 'telegraf/typings/core/types/typegram'
import { checkFullAccess } from '../handlers/checkFullAccess'
import { Markup } from 'telegraf'
import { MyContext } from '../interfaces/telegram-bot.interface'
import { SubscriptionType } from '../interfaces/subscription.interface'

interface Level {
  title_ru: string
  title_en: string
}

export const levels: Record<number, Level> = {
  // digital_avatar_body
  1: {
    title_ru: 'ğŸ¤– Ğ¦Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ¾Ğµ Ñ‚ĞµĞ»Ğ¾',
    title_en: 'ğŸ¤– Digital Body',
  },
  // neuro_photo
  2: {
    title_ru: 'ğŸ“¸ ĞĞµĞ¹Ñ€Ğ¾Ñ„Ğ¾Ñ‚Ğ¾',
    title_en: 'ğŸ“¸ NeuroPhoto',
  },
  // image_to_prompt
  3: {
    title_ru: 'ğŸ” ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ¸Ğ· Ñ„Ğ¾Ñ‚Ğ¾',
    title_en: 'ğŸ” Prompt from Photo',
  },
  // avatar
  4: {
    title_ru: 'ğŸ§  ĞœĞ¾Ğ·Ğ³ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€Ğ°',
    title_en: 'ğŸ§  Avatar Brain',
  },
  // chat_with_avatar
  5: {
    title_ru: 'ğŸ’­ Ğ§Ğ°Ñ‚ Ñ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€Ğ¾Ğ¼',
    title_en: 'ğŸ’­ Chat with avatar',
  },
  // select_model
  6: {
    title_ru: 'ğŸ¤– Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ˜Ğ˜',
    title_en: 'ğŸ¤– Choose AI Model',
  },
  // voice
  7: {
    title_ru: 'ğŸ¤ Ğ“Ğ¾Ğ»Ğ¾Ñ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€Ğ°',
    title_en: 'ğŸ¤ Avatar Voice',
  },
  // text_to_speech
  8: {
    title_ru: 'ğŸ™ï¸ Ğ¢ĞµĞºÑÑ‚ Ğ² Ğ³Ğ¾Ğ»Ğ¾Ñ',
    title_en: 'ğŸ™ï¸ Text to Voice',
  },
  // image_to_video
  9: {
    title_ru: 'ğŸ¥ Ğ¤Ğ¾Ñ‚Ğ¾ Ğ² Ğ²Ğ¸Ğ´ĞµĞ¾',
    title_en: 'ğŸ¥ Photo to Video',
  },
  // text_to_video
  10: {
    title_ru: 'ğŸ¥ Ğ’Ğ¸Ğ´ĞµĞ¾ Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ°',
    title_en: 'ğŸ¥ Text to Video',
  },
  // text_to_image
  11: {
    title_ru: 'ğŸ–¼ï¸ Ğ¢ĞµĞºÑÑ‚ Ğ² Ñ„Ğ¾Ñ‚Ğ¾',
    title_en: 'ğŸ–¼ï¸ Text to Image',
  },
  // lip_sync
  // 12: {
  //   title_ru: 'ğŸ¤ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ³ÑƒĞ±',
  //   title_en: 'ğŸ¤ Lip Sync',
  // },
  // 13: {
  //   title_ru: 'ğŸ¥ Ğ’Ğ¸Ğ´ĞµĞ¾ Ğ² URL',
  //   title_en: 'ğŸ¥ Video in URL',
  // },
  // step0
  // paymentScene
  100: {
    title_ru: 'ğŸ’ ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ',
    title_en: 'ğŸ’ Top up balance',
  },
  // balanceCommand
  101: {
    title_ru: 'ğŸ’° Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ',
    title_en: 'ğŸ’° Balance',
  },
  // inviteCommand
  102: {
    title_ru: 'ğŸ‘¥ ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ³Ğ°',
    title_en: 'ğŸ‘¥ Invite a friend',
  },
  // helpCommand
  103: {
    title_ru: 'ğŸ’¬ Ğ¢ĞµÑ…Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°',
    title_en: 'ğŸ’¬ Support',
  },
  104: {
    title_ru: 'ğŸ  Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ',
    title_en: 'ğŸ  Main menu',
  },
  105: {
    title_ru: 'ğŸ’« ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ',
    title_en: 'ğŸ’« Subscribe',
  },
}

const adminIds = process.env.ADMIN_IDS?.split(',') || []

export async function mainMenu({
  isRu,
  subscription = SubscriptionType.STARS,
  ctx,
}: {
  isRu: boolean
  subscription: SubscriptionType
  ctx: MyContext
}): Promise<Markup.Markup<ReplyKeyboardMarkup>> {
  console.log('ğŸ’» CASE: mainMenu')
  let hasFullAccess = checkFullAccess(subscription)

  // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ÑƒÑ€Ğ¾Ğ²Ğ½Ğ¸ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
  const subscriptionLevelsMap: Record<SubscriptionType, Level[]> = {
    [SubscriptionType.STARS]: [],
    [SubscriptionType.NEUROPHOTO]: [levels[1], levels[2], levels[3]],
    [SubscriptionType.NEUROBASE]: Object.values(levels), // Ğ’ÑĞµ
    [SubscriptionType.NEUROBLOGGER]: Object.values(levels), // Ğ’ÑĞµ
    [SubscriptionType.NEUROTESTER]: Object.values(levels), // Ğ’ÑĞµ
  }

  let availableLevels: Level[] = subscriptionLevelsMap[subscription] || []

  // ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ÑƒÑ€Ğ¾Ğ²Ğ½Ğ¸ Ğ´Ğ»Ñ NEUROBASE/NEUROBLOGGER/NEUROTESTER, Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ ÑĞ»ÑƒĞ¶ĞµĞ±Ğ½Ñ‹Ğµ
  const filterServiceLevels = (lvl: Level) =>
    lvl !== levels[100] &&
    lvl !== levels[101] &&
    lvl !== levels[102] &&
    lvl !== levels[103] &&
    lvl !== levels[104] &&
    lvl !== levels[105]

  if (
    subscription === SubscriptionType.NEUROTESTER ||
    subscription === SubscriptionType.NEUROBASE ||
    subscription === SubscriptionType.NEUROBLOGGER
  ) {
    hasFullAccess = true
    // Ğ”Ğ»Ñ NEUROTESTER Ğ±ĞµÑ€ĞµĞ¼ Ğ²ÑĞµ ÑƒÑ€Ğ¾Ğ²Ğ½Ğ¸ Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼
    if (subscription === SubscriptionType.NEUROTESTER) {
      availableLevels = Object.values(levels).filter(filterServiceLevels)
    } else {
      // Ğ”Ğ»Ñ NEUROBASE Ğ¸ NEUROBLOGGER Ğ±ĞµÑ€ĞµĞ¼ Ğ¸Ğ· Ğ¼Ğ°Ğ¿Ñ‹ Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼
      availableLevels =
        subscriptionLevelsMap[subscription].filter(filterServiceLevels)
    }
  } else if (subscription === SubscriptionType.STARS) {
    // Ğ”Ğ»Ñ STARS ÑƒÑ€Ğ¾Ğ²Ğ½Ğ¸ Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ (availableLevels ÑƒĞ¶Ğµ [] Ğ¸Ğ· subscriptionLevelsMap)
    availableLevels = [] // Explicitly empty for STARS
  }
  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹ ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ¹ (Ğ½Ğ° Ğ²ÑÑĞºĞ¸Ğ¹ ÑĞ»ÑƒÑ‡Ğ°Ğ¹)
  availableLevels = Array.from(new Set(availableLevels))

  // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ¹
  const levelButtons = availableLevels.map(lvl =>
    Markup.button.text(isRu ? lvl.title_ru : lvl.title_en)
  )

  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° (ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ğ¼Ğ¾)
  const userId = ctx.from?.id?.toString()
  const adminSpecificButtons = []
  if (userId && adminIds.includes(userId)) {
    adminSpecificButtons.push(
      Markup.button.text(isRu ? 'ğŸ¤– Ğ¦Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ¾Ğµ Ñ‚ĞµĞ»Ğ¾ 2' : 'ğŸ¤– Digital Body 2'),
      Markup.button.text(isRu ? 'ğŸ“¸ ĞĞµĞ¹Ñ€Ğ¾Ñ„Ğ¾Ñ‚Ğ¾ 2' : 'ğŸ“¸  NeuroPhoto 2')
    )
  }

  // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ÑĞ´Ñ‹ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ¹ Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ñ… ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº
  const allFunctionalButtons = [...levelButtons, ...adminSpecificButtons]
  const buttonRows = []
  for (let i = 0; i < allFunctionalButtons.length; i += 2) {
    buttonRows.push(allFunctionalButtons.slice(i, i + 2))
  }

  // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¸Ğ¶Ğ½Ğ¸Ğ¹ Ñ€ÑĞ´ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
  const bottomRowButtons = []
  const supportButton = Markup.button.text(
    isRu ? levels[103].title_ru : levels[103].title_en
  )

  // --- ADJUSTED LOGIC: Based only on subscription type ---
  if (subscription === SubscriptionType.STARS) {
    // Ğ¡Ğ»ÑƒÑ‡Ğ°Ğ¹: ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ±ĞµĞ· Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ (STARS)
    const subscribeButton = Markup.button.text(
      isRu ? levels[105].title_ru : levels[105].title_en
    )
    bottomRowButtons.push([subscribeButton, supportButton])
  } else {
    // Ğ¡Ğ»ÑƒÑ‡Ğ°Ğ¹: ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ (NEUROPHOTO, NEUROBASE, NEUROTESTER)
    const balanceButton = Markup.button.text(
      isRu ? levels[101].title_ru : levels[101].title_en
    )
    const topUpButton = Markup.button.text(
      isRu ? levels[100].title_ru : levels[100].title_en
    )
    const inviteButton = Markup.button.text(
      isRu ? levels[102].title_ru : levels[102].title_en
    )
    // ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº Ğ¸ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº Ğ·Ğ´ĞµÑÑŒ
    buttonRows.push([balanceButton, topUpButton]) // Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ğ¸ ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ñ€ÑĞ´
    bottomRowButtons.push([inviteButton, supportButton]) // ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ÑŒ Ğ¸ Ğ¢ĞµÑ…Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ² Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ€ÑĞ´
  }

  // ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ñ€ÑĞ´Ñ‹ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº Ğ¸ Ğ½Ğ¸Ğ¶Ğ½Ğ¸Ğ¹ Ñ€ÑĞ´
  const finalKeyboard = [...buttonRows, ...bottomRowButtons]

  return Markup.keyboard(finalKeyboard).resize()
}
