# Дорожная карта NeuroPhoto One

## Текущий статус

Модуль NeuroPhoto One находится в стабильном рабочем состоянии с несколькими ключевыми улучшениями:

- ✅ **ВЫПОЛНЕНО:** Генерация промптов с помощью OpenAI реализована с таймаутом и резервным промптом
- ✅ **ВЫПОЛНЕНО:** Интеграция с Telegram для отправки сообщений и изображений
- ✅ **ВЫПОЛНЕНО:** Базовое логирование результатов и ошибок
- ✅ **ВЫПОЛНЕНО:** Обработка ошибок при отправке сообщений в Telegram
- ✅ **ВЫПОЛНЕНО:** Добавлен таймаут для запросов к OpenAI API
- ✅ **ВЫПОЛНЕНО:** Предотвращение дублирования сообщений в Telegram при тестировании
- ✅ **ВЫПОЛНЕНО:** Сохранение результатов тестирования в лог-файлы для анализа
- ✅ **ВЫПОЛНЕНО:** Полное сквозное тестирование (end-to-end test)

## Краткосрочные задачи (1-2 недели)

- ✅ **ВЫПОЛНЕНО:** Исправление проблем с отправкой сообщений в Telegram
- ✅ **ВЫПОЛНЕНО:** Проверка наличия бота в группе и возможность отправки сообщений
- ✅ **ВЫПОЛНЕНО:** Отправка результатов в личный чат при проблемах с группой
- ✅ **ВЫПОЛНЕНО:** Улучшение обработки ошибок и стабильности теста
- ✅ **ВЫПОЛНЕНО:** Таймаут для предотвращения зависания теста
- ⬜ Оптимизация структуры промптов для лучшего качества изображений
- ⬜ Улучшение пост-обработки ответов Replicate API
- ⬜ Кэширование промптов от OpenAI для уменьшения количества запросов
- ⬜ Оптимизация процесса сохранения и отправки изображений

## Среднесрочные задачи (2-4 недели)

- ⬜ Внедрение модульных тестов для отдельных компонентов
- ⬜ Создание набора мок-объектов для тестирования без внешних зависимостей
- ⬜ Реализация автоматического создания тестового пользователя с балансом
- ⬜ Интеграция с системой CI/CD для автоматического запуска тестов
- ⬜ Добавление метрик качества изображений и производительности
- ⬜ Расширение поддержки различных аспектных соотношений и стилей

## Долгосрочные задачи (1-2 месяца)

- ⬜ Разработка системы оценки качества генерируемых изображений
- ⬜ Автоматизация А/Б тестирования различных промптов
- ⬜ Создание UI для анализа результатов тестирования
- ⬜ Интеграция с системой мониторинга и алертинга
- ⬜ Оптимизация производительности и снижение затрат на API
- ⬜ Комплексная документация и обучающие материалы

## Приоритеты

### Высокий приоритет
- ✅ **РЕШЕНО:** Исправление проблем с отправкой сообщений в Telegram
- ✅ **РЕШЕНО:** Таймаут для запросов к API, чтобы предотвратить зависание тестов
- ⬜ Создание автоматического тестового пользователя с балансом
- ⬜ Оптимизация промптов для улучшения качества изображений

### Средний приоритет
- ⬜ Модульные тесты для отдельных компонентов
- ⬜ Кэширование промптов
- ⬜ Улучшенная система логирования и мониторинга
- ⬜ Интеграция с CI/CD

### Низкий приоритет
- ⬜ UI для анализа результатов
- ⬜ А/Б тестирование промптов
- ⬜ Документация и обучающие материалы

## Текущие проблемы и решения

### 1. Проблема: Ошибки при отправке сообщений в Telegram
**Решение:** ✅ Добавлена проверка `disable_telegram_sending` для предотвращения отправки сообщений в тестовом режиме. Улучшена обработка ошибок при отправке сообщений.

### 2. Проблема: Таймауты при запросах к OpenAI API
**Решение:** ✅ Добавлен таймаут 30 секунд для функции `generateGptPrompt` с возвратом резервного промпта при таймауте.

### 3. Проблема: Нет тестового пользователя в базе данных
**Решение:** ⬜ Требуется создание механизма автоматического создания тестового пользователя с необходимым балансом для тестирования.

### 4. Проблема: Качество генерируемых изображений не всегда оптимально
**Решение:** ⬜ Оптимизировать структуру промптов и параметры генерации на основе анализа результатов.

## Технический долг

1. Отсутствие модульных тестов для отдельных компонентов
2. Отсутствие мок-объектов для внешних зависимостей
3. Жесткая зависимость от внешних API (OpenAI, Replicate) без локальных альтернатив
4. Использование жестко закодированных значений в некоторых местах
5. Отсутствие кэширования для дорогостоящих API-запросов

## План реализации

1. **Текущая неделя:**
   - ✅ Исправление проблем с таймаутами при запросах к API
   - ✅ Улучшение обработки ошибок при отправке сообщений в Telegram
   - ⬜ Оптимизация промптов для улучшения качества изображений

2. **Следующая неделя:**
   - ⬜ Создание механизма автоматического создания тестового пользователя
   - ⬜ Начало работы над модульными тестами
   - ⬜ Реализация кэширования промптов

3. **Через 2-3 недели:**
   - ⬜ Завершение модульных тестов
   - ⬜ Интеграция с CI/CD
   - ⬜ Улучшение системы логирования и мониторинга

## Необходимые ресурсы

- API ключи OpenAI и Replicate
- Доступ к тестовому Telegram боту с возможностью отправки сообщений
- Тестовый пользователь в базе данных с достаточным балансом
- Среда CI/CD для автоматизации тестирования

## Метрики успеха

- Стабильная генерация изображений в 95%+ случаев
- Время выполнения теста менее 2 минут
- Качество изображений соответствует требованиям (оценка пользователей)
- Полное автоматическое тестирование в CI/CD

## История изменений

- **2025-04-14**: 
  - Добавлен параметр `options` с опцией `disable_telegram_sending` в функцию `generateNeuroPhotoDirect`
  - Добавлен таймаут 30 секунд для функции `generateGptPrompt`
  - Улучшена обработка ошибок во всем коде
  - Успешно выполнен полный тест генерации изображения и отправки в Telegram

- **2025-04-13**: 
  - Добавлено базовое логирование результатов
  - Улучшено сохранение генерируемых изображений

- **2025-04-12**:
  - Создан начальный прототип теста
  - Реализована интеграция с OpenAI и Replicate API 