---
description: 
globs: 
alwaysApply: false
---
# Pattern Management Rules üéØ

## Pattern Detection üîç

1. Monitoring Criteria
   - –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–π—Å—è –∫–æ–¥ –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö
   - –ü–æ—Ö–æ–∂–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
   - –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã
   - –°—Ö–æ–∂–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

2. –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ üö®
   - 3+ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω–∞
   - 2+ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–æ—Ö–æ–∂–∏–π –ø–æ–¥—Ö–æ–¥
   - –ß–∞—Å—Ç—ã–µ –∫–æ–ø–∏–ø–∞—Å—Ç—ã –∫–æ–¥–∞
   - –ü–æ—Ö–æ–∂–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

## Pattern Documentation üìù

1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–ø–∏—Å–∞–Ω–∏—è
   ```markdown
   ### Pattern Name üìå
   - –û–ø–∏—Å–∞–Ω–∏–µ: –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
   - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
   - –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞: –ü–æ—á–µ–º—É —ç—Ç–æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –ø–æ–ª–µ–∑–µ–Ω
   - –ü—Ä–∏–º–µ—Ä—ã: –ö–æ–¥ –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
   - –î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: YYYY-MM-DD
   ```

2. –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
   - üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ
   - üîß –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ
   - üì¶ –ö–æ–¥–æ–≤—ã–µ
   - üîÑ –ü—Ä–æ—Ü–µ—Å—Å–Ω—ã–µ
   - üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ

## Update Process üîÑ

1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - –†–µ–≥—É–ª—è—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ PR
   - –û–±–∑–æ—Ä –Ω–æ–≤—ã—Ö —Ñ–∏—á
   - –ê–Ω–∞–ª–∏–∑ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
   - –û—Ç–∑—ã–≤—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

2. –ü—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
   - –°–æ–∑–¥–∞–Ω–∏–µ PR —Å –Ω–æ–≤—ã–º –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º
   - –û–±—Å—É–∂–¥–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–æ–π
   - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ rules
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞

## Current Patterns üìö

### Payment Processing Pattern üí∞
- –û–ø–∏—Å–∞–Ω–∏–µ: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ Inngest
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–ª–∞–Ω—Å–æ–º
- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞: 
  - –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
  - Retry –º–µ—Ö–∞–Ω–∏–∑–º
  - –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–∏–º–µ—Ä:
  ```typescript
  await inngest.send({
    name: 'payment/process',
    data: {
      amount: cost,
      telegram_id: string,
      type: string,
      description: string,
      bot_name: string
    }
  })
  ```
- –î–∞—Ç–∞: 2024-03-31

### Bot Command Registration Pattern ü§ñ
- –û–ø–∏—Å–∞–Ω–∏–µ: –ï–¥–∏–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –í—Å–µ Telegram –±–æ—Ç—ã
- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
  - –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π UX
  - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  - –õ–µ–≥–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü—Ä–∏–º–µ—Ä:
  ```typescript
  await bot.telegram.setMyCommands([
    {
      command: 'start',
      description: 'üë§ Start / –ù–∞—á–∞—Ç—å'
    }
  ], {
    scope: {
      type: 'all_private_chats'
    }
  })
  ```
- –î–∞—Ç–∞: 2024-03-31

### Logging Pattern üìä
- –û–ø–∏—Å–∞–Ω–∏–µ: –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —ç–º–æ–¥–∑–∏
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –í–µ—Å—å –ø—Ä–æ–µ–∫—Ç
- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
  - –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
  - –õ–µ–≥–∫–∏–π –ø–æ–∏—Å–∫
  - –ù–∞–≥–ª—è–¥–Ω–æ—Å—Ç—å
- –ü—Ä–∏–º–µ—Ä:
  ```typescript
  console.log('‚úÖ –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:', {
    description: 'Bot commands set successfully',
    botName
  })
  ```
- –î–∞—Ç–∞: 2024-03-31

### SSE Communication Pattern üîÑ
- –û–ø–∏—Å–∞–Ω–∏–µ: –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ Server-Sent Events
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –í—Å–µ real-time –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
  - –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
  - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π ping/pong
- –ü—Ä–∏–º–µ—Ä:
  ```typescript
  DEBUG:sse_starlette.sse:ping: b': ping - [timestamp]\r\n\r\n'
  ```
- –î–∞—Ç–∞: 2024-03-31

### MCP Server Launch Pattern üöÄ
- –û–ø–∏—Å–∞–Ω–∏–µ: –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ MCP —Å–µ—Ä–≤–µ—Ä–æ–≤ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –í—Å–µ MCP —Å–µ—Ä–≤–∏—Å—ã
- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
  - –ï–¥–∏–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –∑–∞–ø—É—Å–∫—É
  - –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
  - –ß–µ—Ç–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –ü—Ä–∏–º–µ—Ä:
  ```bash
  ALLOWED_DIR="/Users/playra/999-multibots-telegraf" \
  ALLOWED_COMMANDS="ls,cat,pwd,echo,docker,git" \
  ALLOWED_FLAGS="all" \
  MAX_COMMAND_LENGTH="1024" \
  COMMAND_TIMEOUT="60" \
  uvx cli-mcp-server
  ```
- –î–∞—Ç–∞: 2024-03-31

## Pattern Review Schedule üìÖ

1. –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ
   - –ê–Ω–∞–ª–∏–∑ –Ω–æ–≤—ã—Ö PR
   - –ü–æ–∏—Å–∫ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

2. –ï–∂–µ–º–µ—Å—è—á–Ω–æ
   - –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
   - –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö

## Action Items on Pattern Detection üìã

1. –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞:
   - –°–æ–∑–¥–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –≤ patterns.mdc
   - –û–±–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
   - –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥
   - –î–æ–±–∞–≤–∏—Ç—å –≤ CI –ø—Ä–æ–≤–µ—Ä–∫–∏

2. –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ:
   - –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
   - –°–æ–∑–¥–∞—Ç—å PR —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
   - –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã
   - –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã 

# MCP Servers Configuration üñ•Ô∏è

## CLI MCP Server
- ALLOWED_DIR="/Users/playra/999-multibots-telegraf"
- ALLOWED_COMMANDS="ls,cat,pwd,echo,docker,git,which,systemctl,service,ps,netstat"
- ALLOWED_FLAGS="all"
- MAX_COMMAND_LENGTH="1024"
- COMMAND_TIMEOUT="60"

## Git MCP Server
- Repository: https://github.com/gHashTag/999-multibots-telegraf.git
- Version: git version 2.48.1
- Note: GIT_DEFAULT_PATH not set - absolute paths required

## Browser Tools MCP
- Version: @agentdeskai/browser-tools-mcp@1.0.11

## Docker MCP
- Command: uvx docker-mcp
- Purpose: Docker container management

## Apify MCP Server
- Actor: reezuan/send-http-requests
- Token required: APIFY_TOKEN

## Postgres MCP Server
- Connection: postgresql://postgres.yuukfqcsdhkyxegfwlcb:...@aws-0-eu-central-2.pooler.supabase.com:5432/postgres

## Remotion MCP
- Purpose: Video rendering and processing 

# Bot Structure Rules ü§ñ

## Core Components

1. Commands üìù
   - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ `registerCommands.ts`
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ `setCommands.ts`
   - –û—Ç–¥–µ–ª—å–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
   - –¢–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã

2. Scenes üé¨
   - –û—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ü–µ–Ω—ã
   - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (enter, leave, handlers)
   - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - –¢–µ—Å—Ç—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

3. Services üõ†
   - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ core/[service-name]
   - –¢–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
   - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

4. Inngest Functions ‚ö°
   - –û—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
   - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
   - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
   - –¢–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

## Testing Strategy

1. Unit Tests
   - –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
   - –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ü–µ–Ω—ã
   - –î–ª—è —É—Ç–∏–ª–∏—Ç

2. Integration Tests
   - –î–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –∫–æ–º–∞–Ω–¥
   - –î–ª—è –ø–æ–ª–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
   - –î–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

3. E2E Tests
   - –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—É—Ç–µ–π
   - –î–ª—è –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ 

## MCP Integration Monitoring üîå

1. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏:
   - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥
   - –ò–∑–æ–ª—è—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏–π
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

2. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:
   - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π:
     * CLI –∫–æ–º–∞–Ω–¥—ã
     * Docker –æ–ø–µ—Ä–∞—Ü–∏–∏
     * Git –æ–ø–µ—Ä–∞—Ü–∏–∏
   - –í—ã—Å–æ–∫–∏–π:
     * Browser tools
     * Database –æ–ø–µ—Ä–∞—Ü–∏–∏
   - –°—Ä–µ–¥–Ω–∏–π:
     * Apify –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
     * Remotion —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥

## AI Service Monitoring ü§ñ

1. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏:
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API
   - Retry —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–∫–µ–Ω–æ–≤

2. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:
   - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π:
     * OpenAI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
     * ElevenLabs –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
   - –í—ã—Å–æ–∫–∏–π:
     * Replicate –º–æ–¥–µ–ª–∏
     * SyncLabs –æ–ø–µ—Ä–∞—Ü–∏–∏
   - –°—Ä–µ–¥–Ω–∏–π:
     * –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
     * –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã 