---
description: 
globs: 
alwaysApply: true
---
# ๐๏ธ ะขะตะบััะฐั ะะฐะดะฐัะฐ: ะะตะนัะพะะพะดะตั - ะะปะฐะฝ ะขะตััะธัะพะฒะฐะฝะธั ๐งโโ๏ธ

**ะัะธะฝัะธะฟ:** ะะฐะบ ะปะพัะพั ัะฐัะบััะฒะฐะตััั ะปะตะฟะตััะพะบ ะทะฐ ะปะตะฟะตััะบะพะผ, ัะฐะบ ะธ ะผั ะฑัะดะตะผ ะฟะพะบััะฒะฐัั ะบะพะด ัะตััะฐะผะธ, ัะปะตะดัั ะตััะตััะฒะตะฝะฝะพะผั ะฟััะธ ะฟะพะปัะทะพะฒะฐัะตะปั (User Flow), ะพั ะบะพัะฝะตะน ะบ ัะฒะตัะฐะผ.

**ะฆะตะปั:** ะะพะฑะธัััั ๐ฏ% ะฟะพะบัััะธั ะบะพะดะฐ ัะตััะฐะผะธ ะดะปั ะดะธัะตะบัะพัะธะธ `src` ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ **Vitest**, ัะปะตะดัั ะฟัะธะฝัะธะฟะฐะผ TDD (๐ด -> โ -> โป๏ธ).

**ะะฝััััะผะตะฝัั:** Vitest, `@vitest/ui` (ะดะปั ะธะฝัะตัะฐะบัะธะฒะฝะพะณะพ ะฟัะพัะผะพััะฐ: `pnpm test:ui`), `vi.mock` / `ts-mockito` (ะดะปั ะผะพะบะธัะพะฒะฐะฝะธั).

**ะะตะณะตะฝะดะฐ ะกัะฐัััะพะฒ:**
*   โ - ะะฐะฒะตััะตะฝะพ
*   โณ - ะ ะะฐะฑะพัะต
*   โ - ะะปะพะบะธัะพะฒะฐะฝะพ / ะัะธะฑะบะฐ
*   ๐ - ะะฐะฟะปะฐะฝะธัะพะฒะฐะฝะพ

---

## ๐บ๏ธ ะัะธะพัะธัะตะทะธัะพะฒะฐะฝะฝัะน ะะปะฐะฝ ะขะตััะธัะพะฒะฐะฝะธั (User Flow)

### P0: ะัะฝะพะฒั - ะัะพะด ะธ ะะตะณะธัััะฐัะธั (ะััะพัะฐะนัะธะน ะัะธะพัะธัะตั) ๐ฅ
*   **ะกัะฐััั:** โณ
*   **ะฆะตะปั:** ะฃะฑะตะดะธัััั, ััะพ ะฝะพะฒัะน ะธ ัััะตััะฒัััะธะน ะฟะพะปัะทะพะฒะฐัะตะปั ะผะพะถะตั ะฒะพะนัะธ ะฒ ัะธััะตะผั.
*   **User Flow:** `/start` -> `startScene`
*   **ะะปััะตะฒัะต ะะพะดัะปะธ/ะคะฐะนะปั:**
    *   ๐ `src/registerCommands.ts` (ัะตะณะธัััะฐัะธั `/start`)
    *   โณ `src/scenes/startScene/index.ts` (ะปะพะณะธะบะฐ ััะตะฝั)
    *   ๐ `src/core/supabase/user.ts` (`createUser`)
    *   ๐ `src/core/supabase/getUserDetailsSubscription.ts` (ะฟัะพะฒะตัะบะฐ ัััะตััะฒะพะฒะฐะฝะธั)
    *   ๐ `src/core/supabase/referral.ts` (ะฑะฐะทะพะฒะฐั ะฟัะพะฒะตัะบะฐ ัะตัะตัะฐะปะพะฒ)
    *   ๐ `src/utils/localization.ts` (`getTranslation`)
    *   ๐ `src/menu/index.ts` (`startMenu`)
    *   ๐ `src/menu/mainMenu.ts` (`levels` ะดะปั ัััะพัะธะฐะปะฐ)
    *   ๐ `src/helpers/language.ts` (`isRussian`)

### P1: ะะฐะฒะธะณะฐัะธั - ะะปะฐะฒะฝะพะต ะะตะฝั (ะััะพะบะธะน ะัะธะพัะธัะตั) ๐งญ
*   **ะกัะฐััั:** ๐
*   **ะฆะตะปั:** ะัะพะฒะตัะธัั ะบะพััะตะบัะฝัั ัะฐะฑะพัั ะณะปะฐะฒะฝะพะณะพ ะผะตะฝั ะธ ะดะพัััะฟ ะบ ะพัะฝะพะฒะฝัะผ ัะฐะทะดะตะปะฐะผ.
*   **User Flow:** `/menu` (ะธะปะธ ะบะฝะพะฟะบะฐ "ะะปะฐะฒะฝะพะต ะะตะฝั") -> `menuScene` -> ะัะพะฑัะฐะถะตะฝะธะต ะบะฝะพะฟะพะบ -> ะะฐะถะฐัะธะต ะบะฝะพะฟะบะธ -> ะะตัะตัะพะด ะฒ ะดััะณัั ััะตะฝั/ะบะพะผะฐะฝะดั.
*   **ะะปััะตะฒัะต ะะพะดัะปะธ/ะคะฐะนะปั:**
    *   ๐ `src/registerCommands.ts` (ัะตะณะธัััะฐัะธั `/menu`, ะณะปะพะฑะฐะปัะฝัะต `hears`/`action`)
    *   ๐ `src/scenes/menuScene/index.ts`
    *   ๐ `src/menu/mainMenu.ts` (ะณะตะฝะตัะฐัะธั ะบะปะฐะฒะธะฐัััั)
    *   ๐ `src/core/supabase/getUserDetailsSubscription.ts` (ะพะฟัะตะดะตะปะตะฝะธะต ะฟะพะดะฟะธัะบะธ ะดะปั ะผะตะฝั)
    *   ๐ `src/utils/localization.ts` (`getTranslation`)

### P2: ะัะฝะพะฒะฝะพะน ะคัะฝะบัะธะพะฝะฐะป - ะะตะฝะตัะฐัะธั ะะพะฝัะตะฝัะฐ (ะกัะตะดะฝะธะน ะัะธะพัะธัะตั) โจ
*   **ะกัะฐััั:** ๐
*   **ะฆะตะปั:** ะัะพัะตััะธัะพะฒะฐััๆธๅฟ ััะฝะบัะธะธ ะฑะพัะฐ: ะณะตะฝะตัะฐัะธั ะธะทะพะฑัะฐะถะตะฝะธะน ะธ ะฒะธะดะตะพ.
*   **User Flow (ะัะธะผะตั ะดะปั Video):** ะะฝะพะฟะบะฐ "Video" -> ะัะฑะพั ะผะพะดะตะปะธ (`imageToVideoWizard` / `textToVideoWizard`) -> ะัะพะฒะตัะบะฐ ะฑะฐะปะฐะฝัะฐ -> ะะฒะพะด ะฟัะพะผะฟัะฐ/ะทะฐะณััะทะบะฐ ัะพัะพ -> ะัะฟัะฐะฒะบะฐ ะทะฐะฟัะพัะฐ ะฝะฐ ะฑัะบะตะฝะด (`api-server`) -> (ะัะธะฝััะพะฝะฝะพ) ะะพะปััะตะฝะธะต ัะตะทัะปััะฐัะฐ ัะตัะตะท webhook -> ะฃะฒะตะดะพะผะปะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั.
*   **ะะปััะตะฒัะต ะะพะดัะปะธ/ะคะฐะนะปั:**
    *   **ะกัะตะฝั:**
        *   ๐ `src/scenes/imageToVideoWizard/index.ts`
        *   ๐ `src/scenes/textToVideoWizard/index.ts`
        *   ๐ `src/scenes/neuroPhotoWizard/index.ts` (ะดะปั ัะพัะพ)
    *   **ะะพะณะธะบะฐ:**
        *   ๐ `src/price/helpers/calculateFinalPrice.ts`
        *   ๐ `src/price/constants/index.ts`
        *   ๐ `src/config/models.config.ts`
        *   ๐ `src/core/supabase/getUserBalance.ts`
        *   ๐ `src/core/bot/index.ts` (ะฒัะทะพะฒ API ัะตัะฒะตัะฐ)
    *   **ะะตะฝั:**
        *   ๐ `src/menu/videoModelMenu.ts`
        *   ๐ `src/menu/imageModelMenu.ts`
    *   **API ะกะตัะฒะตั (`api-server`):**
        *   ๐ ะญะฝะดะฟะพะธะฝัั ะณะตะฝะตัะฐัะธะธ (`/api/generate/*`)
        *   ๐ ะญะฝะดะฟะพะธะฝั ะฒะตะฑััะบะฐ Replicate (`/api/replicate-webhook`)
        *   ๐ ะะพะณะธะบะฐ ะฒะทะฐะธะผะพะดะตะนััะฒะธั ั Replicate API.
        *   ๐ ะะตัะฐะฝะธะทะผ ัะฒะตะดะพะผะปะตะฝะธั ะพัะฝะพะฒะฝะพะณะพ ะฑะพัะฐ.

### P3: ะะพะฝะตัะธะทะฐัะธั - ะะฟะปะฐัะฐ ะธ ะะพะดะฟะธัะบะธ (ะกัะตะดะฝะธะน ะัะธะพัะธัะตั) ๐ณ
*   **ะกัะฐััั:** ๐
*   **ะฆะตะปั:** ะะฑะตัะฟะตัะธัั ะบะพััะตะบัะฝัั ัะฐะฑะพัั ะฟะพะบัะฟะบะธ ะฟะพะดะฟะธัะพะบ ะธ ะฟะพะฟะพะปะฝะตะฝะธั ะฑะฐะปะฐะฝัะฐ.
*   **User Flow:** ะะฝะพะฟะบะฐ "ะัะพัะผะธัั ะฟะพะดะฟะธัะบั" -> `paymentScene` -> ะัะฑะพั ะผะตัะพะดะฐ -> `starPaymentScene`/`rublePaymentScene` -> ะะฑัะฐะฑะพัะบะฐ ะฟะปะฐัะตะถะฐ -> ะะฑะฝะพะฒะปะตะฝะธะต `payments_v2` -> ะัะพะฒะตัะบะฐ ััะฐัััะฐ.
*   **ะะปััะตะฒัะต ะะพะดัะปะธ/ะคะฐะนะปั:**
    *   **ะกัะตะฝั:**
        *   ๐ `src/scenes/paymentScene/index.ts`
        *   ๐ `src/scenes/starPaymentScene/index.ts`
        *   ๐ `src/scenes/rublePaymentScene/index.ts`
    *   **ะะฑัะฐะฑะพััะธะบะธ:**
        *   ๐ `src/handlers/paymentHandlers/index.ts` (`handleSuccessfulPayment` ะดะปั TG Stars)
    *   **ะะฐะทะฐ ะะฐะฝะฝัั ะธ ะะพะณะธะบะฐ:**
        *   ๐ `src/core/supabase/payments.ts` (ััะฝะบัะธะธ ะดะปั ัะฐะฑะพัั ั `payments_v2`)
        *   ๐ `src/core/supabase/getUserDetailsSubscription.ts`
        *   ๐ `src/core/supabase/getUserBalance.ts`
        *   ๐ SQL ััะฝะบัะธะธ (`get_user_balance`, `create_system_payment`)
    *   **API ะกะตัะฒะตั (`api-server`):**
        *   ๐ ะญะฝะดะฟะพะธะฝั Robokassa (`/api/robokassa-result`)
        *   ๐ ะะฐะณะปััะบะธ/ัะตะฐะปะธะทะฐัะธั `updateUserBalance`, `updateUserSubscription`.

### P4: ะัะฟะพะผะพะณะฐัะตะปัะฝัะต ะคัะฝะบัะธะธ (ะะธะทะบะธะน ะัะธะพัะธัะตั) ๐๏ธ
*   **ะกัะฐััั:** ๐
*   **ะฆะตะปั:** ะัะพัะตััะธัะพะฒะฐัั ััะฝะบัะธะธ ะฟะพะดะดะตัะถะบะธ, ะฑะฐะปะฐะฝัะฐ ะธ ัะตัะตัะฐะปัะฝะพะน ัะธััะตะผั.
*   **User Flow:** `/balance`, `/help`, `/support`, `/referral` -> ะกะพะพัะฒะตัััะฒัััะธะต ััะตะฝั/ะพะฑัะฐะฑะพััะธะบะธ.
*   **ะะปััะตะฒัะต ะะพะดัะปะธ/ะคะฐะนะปั:**
    *   ๐ `src/scenes/balanceScene/index.ts`
    *   ๐ `src/scenes/helpScene/index.ts`
    *   ๐ `src/commands/support.command.ts`
    *   ๐ `src/commands/referral.command.ts`
    *   ๐ `src/core/supabase/referral.ts`

### P5: ะะดะผะธะฝ-ะคัะฝะบัะธะธ (ะกะฐะผัะน ะะธะทะบะธะน ะัะธะพัะธัะตั) ๐
*   **ะกัะฐััั:** ๐
*   **ะฆะตะปั:** ะัะพัะตััะธัะพะฒะฐัั ะบะพะผะฐะฝะดั, ะดะพัััะฟะฝัะต ัะพะปัะบะพ ะฐะดะผะธะฝะธัััะฐัะพัะฐะผ.
*   **ะะปััะตะฒัะต ะะพะดัะปะธ/ะคะฐะนะปั:**
    *   ๐ `src/commands/admin/*`
    *   ๐ `src/core/middlewares/admin.middleware.ts`

---

**ะกะปะตะดัััะธะน ะจะฐะณ:** ะะฐัะฐัั ัะตะฐะปะธะทะฐัะธั ัะตััะพะฒ ะดะปั **P0: ะัะฝะพะฒั - ะัะพะด ะธ ะะตะณะธัััะฐัะธั** (โณ), ัะพะบััะธััััั ะฝะฐ `startScene`.
