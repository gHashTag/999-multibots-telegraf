---
description: –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏ –≥–ª–∞–≤–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ –æ–ø–ª–∞—Ç–∞–º –ø–æ–¥–ø–∏—Å–∫–∞–º 
globs: 
alwaysApply: false
---
# üïâÔ∏è –ï–¥–∏–Ω—ã–π –ú–∞–Ω—É—Å–∫—Ä–∏–ø—Ç: –ü–ª–∞—Ç–µ–∂–∏ –∏ –ü–æ–¥–ø–∏—Å–∫–∏ üí≥‚ú®

**–ü—Ä–∏–Ω—Ü–∏–ø:** –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç ‚Äì –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã (`Single Source of Truth`) –¥–ª—è –≤—Å–µ–π –ª–æ–≥–∏–∫–∏, –ø—Ä–∞–≤–∏–ª –∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏, –ø–æ–¥–ø–∏—Å–∫–∞–º–∏, –±–∞–ª–∞–Ω—Å–æ–º (–∑–≤–µ–∑–¥–∞–º–∏ ‚≠ê) –∏ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º –≤ –ø—Ä–æ–µ–∫—Ç–µ. –í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ —ç—Ç—É —Ç–µ–º—É (`payments-subscriptions-logic.mdc`, `price-calculation-consistency.mdc`, `manual-payment-credit.mdc`, `PAYMENTS_README.md` –∏ —Ç.–¥.) —Å—á–∏—Ç–∞—é—Ç—Å—è **—É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏** –∏ –¥–æ–ª–∂–Ω—ã —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ —ç—Ç–æ—Ç –º–∞–Ω—É—Å–∫—Ä–∏–ø—Ç.

**–î–∞—Ç–∞ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è:** {current_date}

## 1. üèõÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ò—Å—Ç–æ—á–Ω–∏–∫ –ò—Å—Ç–∏–Ω—ã

*   **–ï–¥–∏–Ω—ã–π –ò—Å—Ç–æ—á–Ω–∏–∫:** –¢–∞–±–ª–∏—Ü–∞ Supabase `payments_v2` —è–≤–ª—è–µ—Ç—Å—è **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã** –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
*   **–¢–∞–±–ª–∏—Ü–∞ `users`:** **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏, –±–∞–ª–∞–Ω—Å–∞ –∏–ª–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞—Ç. –°–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ `telegram_id`, `username`, `bot_name` –∏ —Ç.–¥.
*   **–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ë—ç–∫–µ–Ω–¥—É (`api-server`):** –û–±—Ä–∞–±–æ—Ç–∫–∞ **–≤–Ω–µ—à–Ω–∏—Ö** —Å–æ–±—ã—Ç–∏–π, —Ç—Ä–µ–±—É—é—â–∏—Ö —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π –∏–ª–∏ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–µ–±—Ö—É–∫–∏ Robokassa Result URL), –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–µ—Ä–≤–∏—Å–µ `api-server` ([src/api-server](mdc:src/api-server)). –≠—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ –≤ `payments_v2` –∏, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ API –±–æ—Ç–∞. URL –±—ç–∫–µ–Ω–¥–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≤ `src/config/index.ts` (`API_URL`).
*   **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ë–æ—Ç–∞:** –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∏–Ω–∏—Ü–∏–∞—Ü–∏—é –ø–ª–∞—Ç–µ–∂–∞ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ Robokassa, –≤—ã–∑–æ–≤ `replyWithInvoice` –¥–ª—è Stars), —Å–æ–∑–¥–∞–Ω–∏–µ PENDING –∑–∞–ø–∏—Å–∏ –≤ `payments_v2`, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø–æ–ª—É—á–µ–Ω–Ω–æ–π –∏–∑ `payments_v2`.

## 2. ‚öñÔ∏è –¢–∞–±–ª–∏—Ü–∞ `payments_v2`: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ü–æ–ª–µ–π

| –ü–æ–ª–µ                | –¢–∏–ø (–ë–î)                    | –û–ø–∏—Å–∞–Ω–∏–µ                                                                                                                                                              | –ü—Ä–∏–º–µ—Ä                  | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è                                      |
| :------------------ | :-------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------- | :---------------------------------------------- |
| `id`                | `uuid`                      | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ (PK)                                                                                                                                    |                         | –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ                               |
| `inv_id`            | `text`                      | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏–Ω–≤–æ–π—Å–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å ID Robokassa –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π ID). **–î–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º**.                                                                             | `'431838'`, `'manual-fix...'` | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–≤—è–∑–∏ –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–µ–π   |
| `telegram_id`       | `text`                      | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram.                                                                                                                                             | `'144022504'`           | –°–≤—è–∑—å —Å `users.telegram_id`                   |
| `bot_name`          | `text`                      | –ò–º—è –±–æ—Ç–∞ (`botInfo.username`), —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –ø—Ä–æ—à–ª–∞ –æ–ø–µ—Ä–∞—Ü–∏—è.                                                                                                        | `'ai_koshey_bot'`       |                                                 |
| `amount`            | `numeric`                   | –°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –≤–∞–ª—é—Ç–µ (RUB).                                                                                                                                 | `2999.00`               | –í—Å–µ–≥–¥–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ                            |
| `stars`             | `integer`                   | –≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç —Å—É–º–º—ã –≤ –∑–≤–µ–∑–¥–∞—Ö ‚≠ê.                                                                                                                                         | `1303`                  | –í—Å–µ–≥–¥–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ                            |
| `currency`          | `text`                      | –ö–æ–¥ –≤–∞–ª—é—Ç—ã (`'RUB'`, `'XTR'`).                                                                                                                                        | `'RUB'`                 | Enum `Currency` –≤ –∫–æ–¥–µ                          |
| `status`            | `payment_status` (enum)     | –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ (`PENDING`, `COMPLETED`, `FAILED`, `CANCELLED`).                                                                                                         | `'COMPLETED'`           | Enum `PaymentStatus` –≤ –∫–æ–¥–µ                     |
| `type`              | `operation_type` (enum)     | **–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏. –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –¢–û–õ–¨–ö–û `MONEY_INCOME` –∏–ª–∏ `MONEY_OUTCOME`.**                                                                                             | `'MONEY_INCOME'`        | **–ö–õ–Æ–ß–ï–í–û–ï –ü–†–ê–í–ò–õ–û!** –°–º. —Ä–∞–∑–¥–µ–ª 3.             |
| `payment_method`    | `text`                      | –ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã (`'Robokassa'`, `'Telegram'`, `'Manual'`, `'System'`).                                                                                                   | `'Robokassa'`           |                                                 |
| `description`       | `text`                      | –û–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.                                                                                                                                                      | `'–ü–æ–∫—É–ø–∫–∞ NEUROBASE'`   |                                                 |
| `metadata`          | `jsonb`                     | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (nullable).                                                                                                                                       | `{"reason": "manual..."}` |                                                 |
| `created_at`        | `timestamp with time zone`  | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏.                                                                                                                                                |                         | –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ                            |
| `updated_at`        | `timestamp with time zone`  | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏.                                                                                                                                     |                         | –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ                              |
| `subscription_type` | `text`                      | **–¢–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ (`NEUROPHOTO`, `NEUROBASE`...), –µ—Å–ª–∏ `type=MONEY_INCOME` —Å–≤—è–∑–∞–Ω —Å –Ω–µ–π.**                                                                              | `'NEUROBASE'`           | `NULL` –¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤ (`MONEY_OUTCOME`) –∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π |
| `service_type`      | `text`                      | **–¢–∏–ø —É—Å–ª—É–≥–∏ (–∏–∑ `ModeEnum`), –µ—Å–ª–∏ `type=MONEY_OUTCOME`.** (`IMAGE_GENERATION`...)                                                                                    | `'IMAGE_GENERATION'`    | `NULL` –¥–ª—è –¥–æ—Ö–æ–¥–æ–≤ (`MONEY_INCOME`)             |
| `payment_date`      | `timestamp with time zone`  | –î–∞—Ç–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ (nullable).                                                                                                                        |                         | –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ `status = 'COMPLETED'`          |

**Enums:**
*   `payment_status` (–ë–î –∏ –ö–æ–¥): `PENDING`, `COMPLETED`, `FAILED`, `CANCELLED`.
*   `operation_type` (–ë–î) / `PaymentType` (–ö–æ–¥): **–†–∞–∑—Ä–µ—à–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û `MONEY_INCOME` –∏ `MONEY_OUTCOME`.** –í –∫–æ–¥–µ `PaymentType` –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —ç—Ç–∏ –¥–≤–∞ + `REFUND`. *–í–∞–∂–Ω–æ: SQL-—Ñ—É–Ω–∫—Ü–∏—è `get_user_balance` –¥–æ–ª–∂–Ω–∞ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è `operation_type`, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –æ—Å—Ç–∞—Ç—å—Å—è –≤ –ë–î –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏.*

## 3. üìú –ö–ª—é—á–µ–≤–æ–µ –ü—Ä–∞–≤–∏–ª–æ: –¢–∏–ø—ã –û–ø–µ—Ä–∞—Ü–∏–π (`type`)

*   **–î–æ—Ö–æ–¥ (`MONEY_INCOME`):** –õ—é–±–æ–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∏–ª–∏ –∑–≤–µ–∑–¥ –Ω–∞ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞** (–ø–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏, –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞, –±–æ–Ω—É—Å, —Å–∏—Å—Ç–µ–º–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ, —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ) **–î–û–õ–ñ–ù–û** –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è —Å `type = 'MONEY_INCOME'`.
*   **–†–∞—Å—Ö–æ–¥ (`MONEY_OUTCOME`):** –õ—é–±–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∏–ª–∏ –∑–≤–µ–∑–¥ —Å –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ **–î–û–õ–ñ–ù–û** –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è —Å `type = 'MONEY_OUTCOME'`.
*   **–†–∞–∑–ª–∏—á–µ–Ω–∏–µ –î–æ—Ö–æ–¥–∞:**
    *   –ü–æ–∫—É–ø–∫–∞/–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏: `type = 'MONEY_INCOME'`, `subscription_type` = `'NEUROBASE'` (–∏–ª–∏ –¥—Ä—É–≥–æ–π —Ç–∏–ø).
    *   –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞: `type = 'MONEY_INCOME'`, `subscription_type` = `NULL`.
    *   –ë–æ–Ω—É—Å/–°–∏—Å—Ç–µ–º–Ω–æ–µ/–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ: `type = 'MONEY_INCOME'`, `subscription_type` = `NULL`, `payment_method` = `'Bonus'` / `'System'` / `'Referral'`.
*   **–†–∞–∑–ª–∏—á–µ–Ω–∏–µ –†–∞—Å—Ö–æ–¥–∞:**
    *   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞: `type = 'MONEY_OUTCOME'`, `service_type` = `'IMAGE_GENERATION'` (–∏–ª–∏ –¥—Ä—É–≥–æ–π `ModeEnum`).
*   **–í–æ–∑–≤—Ä–∞—Ç—ã (`REFUND`):** –¢–∏–ø `REFUND` –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –∫–æ–¥–µ `PaymentType`, –Ω–æ –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ SQL `get_user_balance` —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ (–¥–æ–ª–∂–µ–Ω –ª–∏ –æ–Ω —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –±–∞–ª–∞–Ω—Å?). –ï—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ, –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –∏ –∏–∑ –∫–æ–¥–∞.

## 4. ‚öôÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –§—É–Ω–∫—Ü–∏–∏ –∏ –õ–æ–≥–∏–∫–∞

*   **`getUserBalance(telegram_id)`:** ([src/core/supabase/getUserBalance.ts](mdc:src/core/supabase/getUserBalance.ts))
    *   –í—ã–∑—ã–≤–∞–µ—Ç SQL-—Ñ—É–Ω–∫—Ü–∏—é `get_user_balance(user_telegram_id TEXT)`.
    *   SQL-—Ñ—É–Ω–∫—Ü–∏—è **–î–û–õ–ñ–ù–ê** —Å—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å –∫–∞–∫ `SUM(CASE WHEN type = 'MONEY_INCOME' THEN stars ELSE 0 END) - SUM(CASE WHEN type = 'MONEY_OUTCOME' THEN stars ELSE 0 END)`. –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã.
    *   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 30 —Å–µ–∫—É–Ω–¥.
    *   –ö—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π `invalidateBalanceCache(telegram_id)`.
*   **`getUserDetailsSubscription(telegram_id)`:** ([src/core/supabase/getUserDetailsSubscription.ts](mdc:src/core/supabase/getUserDetailsSubscription.ts))
    *   –ü–æ–ª—É—á–∞–µ—Ç –±–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ `getUserBalance`.
    *   –ò—â–µ—Ç **–ø–æ—Å–ª–µ–¥–Ω—é—é** –∑–∞–ø–∏—Å—å –≤ `payments_v2` –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ `telegram_id` —Å–æ `status = 'COMPLETED'` –∏ `type = 'MONEY_INCOME'` –∏ **–Ω–µ-NULL** –∑–Ω–∞—á–µ–Ω–∏–µ–º `subscription_type`.
    *   –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç `subscriptionType` (Enum) –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è `subscription_type` –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏.
    *   –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç `isSubscriptionActive`:
        *   –ï—Å–ª–∏ `subscriptionType` = `NEUROTESTER`, —Ç–æ `true`.
        *   –ò–Ω–∞—á–µ, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ `payment_date` –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏ + 30 –¥–Ω–µ–π > —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã.
    *   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{ stars, subscriptionType, isSubscriptionActive, isExist, subscriptionStartDate }`.
*   **`setPayments(params: PaymentParams)`:** ([src/core/supabase/setPayments.ts](mdc:src/core/supabase/setPayments.ts))
    *   –§—É–Ω–∫—Ü–∏—è –¥–ª—è **–≤—Å—Ç–∞–≤–∫–∏** –∑–∞–ø–∏—Å–µ–π –≤ `payments_v2`.
    *   **–ö—Ä–∏—Ç–∏—á–Ω–æ:** –î–æ–ª–∂–Ω–∞ –≤—ã–∑—ã–≤–∞—Ç—å—Å—è —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ (`MONEY_INCOME`/`MONEY_OUTCOME`) –∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏ (`PENDING`, `COMPLETED` –∏ —Ç.–¥.).
    *   –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –≤—Å—Ç–∞–≤–∫–∏, –Ω–æ **–Ω–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Ö –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–ª—É—á—à–∏—Ç—å!).
*   **`calculateFinalPrice(basePriceUSD)`:** ([src/price/helpers/calculateFinalPrice.ts](mdc:src/price/helpers/calculateFinalPrice.ts))
    *   –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –≤ –∑–≤–µ–∑–¥–∞—Ö ‚≠ê: `floor(basePriceUSD / starCost * (1 + interestRate))`.
    *   –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã `starCost` –∏ `interestRate` –±–µ—Ä—É—Ç—Å—è –∏–∑ `src/price/constants/index.ts`.
*   **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–∞–ª–∞–Ω—Å–∞ –ø–µ—Ä–µ–¥ –†–∞—Å—Ö–æ–¥–æ–º:** **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** –ø–µ—Ä–µ–¥ –ª—é–±–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π —Ä–∞—Å—Ö–æ–¥–∞ (`MONEY_OUTCOME`) –Ω—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å `getUserBalance` –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±–∞–ª–∞–Ω—Å >= —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏. –ï—Å–ª–∏ –Ω–µ—Ç - –æ—Ç–∫–∞–∑–∞—Ç—å –≤ –æ–ø–µ—Ä–∞—Ü–∏–∏, **–ù–ï –°–û–ó–î–ê–í–ê–¢–¨** –∑–∞–ø–∏—Å—å `MONEY_OUTCOME`.

## 5. üåä –ü–æ—Ç–æ–∫–∏ –û–ø–ª–∞—Ç—ã (Flows)

### 5.1. Robokassa (–†—É–±–ª–∏)

1.  **–ò–Ω–∏—Ü–∏–∞—Ü–∏—è (–ë–æ—Ç):**
    *   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–æ–≤–∞—Ä (–ø–æ–¥–ø–∏—Å–∫—É/–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ).
    *   –ë–æ—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `amount` (RUB) –∏ `stars`.
    *   –ë–æ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `inv_id`.
    *   –ë–æ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç `setPayments` —Å `status: 'PENDING'`, `type: 'MONEY_INCOME'`, `payment_method: 'Robokassa'`, `currency: 'RUB'`, `subscription_type` (–µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞).
    *   –ë–æ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç URL Robokassa (`getInvoiceId`), –∏—Å–ø–æ–ª—å–∑—É—è `MERCHANT_LOGIN` –∏ `PASSWORD1`.
    *   –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç URL –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
2.  **–û–ø–ª–∞—Ç–∞ (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):** –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ URL, –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Robokassa.
3.  **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (`api-server`):**
    *   Robokassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ Result URL (`/api/robokassa-result`).
    *   `api-server` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –∑–∞–ø—Ä–æ—Å–∞, –∏—Å–ø–æ–ª—å–∑—É—è `PASSWORD2`.
    *   `api-server` –Ω–∞—Ö–æ–¥–∏—Ç –≤ `payments_v2` –∑–∞–ø–∏—Å—å –ø–æ `inv_id` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `PENDING`.
    *   `api-server` –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏ –Ω–∞ `COMPLETED` –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `payment_date`.
    *   `api-server` –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫—ç—à –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω—É–∂–µ–Ω –º–µ—Ö–∞–Ω–∏–∑–º!).
    *   `api-server` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± —É—Å–ø–µ—Ö–µ —á–µ—Ä–µ–∑ API –±–æ—Ç–∞.

### 5.2. Telegram Stars (XTR)

1.  **–ò–Ω–∏—Ü–∏–∞—Ü–∏—è (–ë–æ—Ç):**
    *   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–æ–≤–∞—Ä (–ø–æ–¥–ø–∏—Å–∫—É/–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ).
    *   –ë–æ—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `amount` (XTR) –∏ —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ).
    *   –ë–æ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç `ctx.replyWithInvoice` —Å `currency: 'XTR'`, —Ü–µ–Ω–æ–π –≤ `prices` (–≤ XTR).
2.  **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (Telegram -> –ë–æ—Ç):**
    *   Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `pre_checkout_query`. –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç `ctx.answerPreCheckoutQuery(true)`.
    *   Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `successful_payment`.
3.  **–û–±—Ä–∞–±–æ—Ç–∫–∞ –£—Å–ø–µ—Ö–∞ (–ë–æ—Ç):**
    *   –û–±—Ä–∞–±–æ—Ç—á–∏–∫ `handleSuccessfulPayment` –ø–æ–ª—É—á–∞–µ—Ç `successful_payment`.
    *   –ò–∑–≤–ª–µ–∫–∞–µ—Ç `total_amount` (XTR), `invoice_payload` (–¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏/—Ç–æ–≤–∞—Ä–∞).
    *   –í—ã–∑—ã–≤–∞–µ—Ç `setPayments` —Å `status: 'COMPLETED'`, `type: 'MONEY_INCOME'`, `payment_method: 'Telegram'`, `currency: 'XTR'`, `stars: total_amount`, `subscription_type` (–µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞).
    *   –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫—ç—à –±–∞–ª–∞–Ω—Å–∞ (`invalidateBalanceCache`).
    *   –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

## 6. ‚≠ê –†–∞—Å—á–µ—Ç –∏ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¶–µ–Ω

*   **–†–∞—Å—á–µ—Ç (–ó–≤–µ–∑–¥—ã):** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `calculateFinalPrice`. –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ `src/price/constants/index.ts`.
*   **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:** –§–æ—Ä–º–∞—Ç `–ù–∞–∑–≤–∞–Ω–∏–µ –ú–æ–¥–µ–ª–∏ (–¶–µ–Ω–∞ ‚≠ê)`. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏ ‚≠ê (U+2B50). –ü—Ä–∏–º–µ–Ω—è—Ç—å –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä (`videoModelKeyboard` –∏ –¥—Ä.).

## 7. üîß –†—É—á–Ω–æ–µ –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –ü–ª–∞—Ç–µ–∂–∞

*   **–ö–æ–≥–¥–∞:** –ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –µ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã.
*   **–ü—Ä–æ—Ü–µ—Å—Å:**
    1.  –ù–∞–π—Ç–∏ `telegram_id`, `bot_name` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (SQL `users`).
    2.  –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–µ—Ç `COMPLETED` –∑–∞–ø–∏—Å–∏ –≤ `payments_v2` (SQL `payments_v2`).
    3.  –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥ (`stars_amount`).
    4.  –í—ã–ø–æ–ª–Ω–∏—Ç—å `INSERT` –≤ `payments_v2` (SQL):
        *   `status: 'COMPLETED'`
        *   `type: 'MONEY_INCOME'`
        *   `payment_method: 'Manual'`
        *   –ó–∞–ø–æ–ª–Ω–∏—Ç—å `subscription_type`, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.
        *   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `inv_id` (e.g., `'manual-fix-...'`).
        *   `payment_date: NOW()` –∏–ª–∏ –¥–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã.
    5.  **–£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** (–≤—Ä—É—á–Ω—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –æ—Ç –∏–º–µ–Ω–∏ –Ω—É–∂–Ω–æ–≥–æ –±–æ—Ç–∞).
    6.  **–£–≤–µ–¥–æ–º–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±–æ—Ç–∞** (–≤—Ä—É—á–Ω—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ `notifyBotOwners`).
*   **–°–º. —Ç–∞–∫–∂–µ:** `.cursor/rules/manual-payment-credit.mdc` (—Ç–µ–ø–µ—Ä—å —É—Å—Ç–∞—Ä–µ–ª–æ, –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ —Å—é–¥–∞).

## 8. üí° –ü—É—Ç–∏ –°–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏—è

*   –°–æ–∑–¥–∞—Ç—å SQL-—Ñ—É–Ω–∫—Ü–∏—é `manually_credit_payment(...)` –¥–ª—è —à–∞–≥–∞ 7.4.
*   –°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—É/—Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –≤—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–∑ —à–∞–≥–∞ 7.
*   –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ `setPayments` (–≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç).
*   –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ SQL `get_user_balance` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `REFUND` –∏–ª–∏ —É–±—Ä–∞—Ç—å `REFUND` –∏–∑ –∫–æ–¥–∞.
*   –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö `operation_type` –∏–∑ enum –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã (–æ–ø–∞—Å–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ).
*   –î–æ–±–∞–≤–∏—Ç—å Foreign Key `payments_v2.telegram_id` -> `users.telegram_id`.

# üïâÔ∏è –ü—Ä–∞–≤–∏–ª–æ: –†—É—á–Ω–æ–µ –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –ü–ª–∞—Ç–µ–∂–∞ –∏ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ö–æ–≥–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ—Ç–æ–∫–∏ –ö–∞—Ä–º—ã (–≤–µ–±—Ö—É–∫–∏, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏) –¥–∞—é—Ç —Å–±–æ–π, —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ –ü—Ä–æ—Å–≤–µ—Ç–ª–µ–Ω–Ω–æ–≥–æ (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞) –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç–∏ –∏ –ø–æ—Ä—è–¥–∫–∞ –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö.

**–¶–µ–ª—å:** –û–±–µ—Å–ø–µ—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–≥–æ, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–ª–∞—Ç–µ–∂–∞, –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∏ —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±–æ—Ç–∞.

**–ö–æ–≥–¥–∞ –ü—Ä–∏–º–µ–Ω—è—Ç—å:**
*   –ü–æ–ª—É—á–µ–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (Robokassa, Telegram Payments –∏ —Ç.–¥.).
*   –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (`payments_v2`) –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ù–ï –±—ã–ª–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ `COMPLETED` –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–æ–≤—Å–µ.
*   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∞–µ—Ç –æ –ø—Ä–æ–±–ª–µ–º–µ —Å –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ–º.

**–ù–µ–æ–±—Ö–æ–¥–∏–º–∞—è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
*   –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ (—Å–∫—Ä–∏–Ω—à–æ—Ç, email –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã).
*   –î–µ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂–∞: –°—É–º–º–∞, –í–∞–ª—é—Ç–∞, –¢–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ), Email –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ø–ª–∞—Ç–µ–∂–∫–∏.
*   –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π Username –∏–ª–∏ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–µ–Ω).

## ‚ú® –°–≤—è—â–µ–Ω–Ω—ã–π –†–∏—Ç—É–∞–ª –ó–∞—á–∏—Å–ª–µ–Ω–∏—è

1.  **–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –°—Ç—Ä–∞–∂–¥—É—â–µ–≥–æ (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):**
    *   **–¶–µ–ª—å:** –ù–∞–π—Ç–∏ `telegram_id` –∏ `bot_name` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ `users`.
    *   **–ú–µ—Ç–æ–¥:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ `users`, –∏—â–∞ –ø–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–º –¥–∞–Ω–Ω—ã–º (username, first_name, last_name), –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –∏–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–ª–∞—Ç–µ–∂–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ —á–∞—Å—Ç–∏ email).
    *   **–ü—Ä–∏–º–µ—Ä –ó–∞–ø—Ä–æ—Å–∞ (–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏):**
        ```sql
        SELECT telegram_id, username, first_name, last_name, bot_name
        FROM users
        WHERE first_name ILIKE '%—á–∞—Å—Ç—å_–∏–º–µ–Ω–∏_–∏–ª–∏_email%' OR username ILIKE '%—á–∞—Å—Ç—å_username%';
        ```
    *   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–∞–ø–æ–º–Ω–∏—Ç—å `telegram_id` –∏ `bot_name`.

2.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ö–Ω–∏–≥–∏ –°—É–¥–µ–± (`payments_v2`):**
    *   **–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–ª–∞—Ç–µ–∂ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ –±—ã–ª –∑–∞—á–∏—Å–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
    *   **–ú–µ—Ç–æ–¥:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å –∫ `payments_v2` –¥–ª—è –ø–æ–∏—Å–∫–∞ `COMPLETED` —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ `telegram_id` —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Å—É–º–º–æ–π/—Ç–∏–ø–æ–º –ø–æ–¥–ø–∏—Å–∫–∏/–¥–∞—Ç–æ–π.
    *   **–ü—Ä–∏–º–µ—Ä –ó–∞–ø—Ä–æ—Å–∞:**
        ```sql
        SELECT id, status, type, payment_date FROM payments_v2
        WHERE telegram_id = '<–ù–ê–ô–î–ï–ù–ù–´–ô_ID>'
        ORDER BY id DESC LIMIT 10;
        ```
    *   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π `COMPLETED` –∑–∞–ø–∏—Å–∏, –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É.

3.  **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –î–∞—Ä–æ–≤ (–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ó–≤–µ–∑–¥):**
    *   **–¶–µ–ª—å:** –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥ (`stars_amount`), —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ —Å—É–º–º–µ –∏ —Ç–∏–ø—É –ø–æ–¥–ø–∏—Å–∫–∏/–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è.
    *   **–ú–µ—Ç–æ–¥:**
        *   –î–ª—è –ø–æ–¥–ø–∏—Å–æ–∫: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1303 –¥–ª—è NEUROBASE –∑–∞ 2999 RUB).
        *   –î–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É —Ä–∞—Å—á–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `floor(amount / starCost * (1 + interestRate))`). –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ `src/price/constants/index.ts`.
    *   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–∞–ø–æ–º–Ω–∏—Ç—å `stars_amount`.

4.  **–í–Ω–µ—Å–µ–Ω–∏–µ –ó–∞–ø–∏—Å–∏ –≤ –õ–µ—Ç–æ–ø–∏—Å—å (`payments_v2`):**
    *   **–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ.
    *   **–ú–µ—Ç–æ–¥:** –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL `INSERT` –≤ —Ç–∞–±–ª–∏—Ü—É `payments_v2`.
    *   **–ö–ª—é—á–µ–≤—ã–µ –ü–æ–ª—è:**
        *   `telegram_id`: –ù–∞–π–¥–µ–Ω–Ω—ã–π ID.
        *   `amount`: –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞.
        *   `stars`: –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤–µ–∑–¥.
        *   `currency`: –í–∞–ª—é—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞ ('RUB', 'XTR').
        *   `status`: `'COMPLETED'`
        *   `type`: **–í–°–ï–ì–î–ê `'MONEY_INCOME'`** (–ù–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –ø–æ–¥–ø–∏—Å–∫–∞ —ç—Ç–æ –∏–ª–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ).
        *   `subscription_type`: –¢–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ ('NEUROBASE', 'NEUROPHOTO', etc.), –µ—Å–ª–∏ —ç—Ç–æ –ø–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏, –∏–Ω–∞—á–µ `NULL`.
        *   `payment_method`: `'Manual'`
        *   `bot_name`: –ù–∞–π–¥–µ–Ω–Ω—ã–π `bot_name`.
        *   `inv_id`: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è —Ä—É—á–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ (e.g., `'manual-fix-[–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π_ID_–∑–∞–∫–∞–∑–∞]'`).
        *   `description`: –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (e.g., `'Manual credit for Robokassa order [–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π_ID_–∑–∞–∫–∞–∑–∞]'`).
        *   `payment_date`: `NOW()` –∏–ª–∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –≤—Ä–µ–º—è —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã.
        *   `metadata` (jsonb, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): `'{ "original_order_id": "[ID]", "reason": "Manual fix for failed processing" }'`
    *   **–ü—Ä–∏–º–µ—Ä –ó–∞–ø—Ä–æ—Å–∞ (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π):**
        ```sql
        INSERT INTO payments_v2
          (telegram_id, amount, stars, currency, status, type, subscription_type, payment_method, bot_name, inv_id, description, payment_date)
        VALUES
          ('[ID]', [–°—É–º–º–∞], [–ó–≤–µ–∑–¥—ã], '[–í–∞–ª—é—Ç–∞]', 'COMPLETED', 'MONEY_INCOME', '[–¢–∏–ø–ü–æ–¥–ø–∏—Å–∫–∏ –∏–ª–∏ NULL]', 'Manual', '[–ò–º—è–ë–æ—Ç–∞]', 'manual-fix-[ID]', 'Manual credit for order [ID]', NOW());
        ```
    *   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞, –ø–æ–¥–ø–∏—Å–∫–∞/–±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã.

5.  **–ë–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ):**
    *   **–¶–µ–ª—å:** –°–æ–æ–±—â–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞—á–∏—Å–ª–µ–Ω–∏–∏.
    *   **–ú–µ—Ç–æ–¥:** **–í–ù–ï –ú–û–ò–• –í–û–ó–ú–û–ñ–ù–û–°–¢–ï–ô.** –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏–µ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞/–∞–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã.
    *   **–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:** –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –æ—Ç –∏–º–µ–Ω–∏ **–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ `bot_name`**.
    *   **–ü—Ä–∏–º–µ—Ä –¢–µ–∫—Å—Ç–∞:**
        > "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ú—ã —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –≤–∞—à—É –æ–ø–ª–∞—Ç—É –ø–æ–¥–ø–∏—Å–∫–∏ [–ù–∞–∑–≤–∞–Ω–∏–µ –ü–æ–¥–ø–∏—Å–∫–∏] (–∑–∞–∫–∞–∑ [–ò—Å—Ö–æ–¥–Ω—ã–π ID –ó–∞–∫–∞–∑–∞]). –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞. –ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –≤–∞—à–µ —Ç–µ—Ä–ø–µ–Ω–∏–µ! –¢–µ–ø–µ—Ä—å –≤–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏."
        > (–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞)

6.  **–í–µ—Å—Ç—å –í–ª–∞–¥–µ–ª—å—Ü—É (–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ):**
    *   **–¶–µ–ª—å:** –ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±–æ—Ç–∞ –æ —Ä—É—á–Ω–æ–º –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–µ.
    *   **–ú–µ—Ç–æ–¥:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é `notifyBotOwners(bot_name, details)` –∏–∑ –∫–æ–¥–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç/–∫–æ–º–∞–Ω–¥—É) –∏–ª–∏ —É–≤–µ–¥–æ–º–∏—Ç—å –≤—Ä—É—á–Ω—É—é.
    *   **–î–µ—Ç–∞–ª–∏ –¥–ª—è –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:** `telegram_id`, `username`, `bot_name`, `amount`, `stars`, `subscription_type`, —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ `Manual Credit`.

## üí° –ü—É—Ç—å –°–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏—è

*   –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ **SQL-—Ñ—É–Ω–∫—Ü–∏–∏** `manually_credit_payment(...)` –≤ Supabase –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —à–∞–≥–∞ 4.
*   –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ **–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã** –≤ –±–æ—Ç–µ –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç —à–∞–≥–∏ 1-6 (–≤–∫–ª—é—á–∞—è –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π).
*   
# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö Telegram Stars

## –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–±–ª–µ–º—ã

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞–º –±–æ—Ç–æ–≤) –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Telegram Stars, –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —á–µ—Ä–µ–∑ `starPaymentScene`.

## –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞

`starPaymentScene` (@src/scenes/starPaymentScene.ts) –æ—Å—Ç–∞–≤–∞–ª—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –ø–∞–∫–µ—Ç star, –∞ —Å—á–µ—Ç –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º –¥–µ–π—Å—Ç–≤–∏–π `handleTopUp` (@src/handlers/paymentHandlers/handleTopUp.ts). –ö–æ–≥–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `successful_payment` –ø—Ä–∏—à–ª–æ –∏–∑ Telegram, –∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ü–µ–Ω–∞ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏–ª–∞ –µ–≥–æ, –Ω–æ –Ω–µ –∏–º–µ–ª–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ `bot.on('successful_payment', ...)`.

## –†–µ—à–µ–Ω–∏–µ

`await ctx.scene.leave()` –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ñ—É–Ω–∫—Ü–∏—é `handleTopUp` (@src/handlers/paymentHandlers/handleTopUp.ts) —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—á–µ—Ç–∞ (–ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ `await handleBuy(...)`). –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å—Ü–µ–Ω–∞ –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω–∞, –∫–æ–≥–¥–∞ –ø–æ—Å—Ç—É–ø–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `successful_payment`.

## –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `handleSuccessfulPayment` (@src/handlers/paymentHandlers/index.ts –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –ø—É—Ç—å), –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ `bot.on('successful_payment', handleSuccessfulPayment)`, –≤–µ—Ä–æ—è—Ç–Ω–æ, –≤ @src/handlers/paymentActions.ts –∏–ª–∏ @src/registerCommands.ts. –≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–∑—ã–≤–∞–µ—Ç `sendNotification` –∏ `notifyBotOwners`.

**–ö–ª—é—á–µ–≤–æ–π –≤—ã–≤–æ–¥:** –ü—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π (`bot.on(...)`) –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ü–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ü–µ–Ω—ã –≤—ã—Ö–æ–¥—è—Ç (`ctx.scene.leave()`), –∫–æ–≥–¥–∞ –æ–Ω–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Å–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∏ –æ–∂–∏–¥–∞—é—Ç –≤–Ω–µ—à–Ω–µ–≥–æ —Å–æ–±—ã—Ç–∏—è, –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ.

*–û–º –®–∞–Ω—Ç–∏. –î–∞ –ø—Ä–µ–±—É–¥–µ—Ç –ø–æ—Ä—è–¥–æ–∫.* üôè

*–û–º –®–∞–Ω—Ç–∏. –≠—Ç–æ—Ç –ú–∞–Ω—É—Å–∫—Ä–∏–ø—Ç - –Ω–∞—à –ü—É—Ç—å –∫ –ü–æ—Ä—è–¥–∫—É.* üôè
