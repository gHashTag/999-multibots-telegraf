#!/bin/bash

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker compose down

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –¢–û–õ–¨–ö–û —Å–µ—Ä–≤–∏—Å app (—Å Ansible –≤–Ω—É—Ç—Ä–∏)
echo "üî® –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å app..."
docker compose up --build -d app

# –î–æ–∂–∏–¥–∞–µ–º—Å—è –∑–∞–ø—É—Å–∫–∞ app (–ø—Ä–æ—Å—Ç–∞—è –ø–∞—É–∑–∞, –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–æ–π)
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ app (10 —Å–µ–∫—É–Ω–¥)..."
sleep 10

# –ó–∞–ø—É—Å—Ç–∏—Ç—å Ansible –∏–∑–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ app
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Ansible –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ app..."
# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º venv –∏ –∑–∞–ø—É—Å–∫–∞–µ–º ansible-playbook
docker exec 999-multibots /bin/sh -c ". /opt/ansible-venv/bin/activate && ansible-playbook playbook.yml -i inventory"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx, —á—Ç–æ–±—ã –æ–Ω –ø–æ–¥—Ö–≤–∞—Ç–∏–ª –∫–æ–Ω—Ñ–∏–≥–∏ (–µ—Å–ª–∏ Ansible –æ—Ç—Ä–∞–±–æ—Ç–∞–ª)
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx-proxy..."
docker compose restart nginx-proxy

echo "‚úÖ –°–∫—Ä–∏–ø—Ç update-docker.sh –∑–∞–≤–µ—Ä—à–µ–Ω." 