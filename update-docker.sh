#!/bin/bash

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker compose down

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –í–°–ï —Å–µ—Ä–≤–∏—Å—ã
echo "üî® –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã..."
docker compose up --build -d

# –î–æ–∂–∏–¥–∞–µ–º—Å—è –∑–∞–ø—É—Å–∫–∞ (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–æ–π)
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (15 —Å–µ–∫—É–Ω–¥)..."
sleep 15

# –ó–∞–ø—É—Å—Ç–∏—Ç—å Ansible –∏–∑–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ app
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Ansible –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ app –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ö–æ—Å—Ç–∞..."
# –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∫–ª—é—á–∞ —Ö–æ—Å—Ç–∞ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º ansible-playbook
docker exec 999-multibots /bin/sh -c "export ANSIBLE_HOST_KEY_CHECKING=False; . /opt/ansible-venv/bin/activate && ansible-playbook playbook.yml -i inventory"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx, —á—Ç–æ–±—ã –æ–Ω –ø–æ–¥—Ö–≤–∞—Ç–∏–ª –∫–æ–Ω—Ñ–∏–≥–∏ (–µ—Å–ª–∏ Ansible –æ—Ç—Ä–∞–±–æ—Ç–∞–ª)
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx-proxy..."
docker compose restart nginx-proxy

echo "‚úÖ –°–∫—Ä–∏–ø—Ç update-docker.sh –∑–∞–≤–µ—Ä—à–µ–Ω." 