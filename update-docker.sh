#!/bin/bash

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker compose down

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –í–°–ï —Å–µ—Ä–≤–∏—Å—ã
echo "üî® –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã..."
docker compose up --build -d

# –î–æ–∂–∏–¥–∞–µ–º—Å—è –∑–∞–ø—É—Å–∫–∞ (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–æ–π)
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (15 —Å–µ–∫—É–Ω–¥)..."
sleep 15

# –ó–∞–ø—É—Å—Ç–∏—Ç—å Ansible Ping –∏–∑–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ app
echo "üöÄ –ü—Ä–æ–≤–µ—Ä—è–µ–º Ansible Ping –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ app..."
# –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∫–ª—é—á–∞ —Ö–æ—Å—Ç–∞ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º ping
docker exec 999-multibots /bin/sh -c "export ANSIBLE_HOST_KEY_CHECKING=False; . /opt/ansible-venv/bin/activate && ansible elestio_server -i inventory -m ping"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx...
# echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx-proxy..."
# docker compose up -d --force-recreate nginx-proxy

echo "‚úÖ –°–∫—Ä–∏–ø—Ç update-docker.sh (—Ç–µ—Å—Ç ping) –∑–∞–≤–µ—Ä—à–µ–Ω." 