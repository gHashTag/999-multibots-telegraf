#!/bin/bash

# üéØ Task Master - –ì–ª–∞–≤–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –∑–∞–¥–∞—á

# –¶–≤–µ—Ç–∞ –¥–ª—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# –ü—É—Ç–∏
SCRIPTS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPTS_DIR/../../.." && pwd)"
TASK_GUARDIAN="$SCRIPTS_DIR/task-guardian.sh"
CURRENT_TASK_FILE="$PROJECT_ROOT/src/core/mcp/agent/memory-bank/NeuroBlogger/tasks/current_task.md"
MAIN_FILE="$PROJECT_ROOT/src/core/mcp/agent/memory-bank/NeuroBlogger/MAIN.md"

# –§—É–Ω–∫—Ü–∏—è —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
print_emotional() {
    local message=$1
    local emotion=$2
    case $emotion in
        "happy") echo -e "${GREEN}üòä $message${NC}" ;;
        "excited") echo -e "${YELLOW}üöÄ $message${NC}" ;;
        "neutral") echo -e "${BLUE}‚ÑπÔ∏è $message${NC}" ;;
        "concerned") echo -e "${PURPLE}ü§î $message${NC}" ;;
        "error") echo -e "${RED}‚ùå $message${NC}" ;;
        "love") echo -e "${PURPLE}üíù $message${NC}" ;;
        *) echo -e "${CYAN}$message${NC}" ;;
    esac
}

# –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –∑–∞–¥–∞—á–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞
decompose_task() {
    local input_text=$1
    local title
    local description
    local components
    local acceptance_criteria
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—É—Ç—å –∑–∞–¥–∞—á–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–ø–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)
    title=$(echo "$input_text" | sed 's/\([.!?]\) .*/\1/' | sed 's/^[[:space:]]*//')
    
    # –û—Å—Ç–∞–ª—å–Ω–æ–π —Ç–µ–∫—Å—Ç –∏–¥–µ—Ç –≤ –æ–ø–∏—Å–∞–Ω–∏–µ
    description=$(echo "$input_text" | sed "s/$title//" | sed 's/^[[:space:]]*//')
    
    # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑–∞–¥–∞—á–∏
    cat > "$CURRENT_TASK_FILE" << EOF
# üìã –ó–∞–¥–∞—á–∞: $title

## üìä –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- –°—Ç–∞—Ç—É—Å: –í —Ä–∞–±–æ—Ç–µ
- –°–æ–∑–¥–∞–Ω–∞: $(date +"%Y-%m-%d %H:%M:%S")
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í—ã—Å–æ–∫–∏–π
- –¢–∏–ø: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è

## üìù –û–ø–∏—Å–∞–Ω–∏–µ
$description

## üéØ –¶–µ–ª–∏
- [ ] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞
- [ ] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏

## üìà –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è
1. –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
   - [ ] –ò–∑—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
   - [ ] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
   - [ ] –í—ã—è–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

2. –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
   - [ ] –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
   - [ ] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã
   - [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏

3. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è
   - [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
   - [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
   - [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

## üîÑ –¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
- –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã: $(date +"%Y-%m-%d %H:%M:%S")
- –°—Ç–∞—Ç—É—Å: –ê–∫—Ç–∏–≤–Ω–∞—è

## üìé –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- MAIN.md
- ROADMAP.md
- task-guardian.sh

## üóíÔ∏è –ó–∞–º–µ—Ç–∫–∏
- –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Ä–∞–¥—É–∂–Ω—ã–π –º–æ—Å—Ç
- –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç: "$input_text"

EOF
    
    print_emotional "–ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞–Ω–∞: $title" "excited"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á—Ç–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏
read_current_task() {
    if [ -f "$CURRENT_TASK_FILE" ]; then
        print_emotional "üìñ –¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞:" "neutral"
        cat "$CURRENT_TASK_FILE"
    else
        print_emotional "–¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" "concerned"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
update_task_progress() {
    if [ -f "$CURRENT_TASK_FILE" ]; then
        local progress=$1
        echo -e "\n- [$(date +"%Y-%m-%d %H:%M:%S")] $progress" >> "$CURRENT_TASK_FILE"
        print_emotional "–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω" "happy"
    else
        print_emotional "–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" "error"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ä–∞–¥—É–∂–Ω—ã–º –º–æ—Å—Ç–æ–º
rainbow_bridge_integration() {
    print_emotional "üåà –ê–∫—Ç–∏–≤–∏—Ä—É—é —Ä–∞–¥—É–∂–Ω—ã–π –º–æ—Å—Ç..." "love"
    if [ -f "$MAIN_FILE" ]; then
        print_emotional "üíù –°–æ–µ–¥–∏–Ω—è—é—Å—å —Å —Ü–∏—Ñ—Ä–æ–≤—ã–º –∞–≤–∞—Ç–∞—Ä–æ–º..." "love"
        # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å rainbow-bridge.sh
        print_emotional "‚ú® –†–∞–¥—É–∂–Ω—ã–π –º–æ—Å—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!" "happy"
    else
        print_emotional "MAIN.md –Ω–µ –Ω–∞–π–¥–µ–Ω" "error"
    fi
}

# –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
show_menu() {
    echo -e "${CYAN}üéØ Task Master - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏${NC}"
    echo -e "${BLUE}1. –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –∏–∑ —Ç–µ–∫—Å—Ç–∞"
    echo -e "2. –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É"
    echo -e "3. –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–¥–∞—á–∏"
    echo -e "4. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–¥—É–∂–Ω—ã–π –º–æ—Å—Ç"
    echo -e "0. –í—ã—Ö–æ–¥${NC}"
}

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
while true; do
    show_menu
    read -p "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: " choice
    
    case $choice in
        1)
            print_emotional "–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏:" "love"
            read -p "> " task_text
            decompose_task "$task_text"
            ;;
        2)
            read_current_task
            ;;
        3)
            read -p "–í–≤–µ–¥–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: " progress
            update_task_progress "$progress"
            ;;
        4)
            rainbow_bridge_integration
            ;;
        0)
            print_emotional "–î–æ —Å–≤–∏–¥–∞–Ω–∏—è! üëã" "happy"
            exit 0
            ;;
        *)
            print_emotional "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä" "error"
            ;;
    esac
    
    echo
    read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
done