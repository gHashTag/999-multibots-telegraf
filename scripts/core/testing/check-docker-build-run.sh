#!/bin/bash

# Ð¡Ñ‚Ñ€Ð¾ÐºÐ° Ð¾ÑˆÐ¸Ð±ÐºÐ¸, ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ð¸Ñ‰ÐµÐ¼
ERROR_STRING="mkdir /root: read-only file system"
SCRIPT_NAME=$(basename "$0")
LOG_PREFIX="[${SCRIPT_NAME}]"

echo "$LOG_PREFIX ðŸ§˜â€â™‚ï¸ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ° Docker..."

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ¾Ð¼
log() {
    echo "$LOG_PREFIX $1"
}

# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
output=""
exit_code=0

# Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð¿ÐµÑ€ÐµÑÐ¾Ð±Ñ€Ð°Ñ‚ÑŒ ai-server Ð±ÐµÐ· ÐºÑÑˆÐ°
log "ðŸ› ï¸ Ð¨Ð°Ð³ 1: ÐŸÐµÑ€ÐµÑÐ±Ð¾Ñ€ÐºÐ° 'ai-server' Ð±ÐµÐ· ÐºÑÑˆÐ° (docker-compose build --no-cache ai-server)..."
output=$(docker-compose build --no-cache ai-server 2>&1) || exit_code=$? # Ð—Ð°Ñ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ stdout Ð¸ stderr

if [ $exit_code -ne 0 ]; then
    log "âš ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»Ð°ÑÑŒ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹ (ÐºÐ¾Ð´: $exit_code)."
fi

log "ðŸ“œ Ð’Ñ‹Ð²Ð¾Ð´ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸:"
echo "$output" # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ñ‹Ð²Ð¾Ð´ Ð´Ð»Ñ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ¸

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¸ÑÐºÐ¾Ð¼ÑƒÑŽ Ð¾ÑˆÐ¸Ð±ÐºÑƒ Ð² Ð²Ñ‹Ð²Ð¾Ð´Ðµ ÑÐ±Ð¾Ñ€ÐºÐ¸
if echo "$output" | grep -q -F "$ERROR_STRING"; then
    log "âŒ ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸: '$ERROR_STRING'"
    log "ðŸš« ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¾Ð²Ð°Ð»ÐµÐ½Ð° Ð½Ð° ÑÑ‚Ð°Ð¿Ðµ ÑÐ±Ð¾Ñ€ÐºÐ¸."
    exit 1
fi

# Ð¨Ð°Ð³ 2: ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ (ÐµÑÐ»Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ° Ð±Ñ‹Ð»Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ð¸Ð»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°)
log "ðŸš€ Ð¨Ð°Ð³ 2: Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² (docker-compose up --build -d)..."
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ --build, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð¹Ð¼Ð°Ñ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ Ð¿Ð¾ÑÐ»Ðµ ÑÐ²ÐµÐ¶ÐµÐ¹ ÑÐ±Ð¾Ñ€ÐºÐ¸
# Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, ÑÑ‚Ð¾Ð¸Ñ‚ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ --force-recreate Ð´Ð»Ñ Ñ‡Ð¸ÑÑ‚Ð¾Ñ‚Ñ‹ ÑÐºÑÐ¿ÐµÑ€Ð¸Ð¼ÐµÐ½Ñ‚Ð°
output=$(docker-compose up --build -d 2>&1) || exit_code=$? # Ð—Ð°Ñ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ stdout Ð¸ stderr

if [ $exit_code -ne 0 ]; then
    log "âš ï¸ Ð—Ð°Ð¿ÑƒÑÐº Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»ÑÑ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹ (ÐºÐ¾Ð´: $exit_code)."
fi

log "ðŸ“œ Ð’Ñ‹Ð²Ð¾Ð´ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð·Ð°Ð¿ÑƒÑÐºÐ°:"
echo "$output" # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ñ‹Ð²Ð¾Ð´ Ð´Ð»Ñ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ¸

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¸ÑÐºÐ¾Ð¼ÑƒÑŽ Ð¾ÑˆÐ¸Ð±ÐºÑƒ Ð² Ð²Ñ‹Ð²Ð¾Ð´Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°
if echo "$output" | grep -q -F "$ERROR_STRING"; then
    log "âŒ ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°: '$ERROR_STRING'"
    log "ðŸš« ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¾Ð²Ð°Ð»ÐµÐ½Ð° Ð½Ð° ÑÑ‚Ð°Ð¿Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°."
    # ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾: Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð´Ð»Ñ Ñ‡Ð¸ÑÑ‚Ð¾Ñ‚Ñ‹
    log "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² (docker-compose down)..."
    docker-compose down > /dev/null 2>&1 || true
    exit 1
fi

log "âœ… ÐžÑˆÐ¸Ð±ÐºÐ° '$ERROR_STRING' Ð½Ðµ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð° Ð½Ð¸ Ð½Ð° ÑÑ‚Ð°Ð¿Ðµ ÑÐ±Ð¾Ñ€ÐºÐ¸, Ð½Ð¸ Ð½Ð° ÑÑ‚Ð°Ð¿Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°."
log "ðŸ•‰ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°."

# ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾: Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¸Ð»Ð¸ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
log "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² Ð´Ð»Ñ Ñ‡Ð¸ÑÑ‚Ð¾Ñ‚Ñ‹ (docker-compose down)..."
    docker-compose down > /dev/null 2>&1 || true

exit 0 