#!/bin/sh

# –°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º
set -e

# –í–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# set -x

# --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
LOG_DIR="/app/logs"
ENV_FILE="/app/.env"
APP_NAME="neuroblogger" # –ò–º—è –¥–ª—è PM2

# --- –§—É–Ω–∫—Ü–∏–∏ ---
log_message() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# --- –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç ---
log_message "üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Entrypoint..."
log_message "üîç –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–º–∞–Ω–¥
log_message "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–º–∞–Ω–¥ (node, bun, pm2)..."
command -v node >/dev/null 2>&1 || { log_message "‚ùå –û—à–∏–±–∫–∞: node –Ω–µ –Ω–∞–π–¥–µ–Ω."; exit 1; }
# bun –ø–æ–∫–∞ –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω, pm2 –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ npm install, –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ –ø–æ–∑–∂–µ
log_message "‚úÖ –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–º–∞–Ω–¥—ã –Ω–∞–π–¥–µ–Ω—ã."


# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
log_message "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π (logs)..."
mkdir -p "$LOG_DIR"
log_message "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã/–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è package.json –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ -f "/app/package.json" ]; then
  if [ ! -d "/app/node_modules" ]; then
    log_message "üì¶ –§–∞–π–ª package.json –Ω–∞–π–¥–µ–Ω, –Ω–æ –Ω–µ—Ç node_modules. –ó–∞–ø—É—Å–∫ npm install..."
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º npm ci –¥–ª—è –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    if [ -f "/app/package-lock.json" ]; then
      npm ci --legacy-peer-deps
    else
      npm install --legacy-peer-deps
    fi
    log_message "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."
  else
    log_message "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è node_modules —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
  fi
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è pm2 –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
  log_message "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –º–æ–¥—É–ª–µ–π (pm2)..."
  if ! npm list pm2 >/dev/null 2>&1; then
      log_message "‚ùå –û—à–∏–±–∫–∞: pm2 –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ npm install. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏."
      # –ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ –∫–∞–∫ fallback? –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥? –ü–æ–∫–∞ –≤—ã—Ö–æ–¥.
      exit 1
  fi
   log_message "‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –º–æ–¥—É–ª–∏ –Ω–∞–π–¥–µ–Ω—ã."

else
  log_message "‚ö†Ô∏è –§–∞–π–ª package.json –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π."
fi

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
# –ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ PM2
log_message "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è '$APP_NAME' —á–µ—Ä–µ–∑ PM2..."
# –ó–∞–ø—É—Å–∫–∞–µ–º –≤ —Ä–µ–∂–∏–º–µ no-daemon, —á—Ç–æ–±—ã –ª–æ–≥–∏ —à–ª–∏ –≤ stdout/stderr –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
# –∏ Docker –º–æ–≥ –∏—Ö —Å–æ–±–∏—Ä–∞—Ç—å. PM2 –±—É–¥–µ—Ç PID 1 –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.
# –ò—Å–ø–æ–ª—å–∑—É–µ–º exec –¥–ª—è –∑–∞–º–µ–Ω—ã —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–∞ pm2
exec pm2-runtime start dist/bot.js --name "$APP_NAME" --no-autorestart

# –ï—Å–ª–∏ pm2-runtime –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è, —Å–∫—Ä–∏–ø—Ç —Ç–æ–∂–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.
# –≠—Ç–æ—Ç –∫–æ–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ pm2-runtime
log_message "üèÅ Entrypoint –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É (—ç—Ç–æ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ, –µ—Å–ª–∏ PM2 –¥–æ–ª–∂–µ–Ω –±—ã–ª –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è)." 