#!/bin/bash
set -e

echo "üîß –ù–∞—á–∏–Ω–∞—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–±–æ—Ä–∫–∏..."

# –û—á–∏—â–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é dist
echo "üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ dist..."
rm -rf dist

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω—É—é —Å–±–æ—Ä–∫—É —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∞–ª–∏–∞—Å–æ–≤
echo "üõ†Ô∏è –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π —Å–±–æ—Ä–∫–∏..."
npm run build

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ bot.js
if [ ! -f "dist/bot.js" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª dist/bot.js –Ω–µ —Å–æ–∑–¥–∞–Ω!"
  exit 1
fi

echo "‚úÖ –§–∞–π–ª dist/bot.js —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ bot.js –Ω–µ—Ç –∞–ª–∏–∞—Å–æ–≤ @/
if grep -q "@/utils/launch" dist/bot.js; then
  echo "‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –í —Ñ–∞–π–ª–µ dist/bot.js –≤—Å–µ –µ—â–µ –µ—Å—Ç—å –∞–ª–∏–∞—Å—ã @/!"
  echo "üîç –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∞–ª–∏–∞—Å—ã –≤—Ä—É—á–Ω—É—é..."
  
  # –ó–∞–º–µ–Ω—è–µ–º –∞–ª–∏–∞—Å—ã –Ω–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏
  sed -i '' 's|@/utils/launch|./utils/launch|g' dist/bot.js
  
  echo "‚úÖ –ê–ª–∏–∞—Å—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!"
fi

echo "üì¶ –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
tar -czf dist.tar.gz dist

echo "üöÄ –í—ã–≥—Ä—É–∂–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
scp -i ~/.ssh/id_rsa dist.tar.gz root@999-multibots-u14194.vm.elestio.app:/tmp/

echo "üìã –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh -i ~/.ssh/id_rsa root@999-multibots-u14194.vm.elestio.app "
cd /app && 
rm -rf dist &&
tar -xzf /tmp/dist.tar.gz -C . &&
ls -la dist &&
echo '‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞...' &&
docker-compose down &&
docker-compose up -d
"

echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω!" 